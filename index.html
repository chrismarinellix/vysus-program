<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Program View - Vysus Group</title>
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Communications Tab -->
    <script src="comms.js" defer></script>
    <style>
        :root {
            /* Vysus Brand Colors */
            --vysus-stockholm-neon: #00E3A9;
            --vysus-malmo-green: #005454;
            --vysus-scandinavia-rock: #485559;
            --vysus-trondheim-night: #1D1D1B;

            /* Theme Colors */
            --bg-primary: #0a1a1a;
            --bg-secondary: #0f2a2a;
            --bg-card: #153535;
            --bg-input: #0f2a2a;
            --accent: #00E3A9;
            --accent-dim: rgba(0, 227, 169, 0.15);
            --text-primary: #e8eef4;
            --text-secondary: #8899a6;
            --text-muted: #657786;
            --border: #1a4040;
            --warning: #f5a623;
            --danger: #e0245e;
            --success: #00E3A9;
            --radar-pulse: #00E3A9;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 24px 32px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .header h1 {
            font-size: 28px;
            font-weight: 600;
            color: var(--accent);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .week-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-secondary);
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .week-selector input {
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 14px;
        }

        .btn {
            padding: 8px 20px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .btn-primary {
            background: var(--accent);
            color: var(--bg-primary);
        }

        .btn-primary:hover { opacity: 0.85; }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover { background: var(--bg-card); }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
            animation: pulse 2s infinite;
        }

        .status-dot.offline {
            background: var(--danger);
            animation: none;
        }

        .btn-start-daemon {
            padding: 4px 12px;
            font-size: 11px;
            background: var(--warning);
            color: var(--bg-primary);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }

        .btn-start-daemon:hover {
            opacity: 0.85;
        }

        .connection-banner {
            background: linear-gradient(135deg, #2d1810 0%, #1a2332 100%);
            border: 1px solid var(--warning);
            border-radius: 12px;
            padding: 20px 24px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .connection-banner.hidden {
            display: none;
        }

        .connection-banner-icon {
            width: 48px;
            height: 48px;
            background: var(--warning);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .connection-banner-icon svg {
            width: 24px;
            height: 24px;
            color: var(--bg-primary);
        }

        .connection-banner-content {
            flex: 1;
        }

        .connection-banner-content h3 {
            color: var(--warning);
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .connection-banner-content p {
            color: var(--text-secondary);
            font-size: 13px;
            margin: 0;
        }

        .connection-banner-content code {
            background: var(--bg-input);
            padding: 2px 8px;
            border-radius: 4px;
            font-family: 'Consolas', monospace;
            font-size: 12px;
            color: var(--accent);
        }

        .connection-banner .btn {
            flex-shrink: 0;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Industry Map Flow Animations */
        @keyframes flow-right {
            0% { transform: translateX(-100%); opacity: 0; }
            20% { opacity: 1; }
            80% { opacity: 1; }
            100% { transform: translateX(100%); opacity: 0; }
        }

        @keyframes flow-down {
            0% { transform: translateY(-100%); opacity: 0; }
            20% { opacity: 1; }
            80% { opacity: 1; }
            100% { transform: translateY(100%); opacity: 0; }
        }

        @keyframes money-flow {
            0% { background-position: 0% 50%; }
            100% { background-position: 200% 50%; }
        }

        @keyframes data-pulse {
            0%, 100% { box-shadow: 0 0 5px currentColor; }
            50% { box-shadow: 0 0 20px currentColor, 0 0 30px currentColor; }
        }

        .flow-arrow {
            position: relative;
            overflow: hidden;
        }

        .flow-arrow::after {
            content: '→';
            position: absolute;
            animation: flow-right 2s ease-in-out infinite;
            font-weight: bold;
        }

        .flow-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 9px;
            font-weight: 600;
            animation: data-pulse 2s ease-in-out infinite;
        }

        .flow-money {
            background: linear-gradient(90deg, #BB8FCE, #9b59b6, #BB8FCE);
            background-size: 200% 100%;
            animation: money-flow 2s linear infinite;
            color: white;
        }

        .flow-data {
            background: linear-gradient(90deg, #45b7d1, #3498db, #45b7d1);
            background-size: 200% 100%;
            animation: money-flow 2.5s linear infinite;
            color: white;
        }

        .flow-contract {
            background: linear-gradient(90deg, #f5a623, #e67e22, #f5a623);
            background-size: 200% 100%;
            animation: money-flow 3s linear infinite;
            color: white;
        }

        .flow-approval {
            background: linear-gradient(90deg, #e0245e, #c0392b, #e0245e);
            background-size: 200% 100%;
            animation: money-flow 2s linear infinite;
            color: white;
        }

        .flow-support {
            background: linear-gradient(90deg, #00d4aa, #1abc9c, #00d4aa);
            background-size: 200% 100%;
            animation: money-flow 2.5s linear infinite;
            color: white;
        }

        .map-contact {
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 4px;
            transition: all 0.2s;
            position: relative;
        }

        .map-contact:hover {
            background: rgba(255,255,255,0.1);
        }

        .map-contact-tooltip {
            display: none;
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-primary);
            border: 1px solid var(--accent);
            border-radius: 8px;
            padding: 10px 14px;
            white-space: nowrap;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            font-size: 11px;
            margin-bottom: 8px;
        }

        .map-contact-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: var(--accent);
        }

        .map-contact:hover .map-contact-tooltip {
            display: block;
        }

        .competitor-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 9px;
            font-weight: 600;
            background: rgba(224, 36, 94, 0.2);
            color: #e0245e;
            border: 1px solid rgba(224, 36, 94, 0.3);
        }

        /* Learning Center Styles */
        .learning-panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            margin-top: 20px;
        }

        .learning-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 10px 16px;
            background: linear-gradient(135deg, #9b59b622, #9b59b611);
            border: 2px solid #9b59b6;
            border-radius: 10px;
            color: #9b59b6;
            font-weight: 600;
            font-size: 13px;
            transition: all 0.2s;
        }

        .learning-toggle:hover {
            background: linear-gradient(135deg, #9b59b633, #9b59b622);
            transform: translateY(-1px);
        }

        .flashcard {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.3s;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            position: relative;
            perspective: 1000px;
        }

        .flashcard:hover {
            border-color: var(--accent);
            box-shadow: 0 4px 20px rgba(0,212,170,0.2);
        }

        .flashcard.flipped .flashcard-front {
            opacity: 0;
            transform: rotateY(180deg);
        }

        .flashcard.flipped .flashcard-back {
            opacity: 1;
            transform: rotateY(0);
        }

        .flashcard-front, .flashcard-back {
            transition: all 0.4s;
            backface-visibility: hidden;
        }

        .flashcard-front {
            opacity: 1;
        }

        .flashcard-back {
            position: absolute;
            opacity: 0;
            transform: rotateY(-180deg);
            padding: 16px;
        }

        .flashcard-term {
            font-size: 16px;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 4px;
        }

        .flashcard-hint {
            font-size: 10px;
            color: var(--text-muted);
        }

        .flashcard-definition {
            font-size: 12px;
            color: var(--text-primary);
            line-height: 1.5;
        }

        /* Drill Tab Styles */
        .drill-filter-btn {
            padding: 8px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }
        .drill-filter-btn:hover, .drill-filter-btn.active {
            background: var(--accent);
            color: #000;
            border-color: var(--accent);
        }
        .drill-card {
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        .drill-card:hover {
            border-color: var(--accent);
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(0,212,170,0.2);
        }
        .drill-card.mastered {
            border-color: #17bf63;
            background: linear-gradient(135deg, var(--bg-card), rgba(23,191,99,0.1));
        }
        .drill-card.mastered::after {
            content: '✓';
            position: absolute;
            top: 12px;
            right: 12px;
            background: #17bf63;
            color: #000;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .drill-card-company {
            font-size: 18px;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 4px;
        }
        .drill-card-type {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
        }
        .drill-card-contact {
            background: var(--bg-main);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
        }
        .drill-card-contact-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
        }
        .drill-card-contact-role {
            font-size: 11px;
            color: var(--text-muted);
        }
        .drill-card-contact-details {
            font-size: 11px;
            color: #45b7d1;
            margin-top: 4px;
            word-break: break-all;
        }
        .drill-card-note {
            font-size: 11px;
            color: #f5a623;
            margin-top: 8px;
            padding: 8px;
            background: rgba(245,166,35,0.1);
            border-radius: 6px;
        }
        .quiz-option {
            background: var(--bg-main);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 16px 20px;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 16px;
            color: var(--text-primary);
        }
        .quiz-option:hover {
            border-color: var(--accent);
            background: rgba(0,212,170,0.1);
        }
        .quiz-option.correct {
            border-color: #17bf63;
            background: rgba(23,191,99,0.2);
        }
        .quiz-option.incorrect {
            border-color: #e0245e;
            background: rgba(224,36,94,0.2);
        }
        .quiz-option.disabled {
            pointer-events: none;
            opacity: 0.7;
        }
        .match-card {
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .match-card:hover {
            border-color: var(--accent);
        }
        .match-card.selected {
            border-color: #f5a623;
            background: rgba(245,166,35,0.1);
        }
        .match-card.matched {
            border-color: #17bf63;
            background: rgba(23,191,99,0.2);
            pointer-events: none;
        }
        .match-card.wrong {
            animation: shake 0.3s;
            border-color: #e0245e;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .glossary-term {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            background: rgba(155, 89, 182, 0.15);
            border: 1px solid rgba(155, 89, 182, 0.3);
            border-radius: 4px;
            font-size: 10px;
            color: #9b59b6;
            cursor: help;
            position: relative;
        }

        .glossary-term:hover {
            background: rgba(155, 89, 182, 0.25);
        }

        .quiz-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quiz-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(155, 89, 182, 0.4);
        }

        .quiz-btn.correct {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
        }

        .quiz-btn.incorrect {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .progress-ring {
            width: 60px;
            height: 60px;
        }

        .progress-ring circle {
            transition: stroke-dashoffset 0.5s;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 0;
        }

        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
            transition: all 0.2s;
        }

        .tab:hover {
            color: var(--text-primary);
        }

        .tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Resource Pool */
        .resource-pool {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 24px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .resource-pool-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .resource-pool-header h2 {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .resources-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
        }

        .resource-chip {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            background: var(--bg-card);
            padding: 10px 16px;
            border-radius: 8px;
            cursor: grab;
            transition: all 0.2s;
            border: 1px solid var(--border);
            min-width: 200px;
            flex: 0 1 auto;
        }

        .resource-chip:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border-color: var(--accent);
        }

        .resource-chip.dragging { opacity: 0.4; }

        .resource-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .resource-name {
            font-size: 13px;
            color: var(--text-primary);
        }

        .resource-hours {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 600;
        }

        .hours-ok { background: var(--accent-dim); color: var(--accent); }
        .hours-full { background: rgba(245, 166, 35, 0.2); color: var(--warning); }
        .hours-over { background: rgba(224, 36, 94, 0.2); color: var(--danger); }

        /* Projects Grid */
        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .project-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.2s;
        }

        .project-card:hover { border-color: var(--accent); }
        .project-card.drag-over {
            border: 2px dashed var(--accent);
            background: var(--accent-dim);
        }

        .project-header {
            background: var(--bg-card);
            padding: 14px 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }

        .project-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--accent);
        }

        .project-hours {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .project-body { padding: 16px; }

        .assigned-list {
            min-height: 60px;
            margin-bottom: 16px;
        }

        .assigned-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: var(--bg-card);
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 3px solid var(--accent);
        }

        .assigned-item.over { border-left-color: var(--danger); background: rgba(224, 36, 94, 0.1); }
        .assigned-item.full { border-left-color: var(--warning); background: rgba(245, 166, 35, 0.1); }

        .assigned-name {
            font-size: 13px;
            color: var(--text-primary);
        }

        .assigned-controls {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .wanted-toggle {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 10px;
            color: var(--text-muted);
            cursor: pointer;
        }

        .wanted-toggle input:checked + span { color: var(--warning); }

        .date-input {
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            width: 100px;
        }

        .hour-btn {
            width: 22px;
            height: 22px;
            border: none;
            border-radius: 4px;
            background: var(--accent-dim);
            color: var(--accent);
            cursor: pointer;
            font-size: 14px;
        }

        .hour-btn:hover { background: var(--accent); color: var(--bg-primary); }

        .hour-input {
            width: 36px;
            text-align: center;
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 2px;
            border-radius: 4px;
            font-size: 12px;
        }

        .remove-btn {
            width: 22px;
            height: 22px;
            border: none;
            border-radius: 4px;
            background: rgba(224, 36, 94, 0.2);
            color: var(--danger);
            cursor: pointer;
            font-size: 12px;
        }

        .drop-zone {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            color: var(--text-muted);
            font-size: 12px;
        }

        /* Status Section */
        .status-section {
            border-top: 1px solid var(--border);
            padding-top: 12px;
            margin-top: 12px;
        }

        .status-checks {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 10px;
        }

        .status-check {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .status-check input { accent-color: var(--accent); }
        .status-check input:checked + span { color: var(--accent); }

        .expected-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            font-size: 11px;
            color: var(--text-secondary);
        }

        .notes-box, .issues-box {
            margin-top: 10px;
        }

        .notes-box label, .issues-box label {
            display: block;
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .notes-box textarea, .issues-box textarea {
            width: 100%;
            min-height: 50px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            padding: 10px;
            font-size: 12px;
            font-family: inherit;
            resize: vertical;
        }

        .notes-box textarea:focus, .issues-box textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        .issues-box textarea {
            border-color: rgba(224, 36, 94, 0.3);
        }

        .issues-box textarea:focus {
            border-color: var(--danger);
        }

        /* Milestones */
        .milestones-section {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }

        .milestones-header {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .milestone-row {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 6px;
        }

        .milestone-num {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--accent-dim);
            color: var(--accent);
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            flex-shrink: 0;
        }

        .milestone-num.complete {
            background: var(--success);
            color: var(--bg-primary);
        }

        .milestone-num.overdue {
            background: var(--danger);
            color: white;
        }

        .milestone-input {
            flex: 1;
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            min-width: 0;
        }

        .milestone-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .milestone-date {
            width: 110px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 4px 6px;
            border-radius: 4px;
            font-size: 10px;
            flex-shrink: 0;
        }

        .milestone-date.overdue {
            border-color: var(--danger);
            color: var(--danger);
        }

        .milestone-check {
            accent-color: var(--success);
            width: 14px;
            height: 14px;
            flex-shrink: 0;
        }

        .milestone-days {
            font-size: 10px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 4px;
            min-width: 50px;
            text-align: center;
            flex-shrink: 0;
        }
        .milestone-days.green {
            background: rgba(23, 191, 99, 0.15);
            color: #17bf63;
        }
        .milestone-days.amber {
            background: rgba(245, 166, 35, 0.15);
            color: #f5a623;
        }
        .milestone-days.red {
            background: rgba(224, 36, 94, 0.15);
            color: #e0245e;
        }
        .milestone-days.complete {
            background: rgba(23, 191, 99, 0.15);
            color: #17bf63;
            text-decoration: line-through;
            opacity: 0.7;
        }

        /* Daily Allocation Grid - Vertical Layout */
        .activity-grid {
            display: flex;
            flex-direction: column;
            gap: 2px;
            margin-top: 8px;
            font-size: 12px;
            color: var(--text-muted);
        }

        .day-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 2px 0;
        }

        .day-label {
            width: 90px;
            white-space: nowrap;
        }

        .day-hours {
            color: var(--text-secondary);
            font-weight: 500;
        }

        .day-hours.has-hours {
            color: var(--accent);
        }

        .activity-cell {
            width: 14px;
            height: 14px;
            border-radius: 3px;
            background: var(--bg-input);
            cursor: pointer;
            transition: all 0.15s;
            position: relative;
        }

        .activity-cell:hover {
            transform: scale(1.2);
            z-index: 10;
        }

        .activity-cell.level-0 { background: var(--bg-input); }
        .activity-cell.level-1 { background: rgba(0, 212, 170, 0.25); }
        .activity-cell.level-2 { background: rgba(0, 212, 170, 0.5); }
        .activity-cell.level-3 { background: rgba(0, 212, 170, 0.75); }
        .activity-cell.level-4 { background: var(--accent); }

        .activity-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 6px 10px;
            font-size: 11px;
            white-space: nowrap;
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.15s;
            margin-bottom: 4px;
        }

        .activity-cell:hover .activity-tooltip {
            opacity: 1;
        }

        .activity-legend {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 8px;
        }

        .activity-legend-cell {
            width: 10px;
            height: 10px;
            border-radius: 2px;
        }

        /* Status Badges */
        .status-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin: 10px 0;
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.15s;
            opacity: 0.4;
            border: 1px solid transparent;
        }

        .status-badge.active {
            opacity: 1;
        }

        .status-badge.waiting-client {
            background: rgba(245, 166, 35, 0.15);
            color: #f5a623;
            border-color: rgba(245, 166, 35, 0.3);
        }

        .status-badge.waiting-nsp {
            background: rgba(69, 183, 209, 0.15);
            color: #45b7d1;
            border-color: rgba(69, 183, 209, 0.3);
        }

        .status-badge.waiting-aemo {
            background: rgba(224, 36, 94, 0.15);
            color: #e0245e;
            border-color: rgba(224, 36, 94, 0.3);
        }

        .status-badge.project-active {
            background: rgba(23, 191, 99, 0.15);
            color: #17bf63;
            border-color: rgba(23, 191, 99, 0.3);
        }

        /* Project Card Redesign */
        .project-card-new .project-header {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 14px 18px;
        }

        .project-header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .expected-badge {
            font-size: 11px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .expected-badge .date {
            color: var(--accent);
            font-weight: 500;
        }

        .expected-badge.overdue .date {
            color: var(--danger);
        }

        /* Resource Row with Activity */
        .resource-row {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            padding: 12px 14px;
            background: var(--bg-card);
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 3px solid var(--accent);
        }

        .resource-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex: 1;
        }

        .resource-name-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .resource-hours-badge {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 10px;
            background: var(--accent-dim);
            color: var(--accent);
        }

        .resource-controls-mini {
            display: flex;
            align-items: center;
            gap: 4px;
            padding-top: 2px;
        }

        /* Collapsible Details Section */
        .details-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px;
            background: var(--bg-card);
            border-radius: 8px;
            cursor: pointer;
            margin-top: 12px;
            transition: all 0.15s;
        }

        .details-toggle:hover {
            background: var(--bg-input);
        }

        .details-toggle-left {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .details-toggle-icon {
            transition: transform 0.2s;
        }

        .details-toggle.open .details-toggle-icon {
            transform: rotate(180deg);
        }

        .details-indicators {
            display: flex;
            gap: 6px;
        }

        .detail-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--border);
        }

        .detail-indicator.has-content {
            background: var(--accent);
        }

        .detail-indicator.has-issues {
            background: var(--danger);
        }

        .details-content {
            display: none;
            padding: 14px;
            background: var(--bg-input);
            border-radius: 0 0 8px 8px;
            margin-top: -8px;
        }

        .details-content.open {
            display: block;
        }

        .detail-section {
            margin-bottom: 12px;
        }

        .detail-section:last-child {
            margin-bottom: 0;
        }

        .detail-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 6px;
        }

        .detail-textarea {
            width: 100%;
            min-height: 60px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            padding: 10px;
            font-size: 12px;
            font-family: inherit;
            resize: vertical;
        }

        .detail-textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* Day Allocation Popup */
        .day-allocation-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            z-index: 10000;
            min-width: 360px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .day-allocation-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 9999;
        }

        .day-allocation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }

        .day-allocation-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--accent);
        }

        .day-allocation-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 20px;
        }

        .day-allocation-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px;
        }

        .day-header {
            font-size: 10px;
            color: var(--text-muted);
            text-align: center;
            padding: 4px;
        }

        .day-cell {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: var(--bg-input);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .day-cell:hover {
            background: var(--accent-dim);
        }

        .day-cell.selected {
            background: var(--accent);
            color: var(--bg-primary);
        }

        .day-cell.weekend {
            opacity: 0.5;
        }

        .day-number {
            font-size: 12px;
            font-weight: 500;
        }

        .day-hours {
            font-size: 9px;
            margin-top: 2px;
        }

        .day-allocation-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 16px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }

        .total-hours-display {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .total-hours-display span {
            color: var(--accent);
            font-weight: 600;
        }

        /* Calendar Section */
        .calendar-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 100px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-header h2 {
            font-size: 18px;
            font-weight: 500;
        }

        .calendar-nav {
            display: flex;
            gap: 8px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }

        .calendar-day-header {
            text-align: center;
            padding: 8px;
            font-size: 12px;
            color: var(--text-muted);
            font-weight: 500;
        }

        .calendar-day {
            min-height: 80px;
            background: var(--bg-card);
            border-radius: 6px;
            padding: 8px;
            border: 1px solid var(--border);
        }

        .calendar-day.other-month { opacity: 0.4; }
        .calendar-day.today { border-color: var(--accent); }

        .calendar-date {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .calendar-events {
            font-size: 10px;
        }

        .calendar-event {
            padding: 2px 6px;
            border-radius: 4px;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Stakeholder Calendar */
        .calendar-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
        }
        .calendar-header-panel {
            border-bottom: 1px solid var(--border);
            padding-bottom: 16px;
            margin-bottom: 16px;
        }
        .calendar-grid-container {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }
        .calendar-day-header-cell {
            text-align: center;
            padding: 10px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
        }
        .calendar-day-cell {
            min-height: 100px;
            background: var(--bg-card);
            border-radius: 8px;
            padding: 8px;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
        }
        .calendar-day-cell:hover {
            border-color: var(--accent);
            background: var(--accent-dim);
        }
        .calendar-day-cell.other-month {
            opacity: 0.4;
        }
        .calendar-day-cell.today {
            border-color: var(--accent);
            border-width: 2px;
        }
        .calendar-day-number {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 6px;
        }
        .calendar-day-cell.today .calendar-day-number {
            color: var(--accent);
        }
        .calendar-meeting-item {
            padding: 4px 8px;
            border-radius: 4px;
            margin-bottom: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .calendar-meeting-item:hover {
            transform: scale(1.02);
        }
        .calendar-meeting-item.scheduled {
            background: rgba(69, 183, 209, 0.2);
            color: #45b7d1;
            border-left: 3px solid #45b7d1;
        }
        .calendar-meeting-item.completed {
            background: rgba(23, 191, 99, 0.2);
            color: #17bf63;
            border-left: 3px solid #17bf63;
        }
        .calendar-meeting-item.requested {
            background: rgba(245, 166, 35, 0.2);
            color: #f5a623;
            border-left: 3px solid #f5a623;
        }
        .upcoming-meeting-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .upcoming-meeting-card:hover {
            border-color: var(--accent);
        }
        .meeting-info h4 {
            font-size: 14px;
            color: var(--accent);
            margin-bottom: 4px;
        }
        .meeting-info p {
            font-size: 12px;
            color: var(--text-secondary);
        }
        .meeting-date-badge {
            background: var(--accent-dim);
            color: var(--accent);
            padding: 8px 16px;
            border-radius: 8px;
            text-align: center;
        }
        .meeting-date-badge .day {
            font-size: 24px;
            font-weight: 700;
        }
        .meeting-date-badge .month {
            font-size: 10px;
            text-transform: uppercase;
        }

        /* Summary Panel */
        .summary-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px 24px;
            display: flex;
            gap: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .summary-stat {
            text-align: center;
        }

        .summary-stat .value {
            font-size: 24px;
            font-weight: 600;
            color: var(--accent);
        }

        .summary-stat .label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .summary-stat.warning .value { color: var(--danger); }

        /* ====================== */
        /* SALES RADAR STYLES     */
        /* ====================== */
        .radar-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 24px;
        }

        .radar-panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
        }

        .radar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .radar-header h2 {
            font-size: 20px;
            font-weight: 600;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .radar-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--accent-dim);
            display: flex;
            align-items: center;
            justify-content: center;
            animation: radar-sweep 3s ease-in-out infinite;
        }

        @keyframes radar-sweep {
            0%, 100% { box-shadow: 0 0 0 0 rgba(0, 212, 170, 0.4); }
            50% { box-shadow: 0 0 0 15px rgba(0, 212, 170, 0); }
        }

        .radar-table {
            width: 100%;
            border-collapse: collapse;
        }

        .radar-table th {
            padding: 12px 16px;
            text-align: center;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 2px solid var(--border);
        }

        .radar-table th:first-child {
            text-align: left;
            width: 200px;
        }

        .radar-table td {
            padding: 16px;
            text-align: center;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
        }

        .radar-table td:first-child {
            text-align: left;
        }

        .radar-table tr:hover {
            background: var(--bg-card);
        }

        .client-name {
            font-size: 15px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .client-type {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .quarter-cell {
            min-width: 100px;
        }

        .pulse-container {
            display: flex;
            justify-content: center;
            gap: 8px;
        }

        .pulse-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--radar-pulse);
            animation: pulse-glow 2s ease-in-out infinite;
            cursor: pointer;
            position: relative;
        }

        .pulse-dot:hover {
            transform: scale(1.2);
        }

        .pulse-dot.bess {
            background: #f5a623;
        }

        .pulse-dot.solar {
            background: #ffd93d;
        }

        .pulse-dot.wind {
            background: #6bcf7f;
        }

        .pulse-dot.grid {
            background: #00d4aa;
        }

        @keyframes pulse-glow {
            0%, 100% {
                opacity: 1;
                box-shadow: 0 0 0 0 rgba(0, 212, 170, 0.7);
            }
            50% {
                opacity: 0.8;
                box-shadow: 0 0 0 8px rgba(0, 212, 170, 0);
            }
        }

        .pulse-dot.bess {
            animation-name: pulse-glow-bess;
        }

        @keyframes pulse-glow-bess {
            0%, 100% {
                opacity: 1;
                box-shadow: 0 0 0 0 rgba(245, 166, 35, 0.7);
            }
            50% {
                opacity: 0.8;
                box-shadow: 0 0 0 8px rgba(245, 166, 35, 0);
            }
        }

        /* Notes Panel */
        .notes-panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
        }

        .notes-panel h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }

        .intel-item {
            background: var(--bg-card);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            border-left: 3px solid var(--accent);
        }

        .intel-item.highlight {
            border-left-color: var(--warning);
            background: rgba(245, 166, 35, 0.05);
        }

        .intel-client {
            font-size: 14px;
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 8px;
        }

        .intel-text {
            font-size: 13px;
            color: var(--text-primary);
            line-height: 1.6;
        }

        .intel-date {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .intel-source {
            font-size: 10px;
            color: var(--text-secondary);
            background: var(--bg-secondary);
            padding: 2px 8px;
            border-radius: 4px;
            margin-left: 8px;
        }

        /* Legend */
        .radar-legend {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .legend-dot.bess { background: #f5a623; }
        .legend-dot.solar { background: #ffd93d; }
        .legend-dot.wind { background: #6bcf7f; }
        .legend-dot.grid { background: #00d4aa; }

        /* Editable Radar Notes */
        .radar-notes-cell {
            position: relative;
        }

        .radar-notes-textarea {
            width: 100%;
            min-height: 80px;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 12px;
            line-height: 1.5;
            resize: vertical;
            font-family: inherit;
        }

        .radar-notes-textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(0, 212, 170, 0.2);
        }

        .radar-save-row {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }

        .radar-save-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .radar-save-btn.primary {
            background: var(--accent);
            color: var(--bg-primary);
        }

        .radar-save-btn.primary:hover {
            background: var(--accent-hover);
        }

        .radar-save-status {
            font-size: 12px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .radar-save-status.success {
            color: var(--success);
        }

        /* ====================== */
        /* LOGIN OVERLAY STYLES   */
        /* ====================== */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .login-overlay.hidden {
            display: none;
        }

        .login-box {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 40px;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .login-box h2 {
            color: var(--accent);
            font-size: 24px;
            margin-bottom: 8px;
        }

        .login-box .subtitle {
            color: var(--text-muted);
            font-size: 13px;
            margin-bottom: 32px;
        }

        .login-box .logo {
            width: 60px;
            height: 60px;
            background: var(--accent-dim);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
        }

        .login-box .logo svg {
            width: 32px;
            height: 32px;
            stroke: var(--accent);
        }

        .login-btn {
            width: 100%;
            padding: 14px 24px;
            background: var(--accent);
            color: var(--bg-primary);
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 16px;
        }

        .login-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .login-note {
            font-size: 11px;
            color: var(--text-muted);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--bg-secondary);
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .user-info .user-email {
            font-size: 12px;
            color: var(--text-primary);
        }

        .user-info .logout-btn {
            padding: 4px 12px;
            font-size: 11px;
            background: transparent;
            color: var(--text-muted);
            border: 1px solid var(--border);
            border-radius: 4px;
            cursor: pointer;
        }

        .user-info .logout-btn:hover {
            color: var(--danger);
            border-color: var(--danger);
        }

        /* ====================== */
        /* SUMMARY TAB STYLES     */
        /* ====================== */
        .summary-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        .summary-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
        }

        .summary-card.full-width {
            grid-column: 1 / -1;
        }

        .summary-card h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .summary-card h3 svg {
            width: 20px;
            height: 20px;
        }

        .holiday-timeline {
            display: flex;
            gap: 4px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 8px;
            justify-content: center;
        }

        .timeline-day {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 65px;
            padding: 12px 8px;
            border-radius: 8px;
            background: var(--bg-card);
            border: 1px solid var(--border);
        }

        .timeline-day.weekend {
            background: var(--bg-secondary);
            opacity: 0.6;
            border-style: dashed;
        }

        .timeline-day.office-closed {
            background: rgba(245, 166, 35, 0.15);
            border-color: var(--warning);
        }

        .timeline-day.public-holiday {
            background: rgba(0, 212, 170, 0.35) !important;
            border: 2px solid var(--accent) !important;
            box-shadow: 0 0 8px rgba(0, 212, 170, 0.3);
        }

        .timeline-day.public-holiday .day-num {
            color: var(--accent);
        }

        .timeline-day.christmas {
            background: var(--accent) !important;
            border-color: var(--accent) !important;
            box-shadow: 0 0 12px rgba(0, 212, 170, 0.5);
        }

        .timeline-day.christmas .day-name,
        .timeline-day.christmas .day-num,
        .timeline-day.christmas .month {
            color: var(--bg-primary);
            font-weight: 600;
        }

        .timeline-day .day-name {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 2px;
        }

        .timeline-day .day-num {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .timeline-day .month {
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .holiday-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .holiday-table th {
            padding: 8px 10px;
            text-align: left;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border);
            font-weight: 500;
            font-size: 11px;
        }

        .holiday-table td {
            padding: 6px 10px;
            border-bottom: 1px solid var(--border);
            color: var(--text-primary);
        }

        .holiday-table tr:hover {
            background: var(--bg-card);
        }

        .holiday-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 500;
        }

        .holiday-badge.public {
            background: rgba(0, 212, 170, 0.15);
            color: var(--accent);
        }

        .holiday-badge.office {
            background: rgba(245, 166, 35, 0.15);
            color: var(--warning);
        }

        .team-leave-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
        }

        .team-region {
            margin-bottom: 12px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px;
        }

        .team-region h4 {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            padding-bottom: 0;
            border-bottom: none;
        }

        .leave-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: var(--bg-card);
            border-radius: 8px;
            margin-bottom: 6px;
        }

        .leave-item .status-icon {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .leave-item .status-icon.working {
            background: var(--success);
        }

        .leave-item .status-icon.leave {
            background: var(--warning);
        }

        .leave-item .name {
            flex: 1;
            font-size: 13px;
            color: var(--text-primary);
        }

        .leave-item .dates {
            font-size: 11px;
            color: var(--text-muted);
        }

        .focus-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 16px;
        }

        .focus-item {
            display: flex;
            flex-direction: column;
            padding: 16px 20px;
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .focus-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .focus-item.priority-high {
            border-color: var(--danger);
            background: linear-gradient(135deg, rgba(224, 36, 94, 0.08) 0%, var(--bg-card) 100%);
        }

        .focus-item.priority-medium {
            border-color: var(--warning);
            background: linear-gradient(135deg, rgba(245, 166, 35, 0.08) 0%, var(--bg-card) 100%);
        }

        .focus-item-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .focus-icon {
            width: 32px;
            height: 32px;
            border-radius: 10px;
            background: var(--accent-dim);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .focus-icon svg {
            width: 16px;
            height: 16px;
            stroke: var(--accent);
        }

        .focus-item.priority-high .focus-icon {
            background: rgba(224, 36, 94, 0.2);
        }

        .focus-item.priority-high .focus-icon svg {
            stroke: var(--danger);
        }

        .focus-item.priority-medium .focus-icon {
            background: rgba(245, 166, 35, 0.2);
        }

        .focus-item.priority-medium .focus-icon svg {
            stroke: var(--warning);
        }

        .focus-content h4 {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
            flex: 1;
        }

        .focus-content p {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 8px;
        }

        .focus-content .owner {
            font-size: 11px;
            color: var(--accent);
            margin-top: auto;
            padding-top: 8px;
            border-top: 1px solid var(--border);
        }

        .safety-moment {
            background: linear-gradient(135deg, rgba(245, 166, 35, 0.08), rgba(224, 36, 94, 0.05));
            border: 1px solid rgba(245, 166, 35, 0.25);
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 20px;
        }

        .safety-moment h4 {
            font-size: 13px;
            font-weight: 600;
            color: var(--warning);
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .safety-moment h4 svg {
            width: 14px;
            height: 14px;
        }

        .safety-moment p {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 0;
        }

        .safety-tips {
            margin-top: 8px;
            padding-left: 18px;
            columns: 2;
            column-gap: 24px;
        }

        .safety-tips li {
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        /* Stakeholder Grid - Excel-like */
        .stakeholder-container {
            padding: 0;
        }
        .stakeholder-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .stakeholder-header h2 {
            font-size: 18px;
            font-weight: 600;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .stakeholder-filters {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        .stakeholder-filters select {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
        }
        .stakeholder-filters select:focus {
            outline: none;
            border-color: var(--accent);
        }
        .stakeholder-grid {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }
        .stakeholder-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        .stakeholder-table th {
            background: var(--bg-card);
            color: var(--accent);
            padding: 12px 14px;
            text-align: left;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 10;
            cursor: pointer;
            user-select: none;
            position: relative;
        }
        .stakeholder-table th:hover {
            background: var(--bg-secondary);
        }
        .th-filter {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 6px;
        }
        .filter-arrow {
            width: 12px;
            height: 12px;
            opacity: 0.6;
            transition: transform 0.2s, opacity 0.2s;
        }
        .stakeholder-table th:hover .filter-arrow {
            opacity: 1;
        }
        .filter-arrow.asc {
            transform: rotate(180deg);
        }
        .filter-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            min-width: 140px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            z-index: 1000;
            display: none;
        }
        .filter-dropdown.show {
            display: block;
        }
        .filter-option {
            padding: 10px 14px;
            font-size: 12px;
            cursor: pointer;
            color: var(--text-primary);
            text-transform: none;
            letter-spacing: normal;
            font-weight: 400;
        }
        .filter-option:hover {
            background: var(--accent-dim);
            color: var(--accent);
        }
        .filter-option.active {
            background: var(--accent);
            color: var(--bg-primary);
        }
        .stakeholder-table td {
            padding: 10px 14px;
            border-bottom: 1px solid var(--border);
            vertical-align: top;
        }
        .stakeholder-table tr:hover td {
            background: rgba(0, 212, 170, 0.05);
        }
        .stakeholder-input {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid transparent;
            border-radius: 4px;
            font-size: 12px;
            background: transparent;
            color: var(--text-primary);
            transition: all 0.2s;
        }
        .stakeholder-input.decision-maker {
            font-weight: 700;
            color: var(--accent);
        }
        .stakeholder-input:hover {
            border-color: var(--border);
            background: var(--bg-input);
        }
        .stakeholder-input:focus {
            outline: none;
            border-color: var(--accent);
            background: var(--bg-input);
            box-shadow: 0 0 0 2px rgba(0, 212, 170, 0.15);
        }
        .stakeholder-input::placeholder {
            color: var(--text-muted);
        }
        .stakeholder-textarea {
            width: 100%;
            min-height: 50px;
            padding: 6px 10px;
            border: 1px solid transparent;
            border-radius: 4px;
            font-size: 12px;
            font-family: inherit;
            background: transparent;
            color: var(--text-primary);
            resize: vertical;
            transition: all 0.2s;
        }
        .stakeholder-textarea:hover {
            border-color: var(--border);
            background: var(--bg-input);
        }
        .stakeholder-textarea:focus {
            outline: none;
            border-color: var(--accent);
            background: var(--bg-input);
        }
        .stakeholder-select {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 12px;
            background: var(--bg-input);
            color: var(--text-primary);
        }
        .stakeholder-select:focus {
            outline: none;
            border-color: var(--accent);
        }
        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        .status-badge.not-scheduled { background: rgba(224, 36, 94, 0.15); color: #e0245e; }
        .status-badge.requested { background: rgba(245, 166, 35, 0.15); color: #f5a623; }
        .status-badge.scheduled { background: rgba(69, 183, 209, 0.15); color: #45b7d1; }
        .status-badge.completed { background: rgba(23, 191, 99, 0.15); color: #17bf63; }
        .priority-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        .priority-badge.high { background: rgba(224, 36, 94, 0.15); color: #e0245e; }
        .priority-badge.medium { background: rgba(245, 166, 35, 0.15); color: #f5a623; }
        .priority-badge.low { background: rgba(101, 119, 134, 0.15); color: #657786; }
        .project-tag {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
            background: rgba(0, 212, 170, 0.15);
            color: var(--accent);
            margin: 1px 2px;
        }
        .project-tag.completed {
            background: var(--bg-card);
            color: var(--text-muted);
        }
        .stakeholder-summary {
            display: flex;
            gap: 24px;
            padding: 16px 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-top: 16px;
            font-size: 13px;
        }
        .stakeholder-summary-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .stakeholder-summary-item strong {
            color: var(--accent);
        }
        .company-cell {
            cursor: pointer;
        }
        .company-cell:hover .company-name {
            color: var(--accent);
        }
        .company-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 13px;
            transition: color 0.2s;
        }
        .company-code {
            font-size: 10px;
            color: var(--text-muted);
        }
        .company-contacts {
            font-size: 10px;
            color: var(--accent);
            margin-top: 2px;
        }
        .type-badge {
            font-size: 11px;
            font-weight: 600;
        }
        .type-badge.developer { color: #17bf63; }
        .type-badge.epc { color: #f5a623; }
        .type-badge.oem { color: #8b5cf6; }
        .type-badge.nsp { color: #45b7d1; }
        .type-badge.aemo { color: #e0245e; }
        .type-badge.asset-owner { color: #6366f1; }
        .type-badge.investor { color: #a855f7; }
        .type-badge.consultant { color: #d97706; }

        /* Pulsing dot for header */
        .pulse-dot-header {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--accent);
            display: inline-block;
            margin-right: 8px;
            animation: pulse-glow 2s ease-in-out infinite;
            box-shadow: 0 0 8px var(--accent);
        }
        @keyframes pulse-glow {
            0%, 100% { opacity: 1; box-shadow: 0 0 8px var(--accent); }
            50% { opacity: 0.6; box-shadow: 0 0 16px var(--accent), 0 0 24px var(--accent); }
        }

        /* Contact method badges */
        .contact-method {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            margin: 2px;
            cursor: pointer;
        }
        .contact-method.email { background: rgba(69, 183, 209, 0.15); color: #45b7d1; }
        .contact-method.call { background: rgba(23, 191, 99, 0.15); color: #17bf63; }
        .contact-method.linkedin { background: rgba(0, 119, 181, 0.15); color: #0077b5; }
        .contact-method.intro { background: rgba(167, 139, 250, 0.15); color: #a78bfa; }
        .contact-method.meeting { background: rgba(245, 166, 35, 0.15); color: #f5a623; }

        /* Key contact styling */
        .key-contact-name {
            font-weight: 700;
            color: var(--accent);
            font-size: 13px;
        }
        .key-contact-role {
            font-size: 11px;
            color: var(--text-muted);
        }
        .key-contact-company {
            font-size: 10px;
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <!-- Login Overlay - Temporarily disabled -->
    <div class="login-overlay" id="loginOverlay">
        <div class="login-box">
            <div class="logo">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                    <path d="M2 17l10 5 10-5"/>
                    <path d="M2 12l10 5 10-5"/>
                </svg>
            </div>
            <h2>Program View</h2>
            <p class="subtitle">Vysus Group Resource Management</p>

            <!-- Supabase Login Form -->
            <div id="loginForm">
                <input type="email" id="loginEmail" placeholder="Email (@vysusgroup.com)"
                    style="width: 100%; padding: 12px 16px; margin-bottom: 12px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                <input type="password" id="loginPassword" placeholder="Password"
                    style="width: 100%; padding: 12px 16px; margin-bottom: 16px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                <div id="loginError" style="color: #e0245e; font-size: 13px; margin-bottom: 12px; display: none;"></div>
                <button type="button" class="login-btn" onclick="handleSupabaseLogin()" style="width: 100%; margin-bottom: 12px;">
                    Sign In
                </button>
                <button type="button" class="login-btn" onclick="toggleSignUp()"
                    style="width: 100%; background: transparent; border: 1px solid var(--accent); color: var(--accent);">
                    Create Account
                </button>
            </div>

            <!-- Sign Up Form (hidden by default) -->
            <div id="signUpForm" style="display: none;">
                <input type="text" id="signUpName" placeholder="Full Name"
                    style="width: 100%; padding: 12px 16px; margin-bottom: 12px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                <input type="email" id="signUpEmail" placeholder="Email (@vysusgroup.com)"
                    style="width: 100%; padding: 12px 16px; margin-bottom: 12px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                <input type="password" id="signUpPassword" placeholder="Password (min 8 characters)"
                    style="width: 100%; padding: 12px 16px; margin-bottom: 16px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                <div id="signUpError" style="color: #e0245e; font-size: 13px; margin-bottom: 12px; display: none;"></div>
                <div id="signUpSuccess" style="color: #17bf63; font-size: 13px; margin-bottom: 12px; display: none;"></div>
                <button type="button" class="login-btn" onclick="handleSupabaseSignUp()" style="width: 100%; margin-bottom: 12px;">
                    Create Account
                </button>
                <button type="button" class="login-btn" onclick="toggleSignUp()"
                    style="width: 100%; background: transparent; border: 1px solid var(--border); color: var(--text-secondary);">
                    Back to Sign In
                </button>
            </div>

            <p class="login-note">Secured with Supabase + Row Level Security</p>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>Program View</h1>
            <div class="header-right">
                <div class="user-info" id="userInfo" style="display: none;">
                    <span class="user-email" id="userEmail"></span>
                    <button class="logout-btn" onclick="logout()">Logout</button>
                </div>
                <div class="status-indicator">
                    <span class="status-dot" id="statusDot"></span>
                    <span id="syncStatus">Checking connection...</span>
                </div>
                <div class="week-selector" id="weekSelectorContainer">
                    <span>Week:</span>
                    <input type="week" id="weekSelector">
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" data-tab="summary" onclick="switchTab('summary')">Summary</button>
            <button class="tab" data-tab="projects" onclick="switchTab('projects')">Projects</button>
            <button class="tab admin-tab" data-tab="radar" onclick="switchTab('radar')" style="display: none;">Sales Radar</button>
            <button class="tab admin-tab" data-tab="stakeholders" onclick="switchTab('stakeholders')" style="display: none;">Stakeholders</button>
            <button class="tab" data-tab="comms" onclick="switchTab('comms')">Communications</button>
            <button class="tab" data-tab="research" onclick="switchTab('research')">Research</button>
            <button class="tab" data-tab="contacts" onclick="switchTab('contacts')">Contacts</button>
            <button class="tab admin-tab" data-tab="drill" onclick="switchTab('drill')" style="display: none;">Drill</button>
            <button class="tab admin-tab" data-tab="calendar" onclick="switchTab('calendar')" style="display: none;">Calendar</button>
            <button class="tab admin-tab" data-tab="map" onclick="switchTab('map')" style="display: none;">Industry Map</button>
            <!-- Admin Toggle - Pill Switch -->
            <div id="adminToggleBtn" onclick="toggleAdminMode()" style="margin-left: auto; display: none; align-items: center; gap: 6px; cursor: pointer;" title="Toggle Admin Mode">
                <span style="font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Admin</span>
                <div id="adminTogglePill" style="width: 36px; height: 20px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; position: relative; transition: all 0.2s;">
                    <div id="adminToggleBall" style="width: 14px; height: 14px; background: var(--text-muted); border-radius: 50%; position: absolute; top: 2px; left: 2px; transition: all 0.2s;"></div>
                </div>
            </div>
        </div>

        <!-- Admin Controls (hidden by default) -->
        <div id="adminControls" style="display: none; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; padding: 12px 16px; margin-bottom: 16px;">
            <div style="display: flex; align-items: center; gap: 16px; flex-wrap: wrap;">
                <span style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px;">Admin Mode Active</span>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span id="adminStatusIndicator" style="width: 8px; height: 8px; border-radius: 50%; background: #17bf63;"></span>
                    <span id="adminStatusText" style="font-size: 12px; color: var(--text-secondary);">Connected to Supabase</span>
                </div>
            </div>
        </div>

        <!-- Summary Tab Content -->
        <div class="tab-content active" id="tab-summary">
            <!-- Q1 2026 Key Dates -->
            <div style="background: var(--bg-secondary); border: 1px solid var(--warning); border-radius: 12px; padding: 16px 24px; margin-bottom: 20px;">
                <div style="font-weight: 700; color: var(--warning); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px; font-size: 14px;">Q1 2026 Key Dates</div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; color: var(--text-secondary); font-size: 13px;">
                    <div><strong style="color: var(--text-primary);">Jan 23:</strong> CIS Tender 8 Registration Closes</div>
                    <div><strong style="color: var(--text-primary);">Feb 6:</strong> CIS Tender 8 Bids Due</div>
                    <div><strong style="color: var(--text-primary);">Feb 8-11:</strong> World Renewable Energy Congress (Perth)</div>
                    <div><strong style="color: var(--text-primary);">Mar 5:</strong> Smart Installer Roadshow (Melbourne)</div>
                    <div><strong style="color: var(--text-primary);">Mar 17-19:</strong> Energy Networks Conference (Adelaide)</div>
                </div>
            </div>

            <div class="safety-moment" onclick="showSafetyMoment()" style="cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.transform='scale(1.01)'; this.style.boxShadow='0 4px 20px rgba(245, 166, 35, 0.2)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
                <h4>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                        <line x1="12" y1="9" x2="12" y2="13"/>
                        <line x1="12" y1="17" x2="12.01" y2="17"/>
                    </svg>
                    Safety Moment - Holiday Season Driving
                    <span style="margin-left: auto; font-size: 11px; color: var(--text-muted); font-weight: 400;">Click to read</span>
                </h4>
            </div>

            <div class="summary-grid">
                <!-- Upcoming Milestones Timeline -->
                <div class="summary-card full-width">
                    <h3>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="3" y1="12" x2="21" y2="12"/>
                            <circle cx="6" cy="12" r="2"/>
                            <circle cx="12" cy="12" r="2"/>
                            <circle cx="18" cy="12" r="2"/>
                        </svg>
                        Upcoming Milestones
                    </h3>
                    <div style="display: flex; align-items: center; gap: 8px; padding: 16px; background: var(--bg-card); border-radius: 8px; overflow-x: auto;">
                        <!-- Today -->
                        <div style="flex-shrink: 0; text-align: center; padding: 12px 20px; background: var(--accent); border-radius: 8px;">
                            <div style="font-size: 10px; color: var(--bg-primary); text-transform: uppercase; font-weight: 600;">Today</div>
                            <div style="font-size: 13px; color: var(--bg-primary); font-weight: 600;">Alinta Kick-off</div>
                            <div style="font-size: 10px; color: var(--bg-primary);">Meeting with Sam & Cedric</div>
                        </div>
                        <div style="flex-shrink: 0; width: 40px; height: 2px; background: var(--border);"></div>
                        <!-- Elencor Proposal -->
                        <div style="flex-shrink: 0; text-align: center; padding: 12px 20px; background: var(--warning); border-radius: 8px;">
                            <div style="font-size: 10px; color: var(--bg-primary); text-transform: uppercase; font-weight: 600;">16 Jan</div>
                            <div style="font-size: 13px; color: var(--bg-primary); font-weight: 600;">Elencor Proposal</div>
                            <div style="font-size: 10px; color: var(--bg-primary);">Submission deadline</div>
                        </div>
                        <div style="flex-shrink: 0; width: 40px; height: 2px; background: var(--border);"></div>
                        <!-- 19 Jan -->
                        <div style="flex-shrink: 0; text-align: center; padding: 12px 20px; background: var(--bg-secondary); border: 2px solid var(--accent); border-radius: 8px;">
                            <div style="font-size: 10px; color: var(--text-muted); text-transform: uppercase; font-weight: 600;">19 Jan 2025</div>
                            <div style="font-size: 13px; color: var(--accent); font-weight: 600;">Alinta</div>
                            <div style="font-size: 10px; color: var(--text-secondary);">Submit Capacity Study</div>
                        </div>
                    </div>
                </div>

                <!-- Key Focus Areas -->
                <div class="summary-card full-width">
                    <h3>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <circle cx="12" cy="12" r="6"/>
                            <circle cx="12" cy="12" r="2"/>
                        </svg>
                        Key Focus Areas - End of Year
                    </h3>
                    <div class="focus-list">
                        <div class="focus-item priority-high">
                            <div class="focus-item-header">
                                <div class="focus-icon">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="12" y1="1" x2="12" y2="23"/>
                                        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                                    </svg>
                                </div>
                                <div class="focus-content"><h4>RP Budget Management</h4></div>
                            </div>
                            <div class="focus-content">
                                <p>Renewed focus required. RPs must actively monitor and flag budget status in project meetings. Cannot afford budgets going significantly over.</p>
                                <ul style="margin: 4px 0 0 16px; font-size: 11px; color: var(--text-secondary);">
                                    <li>Review all project budgets</li>
                                    <li>Flag overruns immediately</li>
                                    <li>Contact clients on outstanding debits</li>
                                </ul>
                            </div>
                        </div>

                        <div class="focus-item priority-high">
                            <div class="focus-item-header">
                                <div class="focus-icon">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                        <polyline points="14,2 14,8 20,8"/>
                                        <line x1="16" y1="13" x2="8" y2="13"/>
                                        <line x1="16" y1="17" x2="8" y2="17"/>
                                    </svg>
                                </div>
                                <div class="focus-content"><h4>Hallett BESS Issues Tracker</h4></div>
                            </div>
                            <div class="focus-content">
                                <p>Energy Australia (Lauri) seeking issues tracker response. 100-150 items to address. Critical before Christmas break.</p>
                                <div class="owner">Owner: Naveen | Contact: Lauri</div>
                            </div>
                        </div>

                        <div class="focus-item priority-high">
                            <div class="focus-item-header">
                                <div class="focus-icon">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                        <line x1="3" y1="9" x2="21" y2="9"/>
                                        <line x1="9" y1="21" x2="9" y2="9"/>
                                    </svg>
                                </div>
                                <div class="focus-content"><h4>Alinta / Mt Challenger</h4></div>
                            </div>
                            <div class="focus-content">
                                <p>Finalising Ts&Cs for MRE BESS Studies. Close out contractual items before holiday period.</p>
                                <p style="margin-top: 8px;"><strong>Arif Delivery:</strong> AGL Package A and RES Avonlie SF in progress.</p>
                                <div class="owner">Owner: Chris M | Contact: Cedric Banda</div>
                            </div>
                        </div>

                        <div class="focus-item">
                            <div class="focus-item-header">
                                <div class="focus-icon">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"/>
                                    </svg>
                                </div>
                                <div class="focus-content"><h4>Sales Focus</h4></div>
                            </div>
                            <div class="focus-content">
                                <p>Continue sales push through holidays. Key prospects: Pacific Blue (2x BESS), Birdwood, Elgin.</p>
                                <div class="owner">See: Sales Radar Tab</div>
                            </div>
                        </div>

                        <div class="focus-item" style="border-color: var(--success);">
                            <div class="focus-item-header">
                                <div class="focus-icon" style="background: rgba(23, 191, 99, 0.15);">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="#17bf63" stroke-width="2">
                                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                        <polyline points="22,4 12,14.01 9,11.01"/>
                                    </svg>
                                </div>
                                <div class="focus-content"><h4>Sentinel Program Winner!</h4></div>
                            </div>
                            <div class="focus-content">
                                <p>Winner announced! 10 entries with great ideas. Strong team engagement.</p>
                                <div class="owner">Well done team!</div>
                            </div>
                        </div>

                        <div class="focus-item" style="border-color: var(--success);">
                            <div class="focus-item-header">
                                <div class="focus-icon" style="background: rgba(23, 191, 99, 0.15);">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="#17bf63" stroke-width="2">
                                        <rect x="5" y="2" width="14" height="20" rx="2" ry="2"/>
                                        <line x1="12" y1="18" x2="12.01" y2="18"/>
                                    </svg>
                                </div>
                                <div class="focus-content"><h4>Capability Flyer Mobile</h4></div>
                            </div>
                            <div class="focus-content">
                                <p>Now mobile responsive. Click button takes clients directly to studies section.</p>
                                <div class="owner">Ready to share with clients</div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Resource Summary -->
                <div class="summary-card full-width">
                    <h3>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                            <circle cx="9" cy="7" r="4"/>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                        </svg>
                        Resource Summary - Jan 2026
                    </h3>
                    <div class="focus-list">
                        <div class="focus-item" style="border-left-color: var(--accent);">
                            <div class="focus-content">
                                <h4>Arif</h4>
                                <p>New project starting Monday - expect slow ramp-up. Available to support Birdwood in interim. <strong>March leave planned.</strong></p>
                            </div>
                        </div>
                        <div class="focus-item" style="border-left-color: var(--success);">
                            <div class="focus-content">
                                <h4>Owais</h4>
                                <p>Hallett DD close to submission. Then back to Armidale. Available for Birdwood after Hallett clears - same inverter/PE model experience.</p>
                            </div>
                        </div>
                        <div class="focus-item" style="border-left-color: var(--warning);">
                            <div class="focus-content">
                                <h4>Naveen</h4>
                                <p>Clements Gap - 50 comments due by Friday. $30k variation raised (was $70k - training done).</p>
                            </div>
                        </div>
                        <div class="focus-item" style="border-left-color: var(--info);">
                            <div class="focus-content">
                                <h4>Malaysia Team (Syafiq, Amani)</h4>
                                <p>Available for PSS/E queries. Same region as Arif - good backup for Birdwood support.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Billing & Payments -->
                <div class="summary-card full-width">
                    <h3>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="1" x2="12" y2="23"/>
                            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                        </svg>
                        Billing & Payments Update
                    </h3>
                    <div class="focus-list">
                        <div class="focus-item" style="border-left-color: var(--warning);">
                            <div class="focus-icon" style="background: rgba(245, 166, 35, 0.15);">
                                <svg viewBox="0 0 24 24" fill="none" stroke="#f5a623" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <polyline points="12,6 12,12 16,14"/>
                                </svg>
                            </div>
                            <div class="focus-content">
                                <h4>Birdwood - Payment Expected</h4>
                                <p>Expected to pay before end of year. Follow up if not received by 20 Dec.</p>
                                <div class="owner">Status: Pending</div>
                            </div>
                        </div>

                        <div class="focus-item" style="border-left-color: var(--success);">
                            <div class="focus-icon" style="background: rgba(23, 191, 99, 0.15);">
                                <svg viewBox="0 0 24 24" fill="none" stroke="#17bf63" stroke-width="2">
                                    <polyline points="20,6 9,17 4,12"/>
                                </svg>
                            </div>
                            <div class="focus-content">
                                <h4>Elgin - Invoice Paid</h4>
                                <p>One invoice has been paid. Confirm receipt and update records.</p>
                                <div class="owner">Status: Received</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Projects Tab Content -->
        <div class="tab-content" id="tab-projects">
            <div class="resource-pool" id="resourcePool"></div>
            <div class="projects-grid" id="projectsGrid"></div>
            <div class="calendar-section" id="calendarSection"></div>
        </div>

        <!-- Sales Radar Tab Content -->
        <div class="tab-content" id="tab-radar">
            <div class="radar-container">
                <div class="radar-panel">
                    <div class="radar-header">
                        <h2>
                            <span class="radar-icon">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <circle cx="12" cy="12" r="6"/>
                                    <circle cx="12" cy="12" r="2"/>
                                    <line x1="12" y1="2" x2="12" y2="6"/>
                                </svg>
                            </span>
                            Sales Radar - 2026
                        </h2>
                    </div>

                    <table class="radar-table">
                        <thead>
                            <tr>
                                <th>Client</th>
                                <th class="quarter-cell">Q1 2026</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>
                                    <div class="client-name">Birdwood</div>
                                    <div class="client-type">Developer</div>
                                </td>
                                <td class="quarter-cell">
                                    <div class="pulse-container">
                                        <div class="pulse-dot grid" title="Grid Connection"></div>
                                    </div>
                                </td>
                                <td class="radar-notes-cell">
                                    <textarea class="radar-notes-textarea" data-client="birdwood" placeholder="Add notes...">• Indicated project coming up
• Eric asked for R1/R2 proposal - thought we had applied
• ACTION: Follow up on R1/R2 submission status
• Contact: Eric</textarea>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <div class="client-name">Elgin</div>
                                    <div class="client-type">Developer</div>
                                </td>
                                <td class="quarter-cell">
                                    <div class="pulse-container">
                                        <div class="pulse-dot solar" title="Solar"></div>
                                    </div>
                                </td>
                                <td class="radar-notes-cell">
                                    <textarea class="radar-notes-textarea" data-client="elgin" placeholder="Add notes...">• Indicated project coming up
• Hasn't paid - need to understand if getting feedback
• Check if they have submitted
• Contact: TBC</textarea>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <div class="client-name">Pacific Blue</div>
                                    <div class="client-type">Developer</div>
                                </td>
                                <td class="quarter-cell">
                                    <div class="pulse-container">
                                        <div class="pulse-dot bess" title="BESS"></div>
                                        <div class="pulse-dot bess" title="BESS"></div>
                                    </div>
                                </td>
                                <td class="radar-notes-cell">
                                    <textarea class="radar-notes-textarea" data-client="pacific_blue" placeholder="Add notes...">• 2x BESS projects prospected
• Discussed in weekly meeting
• Encourage ongoing conversation
• Contact: Daniel Choi</textarea>
                                </td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="radar-save-row">
                        <span class="radar-save-status" id="radarSaveStatus"></span>
                        <button class="radar-save-btn primary" onclick="saveRadarNotes()">Save Notes</button>
                    </div>

                    <div class="radar-legend">
                        <div class="legend-item">
                            <span class="legend-dot bess"></span>
                            <span>BESS</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-dot solar"></span>
                            <span>Solar</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-dot wind"></span>
                            <span>Wind</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-dot grid"></span>
                            <span>Grid Connection</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stakeholders Tab Content -->
        <div class="tab-content" id="tab-stakeholders">
            <div class="stakeholder-container">
                <div class="stakeholder-header">
                    <h2>
                        <span class="pulse-dot-header"></span>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                            <circle cx="9" cy="7" r="4"/>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                        </svg>
                        Key Relationships
                        <span style="font-size: 12px; font-weight: 400; color: var(--text-muted); margin-left: 12px;">Who to connect with, how, and why</span>
                    </h2>
                    <div class="stakeholder-filters">
                        <select id="stakeholderFilter" onchange="renderStakeholders()">
                            <option value="all">All Contacts</option>
                            <option value="hot">Hot Prospects</option>
                            <option value="needsMeeting">Needs Outreach</option>
                            <option value="scheduled">Meeting Booked</option>
                            <option value="active">Active Projects</option>
                            <option value="high">High Priority</option>
                        </select>
                        <select id="stakeholderSort" onchange="renderStakeholders()">
                            <option value="priority">Sort: Priority</option>
                            <option value="name">Sort: Company</option>
                            <option value="meeting">Sort: Status</option>
                        </select>
                    </div>
                </div>
                <div class="stakeholder-grid" style="max-height: calc(100vh - 280px); overflow: auto;">
                    <table class="stakeholder-table">
                        <thead>
                            <tr>
                                <th style="width: 70px;" onclick="sortStakeholderTable('priority')">
                                    <div class="th-filter">Priority <svg class="filter-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg></div>
                                </th>
                                <th style="width: 100px;" onclick="sortStakeholderTable('status')">
                                    <div class="th-filter">Status <svg class="filter-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg></div>
                                </th>
                                <th style="min-width: 140px;" onclick="sortStakeholderTable('name')">
                                    <div class="th-filter">Company <svg class="filter-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg></div>
                                </th>
                                <th style="min-width: 140px;" onclick="sortStakeholderTable('type')">
                                    <div class="th-filter">Type <svg class="filter-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg></div>
                                </th>
                                <th style="min-width: 320px;">Key Contacts</th>
                                <th style="min-width: 140px;">Reach Out Via</th>
                                <th style="min-width: 200px;">Purpose / Opportunity</th>
                                <th style="width: 130px;" onclick="sortStakeholderTable('nextAction')">
                                    <div class="th-filter">Meeting Date <svg class="filter-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg></div>
                                </th>
                                <th style="min-width: 120px;" onclick="sortStakeholderTable('activeProjects')">
                                    <div class="th-filter">Active Projects <svg class="filter-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg></div>
                                </th>
                                <th style="min-width: 120px;" onclick="sortStakeholderTable('previousProjects')">
                                    <div class="th-filter">Previous Projects <svg class="filter-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg></div>
                                </th>
                                <th style="min-width: 100px;">
                                    <div class="th-filter">Vysus PM</div>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="stakeholderTableBody">
                            <!-- Populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
                <div class="stakeholder-summary" id="stakeholderSummary">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Calendar Tab Content -->
        <div class="tab-content" id="tab-calendar">
            <div class="calendar-container">
                <div class="calendar-header-panel">
                    <h2 style="color: var(--accent); font-size: 20px; display: flex; align-items: center; gap: 10px;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 24px; height: 24px;">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                            <line x1="16" y1="2" x2="16" y2="6"/>
                            <line x1="8" y1="2" x2="8" y2="6"/>
                            <line x1="3" y1="10" x2="21" y2="10"/>
                        </svg>
                        Stakeholder Meeting Calendar
                    </h2>
                    <p style="color: var(--text-secondary); font-size: 13px; margin-top: 4px;">Schedule meetings with stakeholders for January/February 2025</p>
                </div>
                <div class="calendar-nav-panel" style="display: flex; justify-content: space-between; align-items: center; margin: 20px 0;">
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-secondary" onclick="changeCalendarMonth(-1)">◀ Prev</button>
                        <button class="btn btn-secondary" onclick="changeCalendarMonth(1)">Next ▶</button>
                    </div>
                    <h3 id="calendarMonthTitle" style="font-size: 18px; color: var(--text-primary);"></h3>
                    <button class="btn btn-primary" onclick="addMeeting()">+ Schedule Meeting</button>
                </div>
                <div class="calendar-grid-container" id="calendarGrid">
                    <!-- Populated by JavaScript -->
                </div>
                <div class="upcoming-meetings" style="margin-top: 24px;">
                    <h3 style="font-size: 16px; color: var(--accent); margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px;">
                            <circle cx="12" cy="12" r="10"/>
                            <polyline points="12,6 12,12 16,14"/>
                        </svg>
                        Upcoming Stakeholder Meetings
                    </h3>
                    <div id="upcomingMeetingsList">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Communications Tab - Email Activity & Follow-ups -->
        <div class="tab-content" id="tab-comms">
            <div class="comms-container" style="padding: 20px; max-width: 1600px; margin: 0 auto;">
                <!-- Header -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <div>
                        <h2 style="color: var(--accent); margin: 0; font-size: 24px; display: flex; align-items: center; gap: 10px;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 24px; height: 24px;">
                                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                                <polyline points="22,6 12,13 2,6"/>
                            </svg>
                            Client Communications
                        </h2>
                        <p style="color: var(--text-muted); margin: 4px 0 0 0;">Track email activity and follow-up schedule</p>
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-secondary" onclick="refreshCommsData()">Refresh</button>
                        <select id="commsClientFilter" onchange="filterComms()" style="background: var(--bg-input); border: 1px solid var(--border); color: var(--text-primary); padding: 8px 16px; border-radius: 6px;">
                            <option value="all">All Clients</option>
                            <option value="OX2">OX2</option>
                            <option value="Alinta">Alinta</option>
                            <option value="ElectraNet">ElectraNet</option>
                            <option value="Powerlink">Powerlink</option>
                            <option value="Transgrid">Transgrid</option>
                            <option value="Hallett">Hallett</option>
                            <option value="AEMO">AEMO</option>
                            <option value="Fortescue">Fortescue</option>
                        </select>
                    </div>
                </div>

                <!-- Horizontal Activity Timeline -->
                <div class="comms-timeline-section" style="background: var(--bg-card); border-radius: 16px; padding: 24px; margin-bottom: 24px; border: 1px solid var(--border);">
                    <h3 style="color: var(--accent); font-size: 16px; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px;">
                            <circle cx="12" cy="12" r="10"/>
                            <polyline points="12,6 12,12 16,14"/>
                        </svg>
                        Activity Timeline - Last 14 Days
                    </h3>
                    <div class="horizontal-timeline" id="activityTimeline" style="display: flex; gap: 4px; overflow-x: auto; padding: 16px 0;">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <!-- Follow-up Schedule - Horizontal Calendar -->
                <div class="followup-schedule" style="background: var(--bg-card); border-radius: 16px; padding: 24px; margin-bottom: 24px; border: 1px solid var(--border);">
                    <h3 style="color: var(--warning); font-size: 16px; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px;">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                            <polyline points="22 4 12 14.01 9 11.01"/>
                        </svg>
                        Follow-up Schedule - Next 14 Days
                    </h3>
                    <div class="followup-timeline" id="followupTimeline" style="display: flex; gap: 4px; overflow-x: auto; padding: 12px 8px; background: var(--bg-secondary); border-radius: 12px;">
                        <!-- 14 day forward view populated by JS -->
                    </div>
                    <div id="followupList" style="margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 12px;">
                        <!-- Follow-up cards populated by JS -->
                    </div>
                </div>

                <!-- Recent Communications Table -->
                <div class="comms-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                    <!-- Sent Emails -->
                    <div style="background: var(--bg-card); border-radius: 16px; padding: 24px; border: 1px solid var(--border);">
                        <h3 style="color: #17bf63; font-size: 16px; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px;">
                                <line x1="22" y1="2" x2="11" y2="13"/>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                            </svg>
                            Sent to Clients
                        </h3>
                        <div id="sentEmailsList" style="max-height: 400px; overflow-y: auto;">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>

                    <!-- Received Emails -->
                    <div style="background: var(--bg-card); border-radius: 16px; padding: 24px; border: 1px solid var(--border);">
                        <h3 style="color: #45b7d1; font-size: 16px; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px;">
                                <polyline points="22 12 16 12 14 15 10 15 8 12 2 12"/>
                                <path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/>
                            </svg>
                            Received from Clients
                        </h3>
                        <div id="receivedEmailsList" style="max-height: 400px; overflow-y: auto;">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Client Summary Cards -->
                <div style="margin-top: 24px;">
                    <h3 style="color: var(--text-primary); font-size: 16px; margin-bottom: 16px;">Client Activity Summary</h3>
                    <div id="clientSummaryCards" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 12px;">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Research Tab - Market Intelligence & Opportunities -->
        <div class="tab-content" id="tab-research">
            <div class="research-container" style="padding: 20px; max-width: 1600px; margin: 0 auto;">
                <!-- Header -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <div>
                        <h2 style="color: var(--accent); margin: 0; font-size: 24px; display: flex; align-items: center; gap: 10px;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 24px; height: 24px;">
                                <circle cx="11" cy="11" r="8"/>
                                <path d="M21 21l-4.35-4.35"/>
                            </svg>
                            Market Research & Opportunities
                        </h2>
                        <p style="color: var(--text-muted); margin: 4px 0 0 0;">Intelligence on government schemes, tenders and client opportunities</p>
                    </div>
                    <span style="font-size: 11px; color: var(--text-muted);">Last updated: 7 Jan 2026</span>
                </div>

                <!-- CIS Tender 8 Section -->
                <div style="background: linear-gradient(135deg, rgba(0, 212, 170, 0.1), rgba(0, 212, 170, 0.02)); border: 1px solid var(--accent); border-radius: 12px; padding: 24px; margin-bottom: 24px;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                        <span style="background: var(--accent); color: var(--bg-primary); padding: 4px 12px; border-radius: 4px; font-size: 11px; font-weight: 600; text-transform: uppercase;">Active Tender</span>
                        <h3 style="color: var(--text-primary); margin: 0; font-size: 20px;">Capacity Investment Scheme - Tender 8</h3>
                    </div>

                    <p style="color: var(--text-secondary); line-height: 1.6; margin-bottom: 20px;">
                        The CIS is the Australian Government's flagship renewable energy investment program, providing revenue underwriting for renewable energy and storage projects. Tender 8 specifically targets <strong style="color: var(--accent);">16 GWh of dispatchable energy storage</strong> in the NEM.
                    </p>

                    <!-- Key Dates -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px;">
                        <div style="background: rgba(245, 166, 35, 0.15); border: 1px solid rgba(245, 166, 35, 0.4); border-radius: 8px; padding: 16px;">
                            <div style="color: #f5a623; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px;">Registration Closes</div>
                            <div style="color: var(--text-primary); font-size: 18px; font-weight: 600;">23 January 2026</div>
                        </div>
                        <div style="background: rgba(224, 36, 94, 0.15); border: 1px solid rgba(224, 36, 94, 0.4); border-radius: 8px; padding: 16px;">
                            <div style="color: #e0245e; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px;">Bids Due</div>
                            <div style="color: var(--text-primary); font-size: 18px; font-weight: 600;">6 February 2026</div>
                        </div>
                        <div style="background: rgba(0, 212, 170, 0.15); border: 1px solid var(--accent); border-radius: 8px; padding: 16px;">
                            <div style="color: var(--accent); font-size: 11px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px;">Results Expected</div>
                            <div style="color: var(--text-primary); font-size: 18px; font-weight: 600;">Mid-2026</div>
                        </div>
                    </div>

                    <!-- Requirements -->
                    <div style="background: var(--bg-secondary); border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                        <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 12px;">Tender 8 Requirements</div>
                        <ul style="color: var(--text-secondary); margin: 0; padding-left: 20px; line-height: 1.8;">
                            <li>Minimum 4-hour storage duration</li>
                            <li>Eligible: BESS, pumped hydro, compressed air storage</li>
                            <li>Aggregate projects now eligible (5-30MW each)</li>
                            <li>Single-stage tender process</li>
                            <li>Standalone storage only (no hybrids)</li>
                        </ul>
                    </div>

                    <a href="https://asl.org.au/tenders/cis-tender-8-nem-dispatchable" target="_blank" style="color: var(--accent); font-size: 13px;">View official tender details →</a>
                </div>

                <!-- Vysus Opportunity Section -->
                <div style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; padding: 24px; margin-bottom: 24px;">
                    <h3 style="color: var(--accent); margin: 0 0 16px 0; font-size: 18px;">💡 Vysus Opportunity</h3>
                    <p style="color: var(--text-secondary); line-height: 1.6; margin-bottom: 16px;">
                        Projects winning CIS contracts get revenue certainty, making them more likely to proceed to construction. This drives demand for:
                    </p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px;">
                        <div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 16px;">
                            <div style="color: var(--accent); font-weight: 600; margin-bottom: 8px;">Grid Connection Studies</div>
                            <div style="color: var(--text-muted); font-size: 13px;">GPS compliance, power system modelling, AEMO/NSP liaison</div>
                        </div>
                        <div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 16px;">
                            <div style="color: var(--accent); font-weight: 600; margin-bottom: 8px;">Technical Due Diligence</div>
                            <div style="color: var(--text-muted); font-size: 13px;">Investor support, technology assessment, risk analysis</div>
                        </div>
                        <div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 16px;">
                            <div style="color: var(--accent); font-weight: 600; margin-bottom: 8px;">Owner's Engineering</div>
                            <div style="color: var(--text-muted); font-size: 13px;">EPC oversight, commissioning support, testing</div>
                        </div>
                    </div>
                </div>

                <!-- CIS Tender 3 Winners Section -->
                <div style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; padding: 24px; margin-bottom: 24px;">
                    <h3 style="color: var(--text-primary); margin: 0 0 16px 0; font-size: 18px;">Previous CIS Winners - Potential Clients</h3>
                    <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 16px;">Tender 3 awarded 4.13GW / 15.7GWh across 16 BESS projects. These companies are actively developing projects:</p>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px;">
                        <!-- NSW Projects -->
                        <div style="background: var(--bg-card); border-radius: 8px; padding: 16px;">
                            <div style="font-weight: 600; color: #4a9eff; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                <span style="width: 8px; height: 8px; background: #4a9eff; border-radius: 50%;"></span>
                                New South Wales (5 projects)
                            </div>
                            <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.8;">
                                <div><strong>AMPYR Australia</strong> - Bulabul 2 BESS (406 MWh), Swallow Tail (1,218 MWh)</div>
                                <div><strong>Equis</strong> - Calala BESS (300 MWh)</div>
                                <div><strong>Lightsource BP</strong> - Goulburn River BESS (1,370 MWh)</div>
                                <div><strong>EnergyAustralia</strong> - Mount Piper Stage 1 (1,000 MWh)</div>
                            </div>
                        </div>

                        <!-- VIC Projects -->
                        <div style="background: var(--bg-card); border-radius: 8px; padding: 16px;">
                            <div style="font-weight: 600; color: #9b59b6; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                <span style="width: 8px; height: 8px; background: #9b59b6; border-radius: 50%;"></span>
                                Victoria (5 projects)
                            </div>
                            <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.8;">
                                <div><strong>Akaysha Energy</strong> - Deer Park BESS (1,100 MWh)</div>
                                <div><strong>ACEnergy</strong> - Joel Joel (1,000 MWh), Little River (1,400 MWh)</div>
                                <div><strong>TotalEnergies</strong> - Kiamal BESS (810 MWh)</div>
                                <div><strong>Valent Energy</strong> - Mornington BESS (587 MWh)</div>
                            </div>
                        </div>

                        <!-- QLD Projects -->
                        <div style="background: var(--bg-card); border-radius: 8px; padding: 16px;">
                            <div style="font-weight: 600; color: #e74c3c; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                <span style="width: 8px; height: 8px; background: #e74c3c; border-radius: 50%;"></span>
                                Queensland (4 projects)
                            </div>
                            <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.8;">
                                <div><strong>Potentia Energy</strong> - Capricorn BESS (1,200 MWh)</div>
                                <div><strong>Atmos Renewables</strong> - Teebar BESS</div>
                                <div><strong>EDP</strong> - Punch's Creek (1,600 MWh)</div>
                            </div>
                        </div>

                        <!-- SA Projects -->
                        <div style="background: var(--bg-card); border-radius: 8px; padding: 16px;">
                            <div style="font-weight: 600; color: #f39c12; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                <span style="width: 8px; height: 8px; background: #f39c12; border-radius: 50%;"></span>
                                South Australia (2 projects)
                            </div>
                            <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.8;">
                                <div><strong>Alinta Energy</strong> - Reeves Plains BESS (1,000 MWh)</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Key Developers to Target with Contacts -->
                <div style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; padding: 24px; margin-bottom: 24px;">
                    <h3 style="color: var(--text-primary); margin: 0 0 16px 0; font-size: 18px;">🎯 Priority Targets for Outreach</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 16px;">

                        <!-- Akaysha Energy -->
                        <div style="background: var(--bg-card); border: 1px solid var(--accent); border-radius: 8px; padding: 16px;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                <div style="font-weight: 700; color: var(--text-primary); font-size: 16px;">Akaysha Energy</div>
                                <span style="background: var(--accent); color: var(--bg-primary); padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600;">1.88 GWh</span>
                            </div>
                            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 12px;">Deer Park BESS (VIC) - BlackRock owned</div>
                            <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.8;">
                                <div><strong>Nick Carter</strong> - CEO</div>
                                <div style="color: var(--text-muted); font-size: 11px;">Ex-Tesla, Macquarie Capital, AGL</div>
                                <div><a href="https://au.linkedin.com/in/nick-carter-a4793914" target="_blank" style="color: var(--accent); font-size: 11px;">LinkedIn</a></div>
                                <div style="margin-top: 8px;"><strong>Tony Fullelove</strong> - MD Development & Delivery</div>
                                <div style="margin-top: 8px;"><strong>Richard Reynolds</strong> - GM Construction</div>
                            </div>
                        </div>

                        <!-- ACEnergy -->
                        <div style="background: var(--bg-card); border: 1px solid var(--accent); border-radius: 8px; padding: 16px;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                <div style="font-weight: 700; color: var(--text-primary); font-size: 16px;">ACEnergy</div>
                                <span style="background: var(--accent); color: var(--bg-primary); padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600;">2.4 GWh</span>
                            </div>
                            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 12px;">Joel Joel + Little River BESS (VIC) - CATL partnership</div>
                            <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.8;">
                                <div><strong>Raymond Wang</strong> - Managing Director</div>
                                <div style="color: var(--text-muted); font-size: 11px;">Founder, 1.5GW solar/BESS delivered</div>
                                <div style="margin-top: 8px;"><strong>Joel Prata</strong> - Head of Grid</div>
                                <div style="color: var(--text-muted); font-size: 11px;">20 yrs power systems, GPS/connections</div>
                                <div style="margin-top: 8px;"><strong>Danny Wilkinson</strong> - Head of Development</div>
                                <div><a href="https://acenergy.com.au/our-people/" target="_blank" style="color: var(--accent); font-size: 11px;">Team Page</a> | <a href="mailto:info@joeljoelbess.com.au" style="color: var(--accent); font-size: 11px;">info@joeljoelbess.com.au</a></div>
                            </div>
                        </div>

                        <!-- Lightsource BP -->
                        <div style="background: var(--bg-card); border: 1px solid var(--accent); border-radius: 8px; padding: 16px;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                <div style="font-weight: 700; color: var(--text-primary); font-size: 16px;">Lightsource BP</div>
                                <span style="background: var(--accent); color: var(--bg-primary); padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600;">1.37 GWh</span>
                            </div>
                            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 12px;">Goulburn River BESS (NSW) - 7.5GW pipeline</div>
                            <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.8;">
                                <div><strong>Adam Pegg</strong> - COO APAC</div>
                                <div style="color: var(--text-muted); font-size: 11px;">Ex-APA Group, 20 yrs renewables/gas</div>
                                <div><a href="https://au.linkedin.com/in/adam-pegg-5ab44294" target="_blank" style="color: var(--accent); font-size: 11px;">LinkedIn</a> | <a href="https://lightsourcebp.com/leadership-team/adam-pegg/" target="_blank" style="color: var(--accent); font-size: 11px;">Bio</a></div>
                                <div style="margin-top: 8px;"><a href="mailto:goulburnproject@lightsourcebp.com" style="color: var(--accent); font-size: 11px;">goulburnproject@lightsourcebp.com</a></div>
                                <div style="color: var(--text-muted); font-size: 11px;">Phone: 1800 570 663</div>
                            </div>
                        </div>

                        <!-- EnergyAustralia -->
                        <div style="background: var(--bg-card); border: 1px solid var(--accent); border-radius: 8px; padding: 16px;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                <div style="font-weight: 700; color: var(--text-primary); font-size: 16px;">EnergyAustralia</div>
                                <span style="background: var(--accent); color: var(--bg-primary); padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600;">1 GWh</span>
                            </div>
                            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 12px;">Mt Piper BESS (NSW) - CIS Tender 3 winner</div>
                            <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.8;">
                                <div><strong>Daniel Nugent</strong> - Head of Portfolio Development</div>
                                <div style="color: var(--text-muted); font-size: 11px;">Led Ballarat, Gannawarra, Kidston projects</div>
                                <div><a href="https://au.linkedin.com/in/daniel-nugent-297ba173" target="_blank" style="color: var(--accent); font-size: 11px;">LinkedIn</a></div>
                                <div style="margin-top: 8px;"><a href="mailto:community@EnergyAustralia.com.au" style="color: var(--accent); font-size: 11px;">community@EnergyAustralia.com.au</a></div>
                                <div style="color: var(--text-muted); font-size: 11px;">Media: 03 9060 0079</div>
                            </div>
                        </div>

                        <!-- AMPYR Australia -->
                        <div style="background: var(--bg-card); border: 1px solid var(--accent); border-radius: 8px; padding: 16px;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                <div style="font-weight: 700; color: var(--text-primary); font-size: 16px;">AMPYR Australia</div>
                                <span style="background: var(--accent); color: var(--bg-primary); padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600;">1.6 GWh</span>
                            </div>
                            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 12px;">Bulabul 2 + Swallow Tail BESS (NSW) - AGP Group</div>
                            <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.8;">
                                <div><strong>Alex Wonhas</strong> - CEO (Global)</div>
                                <div style="color: var(--text-muted); font-size: 11px;">12GW portfolio across 7 countries</div>
                                <div style="margin-top: 8px;"><a href="mailto:australia@ampyrenergy.com" style="color: var(--accent); font-size: 11px;">australia@ampyrenergy.com</a></div>
                                <div style="color: var(--text-muted); font-size: 11px;">Level 17, 167 Macquarie St, Sydney</div>
                                <div style="color: var(--text-muted); font-size: 11px;">Phone: +61 2 8077 4058</div>
                            </div>
                        </div>

                        <!-- Alinta Energy -->
                        <div style="background: var(--bg-card); border: 1px solid rgba(23, 191, 99, 0.5); border-radius: 8px; padding: 16px;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                <div style="font-weight: 700; color: var(--text-primary); font-size: 16px;">Alinta Energy</div>
                                <span style="background: #17bf63; color: var(--bg-primary); padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600;">EXISTING CLIENT</span>
                            </div>
                            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 12px;">Reeves Plains BESS (SA) - 1 GWh</div>
                            <div style="font-size: 13px; color: #17bf63; line-height: 1.8;">
                                Already working with Vysus on Mt Challenger project. Leverage existing relationship for Reeves Plains BESS.
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Outreach Email Template -->
                <div style="background: var(--bg-secondary); border: 1px solid var(--warning); border-radius: 12px; padding: 24px; margin-bottom: 24px;">
                    <h3 style="color: var(--warning); margin: 0 0 16px 0; font-size: 18px;">📧 Outreach Email Template</h3>
                    <div style="background: var(--bg-card); border-radius: 8px; padding: 20px; font-family: 'Segoe UI', sans-serif;">
                        <div style="color: var(--text-muted); font-size: 12px; margin-bottom: 8px;">Subject:</div>
                        <div style="color: var(--text-primary); font-size: 14px; margin-bottom: 16px; font-weight: 500;">Vysus Group - Grid Connection & Technical Advisory Services</div>

                        <div style="color: var(--text-secondary); font-size: 13px; line-height: 1.8;">
                            <p>Dear [NAME],</p>

                            <p>I wanted to introduce Vysus Group - we're a specialist engineering consultancy supporting renewable energy developers with grid connection studies and technical advisory services across Australia.</p>

                            <p>Are you currently looking for support on any grid connection projects? Our team has deep experience with AEMO and NSP connection processes, GPS compliance modelling, R0/R1/R2 studies, and the specific challenges of integrating wind, solar and battery storage into the NEM.</p>

                            <p>Our Australia-based grid connection team includes:</p>

                            <table style="width: 100%; border-collapse: collapse; margin: 12px 0; font-size: 12px;">
                                <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                                    <td style="padding: 8px 0;"><strong>Dr. Anthony Morton</strong></td>
                                    <td style="color: var(--text-muted);">Global Technical Head</td>
                                    <td><a href="mailto:tony.morton@vysusgroup.com" style="color: var(--accent);">tony.morton@vysusgroup.com</a></td>
                                </tr>
                                <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                                    <td style="padding: 8px 0;"><strong>Naveen Rajagopal</strong></td>
                                    <td style="color: var(--text-muted);">Principal Engineer</td>
                                    <td><a href="mailto:Naveenkumar.Rajagopal@vysusgroup.com" style="color: var(--accent);">Naveenkumar.Rajagopal@vysusgroup.com</a></td>
                                </tr>
                                <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                                    <td style="padding: 8px 0;"><strong>Dr. Ajith Tennakoon</strong></td>
                                    <td style="color: var(--text-muted);">Lead Power Systems Engineer</td>
                                    <td><a href="mailto:ajith.tennakoon@vysusgroup.com" style="color: var(--accent);">ajith.tennakoon@vysusgroup.com</a></td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px 0;"><strong>Dr. Momtaz Rahman</strong></td>
                                    <td style="color: var(--text-muted);">Lead Engineer</td>
                                    <td><a href="mailto:md.momtazur.rahman@vysusgroup.com" style="color: var(--accent);">md.momtazur.rahman@vysusgroup.com</a></td>
                                </tr>
                            </table>

                            <p>Our capability statement provides more detail on our services and experience: <a href="https://vysus-capability.netlify.app" style="color: var(--accent);">vysus-capability.netlify.app</a></p>

                            <p>Would you have time for a brief call to discuss your upcoming projects?</p>

                            <p style="margin-top: 16px;">
                                Kind regards,<br>
                                <strong>Chris Marinelli</strong><br>
                                <span style="color: var(--text-muted);">Vice President - Power and Energy Systems</span><br>
                                <span style="color: var(--text-muted);">Vysus Group</span><br>
                                <span style="color: var(--accent);">chris.marinelli@vysusgroup.com</span> · <span style="color: var(--text-muted);">0417 035 368</span>
                            </p>
                        </div>
                    </div>
                    <div style="margin-top: 12px; font-size: 11px; color: var(--text-muted);">
                        Customise [NAME] for each recipient.
                    </div>
                </div>

                <!-- Sources -->
                <div style="background: var(--bg-card); border-radius: 8px; padding: 16px;">
                    <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Sources</div>
                    <div style="font-size: 12px; color: var(--text-secondary); line-height: 1.8;">
                        <a href="https://www.dcceew.gov.au/energy/renewable/capacity-investment-scheme" target="_blank" style="color: var(--accent);">DCCEEW - Capacity Investment Scheme</a> ·
                        <a href="https://asl.org.au/tenders/cis-tender-8-nem-dispatchable" target="_blank" style="color: var(--accent);">AEMO Services - Tender 8</a> ·
                        <a href="https://www.energy-storage.news/over-15gwh-of-energy-storage-successful-in-australias-capacity-investment-scheme-tender-3/" target="_blank" style="color: var(--accent);">Energy Storage News - Tender 3 Results</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contacts Tab - Client Contact Directory -->
        <div class="tab-content" id="tab-contacts">
            <div style="padding: 20px; max-width: 1400px; margin: 0 auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div>
                        <h2 style="color: var(--accent); margin: 0; font-size: 24px;">Client Contacts</h2>
                        <p style="color: var(--text-muted); margin: 4px 0 0 0;">Directory of key contacts by client</p>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="text" id="contactSearchInput" placeholder="Search contacts..."
                            style="padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-card); color: var(--text-primary); width: 200px;"
                            oninput="filterContacts()">
                        <select id="contactTypeFilter" onchange="filterContacts()" style="padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-card); color: var(--text-primary);">
                            <option value="all">All Types</option>
                            <option value="Developer">Developers</option>
                            <option value="NSP">NSPs</option>
                            <option value="OEM">OEMs</option>
                            <option value="EPC">EPCs</option>
                            <option value="AEMO">AEMO</option>
                            <option value="Investor">Investors</option>
                        </select>
                    </div>
                </div>

                <div id="contactsTableContainer" style="background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border); overflow: hidden;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--bg-secondary); border-bottom: 1px solid var(--border);">
                                <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: var(--text-secondary); font-size: 12px; text-transform: uppercase;">Emailed</th>
                                <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: var(--text-secondary); font-size: 12px; text-transform: uppercase;">Name</th>
                                <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: var(--text-secondary); font-size: 12px; text-transform: uppercase;">Company</th>
                                <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: var(--text-secondary); font-size: 12px; text-transform: uppercase;">Type</th>
                                <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: var(--text-secondary); font-size: 12px; text-transform: uppercase;">Role</th>
                                <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: var(--text-secondary); font-size: 12px; text-transform: uppercase;">Active Projects</th>
                                <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: var(--text-secondary); font-size: 12px; text-transform: uppercase;">Email</th>
                                <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: var(--text-secondary); font-size: 12px; text-transform: uppercase;">Phone</th>
                            </tr>
                        </thead>
                        <tbody id="contactsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Drill Tab - Gamified Stakeholder Learning -->
        <div class="tab-content" id="tab-drill">
            <div class="drill-container" style="padding: 20px; max-width: 1400px; margin: 0 auto;">
                <!-- Header with score -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <div>
                        <h2 style="color: var(--accent); margin: 0; font-size: 24px;">Contact Drill</h2>
                        <p style="color: var(--text-muted); margin: 4px 0 0 0;">Learn your stakeholders by heart</p>
                    </div>
                    <div style="display: flex; gap: 16px; align-items: center;">
                        <div style="background: var(--bg-card); padding: 12px 20px; border-radius: 12px; border: 1px solid var(--border);">
                            <span style="color: var(--text-muted); font-size: 12px;">SCORE</span>
                            <div id="drillScore" style="color: var(--accent); font-size: 28px; font-weight: 700;">0</div>
                        </div>
                        <div style="background: var(--bg-card); padding: 12px 20px; border-radius: 12px; border: 1px solid var(--border);">
                            <span style="color: var(--text-muted); font-size: 12px;">STREAK</span>
                            <div id="drillStreak" style="color: #17bf63; font-size: 28px; font-weight: 700;">0</div>
                        </div>
                        <div style="background: var(--bg-card); padding: 12px 20px; border-radius: 12px; border: 1px solid var(--border);">
                            <span style="color: var(--text-muted); font-size: 12px;">MASTERED</span>
                            <div id="drillMastered" style="color: #BB8FCE; font-size: 28px; font-weight: 700;">0/<span id="drillTotal">0</span></div>
                        </div>
                    </div>
                </div>

                <!-- Mode selector -->
                <div style="display: flex; gap: 8px; margin-bottom: 24px;">
                    <button class="btn btn-primary drill-mode-btn active" onclick="setDrillMode('cards')">Contact Cards</button>
                    <button class="btn btn-secondary drill-mode-btn" onclick="setDrillMode('quiz')">Quiz Mode</button>
                    <button class="btn btn-secondary drill-mode-btn" onclick="setDrillMode('match')">Match Game</button>
                    <button class="btn btn-secondary drill-mode-btn" onclick="setDrillMode('rapid')">Rapid Fire</button>
                    <div style="margin-left: auto;">
                        <button class="btn btn-secondary" onclick="resetDrillProgress()">Reset Progress</button>
                    </div>
                </div>

                <!-- Cards Mode - Browse all contacts -->
                <div id="drill-cards" class="drill-mode-content">
                    <div style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap;">
                        <button class="drill-filter-btn active" onclick="filterDrillCards('all')">All</button>
                        <button class="drill-filter-btn" onclick="filterDrillCards('hot')">Hot Prospects</button>
                        <button class="drill-filter-btn" onclick="filterDrillCards('Developer')">Developers</button>
                        <button class="drill-filter-btn" onclick="filterDrillCards('OEM')">OEMs</button>
                        <button class="drill-filter-btn" onclick="filterDrillCards('NSP')">NSPs</button>
                        <button class="drill-filter-btn" onclick="filterDrillCards('EPC')">EPCs</button>
                        <button class="drill-filter-btn" onclick="filterDrillCards('AEMO')">AEMO</button>
                    </div>
                    <div id="drill-cards-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 16px;">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Quiz Mode -->
                <div id="drill-quiz" class="drill-mode-content" style="display: none;">
                    <div style="max-width: 600px; margin: 0 auto; text-align: center;">
                        <div id="quiz-question" style="background: var(--bg-card); padding: 32px; border-radius: 16px; margin-bottom: 24px; border: 2px solid var(--border);">
                            <div style="color: var(--text-muted); font-size: 12px; margin-bottom: 8px;">QUESTION <span id="quiz-num">1</span></div>
                            <div id="quiz-prompt" style="font-size: 20px; color: var(--text-primary); margin-bottom: 24px;">Loading...</div>
                            <div id="quiz-options" style="display: grid; gap: 12px;">
                                <!-- Options populated by JS -->
                            </div>
                        </div>
                        <div id="quiz-feedback" style="display: none; padding: 16px; border-radius: 12px; margin-bottom: 16px;"></div>
                        <button id="quiz-next-btn" class="btn btn-primary" onclick="nextQuizQuestion()" style="display: none;">Next Question</button>
                    </div>
                </div>

                <!-- Match Game -->
                <div id="drill-match" class="drill-mode-content" style="display: none;">
                    <div style="text-align: center; margin-bottom: 24px;">
                        <p style="color: var(--text-muted);">Match the contact to their company. Click pairs to match them.</p>
                        <div style="display: flex; gap: 16px; justify-content: center;">
                            <span>Time: <strong id="match-timer">0:00</strong></span>
                            <span>Matches: <strong id="match-count">0</strong>/<strong id="match-total">0</strong></span>
                        </div>
                    </div>
                    <div id="match-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; max-width: 800px; margin: 0 auto;">
                        <!-- Match cards populated by JS -->
                    </div>
                </div>

                <!-- Rapid Fire -->
                <div id="drill-rapid" class="drill-mode-content" style="display: none;">
                    <div style="max-width: 600px; margin: 0 auto; text-align: center;">
                        <div style="margin-bottom: 24px;">
                            <div style="font-size: 48px; color: var(--accent); font-weight: 700;" id="rapid-timer">30</div>
                            <div style="color: var(--text-muted);">seconds remaining</div>
                        </div>
                        <div id="rapid-card" style="background: var(--bg-card); padding: 32px; border-radius: 16px; margin-bottom: 24px; border: 2px solid var(--border); min-height: 200px;">
                            <div id="rapid-prompt" style="font-size: 24px; color: var(--text-primary); margin-bottom: 24px;">Click Start to begin!</div>
                            <input type="text" id="rapid-input" placeholder="Type answer and press Enter..." style="width: 100%; padding: 16px; font-size: 18px; background: var(--bg-input); border: 2px solid var(--border); border-radius: 8px; color: var(--text-primary); text-align: center;" disabled>
                        </div>
                        <div style="display: flex; gap: 12px; justify-content: center;">
                            <button id="rapid-start-btn" class="btn btn-primary" onclick="startRapidFire()">Start Rapid Fire</button>
                            <div id="rapid-score-display" style="display: none; background: var(--bg-card); padding: 12px 24px; border-radius: 8px;">
                                Correct: <strong id="rapid-correct" style="color: #17bf63;">0</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Industry Map Tab -->
        <div class="tab-content" id="tab-map">
            <div class="map-container" style="padding: 20px;">
                <div class="map-header" style="margin-bottom: 24px; display: flex; justify-content: space-between; align-items: flex-start;">
                    <div>
                        <h2 style="color: var(--accent); font-size: 20px; display: flex; align-items: center; gap: 10px;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 24px; height: 24px;">
                                <circle cx="12" cy="12" r="3"/><path d="M12 2v4m0 12v4m10-10h-4M6 12H2m15.5-6.5l-2.8 2.8m-5.4 5.4l-2.8 2.8m0-11l2.8 2.8m5.4 5.4l2.8 2.8"/>
                            </svg>
                            Australian Renewables Industry Map
                        </h2>
                        <p style="color: var(--text-secondary); font-size: 13px; margin-top: 4px;">How grid connection projects flow through the ecosystem - hover over names for contact details</p>
                    </div>
                    <!-- Key Dates Panel -->
                    <div style="background: var(--bg-secondary); border: 1px solid var(--warning); border-radius: 10px; padding: 12px 16px; font-size: 10px;">
                        <div style="font-weight: 700; color: var(--warning); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px;">Q1 2026 Key Dates</div>
                        <div style="display: flex; flex-direction: column; gap: 4px; color: var(--text-secondary);">
                            <div><strong style="color: var(--text-primary);">Jan 23:</strong> CIS Tender 8 Registration Closes</div>
                            <div><strong style="color: var(--text-primary);">Feb 6:</strong> CIS Tender 8 Bids Due</div>
                            <div><strong style="color: var(--text-primary);">Feb 8-11:</strong> World Renewable Energy Congress (Perth)</div>
                            <div><strong style="color: var(--text-primary);">Mar 5:</strong> Smart Installer Roadshow (Melbourne)</div>
                            <div><strong style="color: var(--text-primary);">Mar 17-19:</strong> Energy Networks Conference (Adelaide)</div>
                        </div>
                    </div>
                </div>

                <!-- Industry Flow Diagram - Clean Grid Layout -->
                <div class="industry-map" style="background: var(--bg-card); border-radius: 16px; padding: 30px; border: 1px solid var(--border);">

                    <!-- Animated Project Flow Steps -->
                    <div style="display: flex; align-items: center; justify-content: center; gap: 6px; margin-bottom: 30px; padding: 16px; background: var(--bg-main); border-radius: 12px; border: 1px solid var(--border); flex-wrap: wrap;">
                        <span style="background: #BB8FCE; color: white; padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: 600;">1. Funding</span>
                        <span class="flow-indicator flow-money">$ →</span>
                        <span style="background: #45b7d1; color: white; padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: 600;">2. Development</span>
                        <span class="flow-indicator flow-data">📋 →</span>
                        <span style="background: #96CEB4; color: white; padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: 600;">3. Connection</span>
                        <span class="flow-indicator flow-contract">📑 →</span>
                        <span style="background: #f5a623; color: white; padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: 600;">4. Construction</span>
                        <span class="flow-indicator flow-approval">✓ →</span>
                        <span style="background: #e0245e; color: white; padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: 600;">5. R1/R2</span>
                        <span class="flow-indicator flow-support">⚡ →</span>
                        <span style="background: #00d4aa; color: white; padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: 600;">6. COD</span>
                    </div>

                    <!-- Main Grid Layout with Flow Arrows -->
                    <div style="display: grid; grid-template-columns: 1fr auto 2fr auto 1.5fr auto 1.5fr; gap: 12px; align-items: start;">

                        <!-- Column 1: Investors + OEMs -->
                        <div style="display: flex; flex-direction: column; gap: 20px;">
                            <!-- INVESTORS -->
                            <div style="background: linear-gradient(135deg, #BB8FCE15, #BB8FCE08); border: 2px solid #BB8FCE; border-radius: 12px; padding: 16px;">
                                <div style="font-weight: 700; color: #BB8FCE; font-size: 11px; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; gap: 6px;">
                                    <span style="width: 8px; height: 8px; background: #BB8FCE; border-radius: 2px;"></span>
                                    Investors
                                </div>
                                <div style="font-size: 11px; color: var(--text-primary); display: flex; flex-direction: column; gap: 6px;">
                                    <span class="map-contact" data-code="AQUILA">
                                        Aquila Capital
                                        <div class="map-contact-tooltip">
                                            <div style="font-weight: 600; color: var(--accent); margin-bottom: 6px;">Aquila Capital</div>
                                            <div style="color: var(--text-primary);">Damien Hegarty</div>
                                            <div style="color: var(--text-muted);">Investment Manager</div>
                                            <div style="color: #45b7d1; margin-top: 4px;">damien.hegarty@aquila-capital.com</div>
                                        </div>
                                    </span>
                                </div>
                                <div style="font-size: 9px; color: var(--text-muted); margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border);">Fund project development & FID support</div>
                            </div>

                            <!-- OEMs -->
                            <div style="background: linear-gradient(135deg, #DDA0DD15, #DDA0DD08); border: 2px solid #DDA0DD; border-radius: 12px; padding: 16px;">
                                <div style="font-weight: 700; color: #DDA0DD; font-size: 11px; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; gap: 6px;">
                                    <span style="width: 8px; height: 8px; background: #DDA0DD; border-radius: 2px;"></span>
                                    OEMs
                                </div>
                                <div style="font-size: 11px; color: var(--text-primary); display: flex; flex-direction: column; gap: 6px;">
                                    <span class="map-contact" data-code="GOLDWIND">
                                        Goldwind
                                        <div class="map-contact-tooltip">
                                            <div style="font-weight: 600; color: var(--accent); margin-bottom: 6px;">Goldwind Australia</div>
                                            <div style="color: var(--text-primary);">Andrew Bray</div>
                                            <div style="color: var(--text-muted);">Technical Director</div>
                                            <div style="color: #45b7d1; margin-top: 4px;">andrew.bray@goldwindaustralia.com</div>
                                        </div>
                                    </span>
                                    <span class="map-contact">
                                        Vestas
                                        <div class="map-contact-tooltip">
                                            <div style="font-weight: 600; color: var(--accent); margin-bottom: 6px;">Vestas</div>
                                            <div style="color: var(--text-primary);">Johan Laban</div>
                                            <div style="color: var(--text-muted);">Lead Electrical Engineer</div>
                                            <div style="color: #45b7d1; margin-top: 4px;">jolab@vestas.com</div>
                                            <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border);"></div>
                                            <div style="color: var(--text-primary);">Dr. Ragu Balanathan</div>
                                            <div style="color: var(--text-muted);">Global Head of Grid (Melbourne)</div>
                                        </div>
                                    </span>
                                    <span class="map-contact" data-code="SMA">
                                        SMA
                                        <div class="map-contact-tooltip">
                                            <div style="font-weight: 600; color: var(--accent); margin-bottom: 6px;">SMA Solar Technology</div>
                                            <div style="color: var(--text-primary);">Inverter OEM</div>
                                            <div style="color: var(--text-muted);">Solar & BESS inverters</div>
                                            <div style="color: #45b7d1; margin-top: 4px;">EMT/PSCAD model support</div>
                                        </div>
                                    </span>
                                    <span class="map-contact" data-code="SUNGROW">
                                        Sungrow
                                        <div class="map-contact-tooltip">
                                            <div style="font-weight: 600; color: var(--accent); margin-bottom: 6px;">Sungrow Power Supply</div>
                                            <div style="color: var(--text-primary);">Inverter OEM</div>
                                            <div style="color: var(--text-muted);">Solar & BESS inverters</div>
                                            <div style="color: #45b7d1; margin-top: 4px;">EMT/PSCAD model support</div>
                                        </div>
                                    </span>
                                    <span style="color: var(--text-muted);">Tesla</span>
                                </div>
                                <div style="font-size: 9px; color: var(--text-muted); margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border);">Equipment supply & R1 model support</div>
                            </div>
                        </div>

                        <!-- Flow Arrow 1 -->
                        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding-top: 60px;">
                            <div class="flow-indicator flow-money" style="writing-mode: horizontal-tb;">$</div>
                            <div style="height: 80px; width: 2px; background: linear-gradient(180deg, #BB8FCE, #45b7d1); margin: 8px 0;"></div>
                            <div style="color: var(--text-muted); font-size: 8px; text-align: center;">Funding<br>Flow</div>
                        </div>

                        <!-- Column 2: Developers (main column) -->
                        <div style="background: linear-gradient(135deg, #45b7d115, #45b7d108); border: 2px solid #45b7d1; border-radius: 12px; padding: 20px;">
                            <div style="font-weight: 700; color: #45b7d1; font-size: 11px; margin-bottom: 14px; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; gap: 6px;">
                                <span style="width: 8px; height: 8px; background: #45b7d1; border-radius: 2px;"></span>
                                Developers
                                <span style="margin-left: auto; font-size: 9px; color: var(--text-muted); font-weight: 400;">Need: R1 5.3.4a Letter for FID</span>
                            </div>
                            <div style="font-size: 11px; color: var(--text-primary); display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px 12px;">
                                <span class="map-contact" data-code="AGL">
                                    AGL
                                    <div class="map-contact-tooltip">
                                        <div style="font-weight: 600; color: var(--accent); margin-bottom: 6px;">AGL Energy</div>
                                        <div style="color: var(--text-primary);">Faisal Mohd</div>
                                        <div style="color: var(--text-muted);">Project Manager</div>
                                        <div style="color: #45b7d1; margin-top: 4px;">faisal.mohd@agl.com.au</div>
                                    </div>
                                </span>
                                <span class="map-contact" data-code="NEOEN">
                                    Neoen
                                    <div class="map-contact-tooltip">
                                        <div style="font-weight: 600; color: var(--accent); margin-bottom: 6px;">Neoen</div>
                                        <div style="color: var(--text-primary);">Daryl Attard</div>
                                        <div style="color: var(--text-muted);">Technical Manager</div>
                                        <div style="color: #45b7d1; margin-top: 4px;">daryl.attard@neoen.com</div>
                                    </div>
                                </span>
                                <span class="map-contact" data-code="ALINTA">
                                    Alinta
                                    <div class="map-contact-tooltip">
                                        <div style="font-weight: 600; color: var(--accent); margin-bottom: 6px;">Alinta Energy</div>
                                        <div style="color: var(--text-primary);">Cedric Banda</div>
                                        <div style="color: var(--text-muted);">Development Manager</div>
                                        <div style="color: #45b7d1; margin-top: 4px;">cedric.banda@alintaenergy.com.au</div>
                                        <div style="color: var(--success);">📱 0437 956 948</div>
                                    </div>
                                </span>
                                <span class="map-contact" data-code="TILT">
                                    Tilt
                                    <div class="map-contact-tooltip">
                                        <div style="font-weight: 600; color: var(--accent); margin-bottom: 6px;">Tilt Renewables</div>
                                        <div style="color: var(--text-primary);">Rhys Albanese</div>
                                        <div style="color: var(--text-muted);">Development Lead</div>
                                        <div style="color: #45b7d1; margin-top: 4px;">rhys.albanese@tiltrenewables.com</div>
                                    </div>
                                </span>
                                <span class="map-contact" data-code="RES">RES</span>
                                <span class="map-contact" data-code="LSBP">LSBP</span>
                                <span class="map-contact" data-code="ELGIN">Elgin</span>
                                <span class="map-contact" data-code="LEESON">Leeson</span>
                                <span class="map-contact" data-code="ENERGAUST">
                                    EA
                                    <div class="map-contact-tooltip">
                                        <div style="font-weight: 600; color: var(--accent); margin-bottom: 6px;">Energy Australia</div>
                                        <div style="color: var(--text-primary);">Lauri Rehn</div>
                                        <div style="color: var(--text-muted);">Project Manager</div>
                                        <div style="color: #45b7d1; margin-top: 4px;">lauri.rehn@energyaustralia.com.au</div>
                                    </div>
                                </span>
                                <span class="map-contact" data-code="ENGIE">
                                    Engie
                                    <div class="map-contact-tooltip">
                                        <div style="font-weight: 600; color: var(--accent); margin-bottom: 6px;">ENGIE</div>
                                        <div style="color: var(--text-primary);">Jamie Lowe</div>
                                        <div style="color: var(--text-muted);">Grid Lead</div>
                                        <div style="color: #45b7d1; margin-top: 4px;">jamie.lowe@engie.com</div>
                                    </div>
                                </span>
                                <span class="map-contact" data-code="SOUTHEN">
                                    South Energy
                                    <div class="map-contact-tooltip">
                                        <div style="font-weight: 600; color: var(--accent); margin-bottom: 6px;">South Energy</div>
                                        <div style="color: var(--text-primary);">Johan Laban</div>
                                        <div style="color: var(--text-muted);">CEO</div>
                                        <div style="color: #45b7d1; margin-top: 4px;">johan.laban@southenergy.com.au</div>
                                        <div style="color: var(--success);">📱 0422 418 965</div>
                                    </div>
                                </span>
                                <span class="map-contact" data-code="OCTOPUS">Octopus</span>
                            </div>
                            <div style="font-size: 9px; color: var(--text-muted); margin-top: 14px; padding-top: 12px; border-top: 1px solid var(--border);">
                                <strong style="color: var(--warning);">Pitch:</strong> "De-risk FID by ensuring R1 meets AEMO on first submission"
                            </div>

                            <!-- EPCs sub-section -->
                            <div style="margin-top: 16px; padding: 14px; background: linear-gradient(135deg, #f5a62315, #f5a62308); border: 2px solid #f5a623; border-radius: 10px;">
                                <div style="font-weight: 700; color: #f5a623; font-size: 10px; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; gap: 6px;">
                                    <span style="width: 6px; height: 6px; background: #f5a623; border-radius: 2px;"></span>
                                    EPC Contractors
                                    <span style="margin-left: auto; font-size: 9px; color: var(--text-muted); font-weight: 400;">Need: R1 Package for turnkey</span>
                                </div>
                                <div style="font-size: 11px; color: var(--text-primary); display: grid; grid-template-columns: 1fr 1fr; gap: 4px;">
                                    <span class="map-contact" data-code="ELECNOR">
                                        Elecnor
                                        <div class="map-contact-tooltip">
                                            <div style="font-weight: 600; color: var(--accent); margin-bottom: 6px;">Elecnor</div>
                                            <div style="color: var(--text-primary);">Enrique Trabajo</div>
                                            <div style="color: var(--text-muted);">EPC Manager</div>
                                            <div style="color: #45b7d1; margin-top: 4px;">etrabajo.atersa@elecnor.com</div>
                                        </div>
                                    </span>
                                    <span class="map-contact" data-code="GRANSOLAR">Gransolar</span>
                                    <span style="color: var(--text-muted);">Bouygues</span>
                                    <span style="color: var(--text-muted);">Sterling & Wilson</span>
                                </div>
                            </div>

                            <!-- Asset Owners sub-section -->
                            <div style="margin-top: 12px; padding: 14px; background: linear-gradient(135deg, #45b7d110, #45b7d105); border: 2px dashed #45b7d1; border-radius: 10px;">
                                <div style="font-weight: 700; color: #45b7d1; font-size: 10px; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; gap: 6px;">
                                    <span style="width: 6px; height: 6px; background: #45b7d1; border-radius: 2px;"></span>
                                    Asset Owners (Post-COD)
                                </div>
                                <div style="font-size: 11px; color: var(--text-primary);">
                                    <span class="map-contact" data-code="PACBLUE">
                                        Pacific Blue
                                        <div class="map-contact-tooltip">
                                            <div style="font-weight: 600; color: var(--accent); margin-bottom: 6px;">Pacific Blue</div>
                                            <div style="color: var(--text-primary);">Daniel Choi</div>
                                            <div style="color: var(--text-muted);">Asset Manager</div>
                                            <div style="color: #45b7d1; margin-top: 4px;">dchoi@pacificblue.com.au</div>
                                            <div style="margin-top: 6px; padding: 4px 8px; background: rgba(0,212,170,0.2); border-radius: 4px; font-size: 9px; color: var(--accent);">🔥 2x BESS projects Q1 2026</div>
                                        </div>
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- Flow Arrow 2 -->
                        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding-top: 60px;">
                            <div class="flow-indicator flow-data">📋</div>
                            <div style="height: 80px; width: 2px; background: linear-gradient(180deg, #45b7d1, #96CEB4); margin: 8px 0;"></div>
                            <div style="color: var(--text-muted); font-size: 8px; text-align: center;">Connection<br>App</div>
                        </div>

                        <!-- Column 3: NSPs -->
                        <div style="background: linear-gradient(135deg, #96CEB415, #96CEB408); border: 2px solid #96CEB4; border-radius: 12px; padding: 16px;">
                            <div style="font-weight: 700; color: #96CEB4; font-size: 11px; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; gap: 6px;">
                                <span style="width: 8px; height: 8px; background: #96CEB4; border-radius: 2px;"></span>
                                NSPs
                            </div>
                            <div style="font-size: 11px; color: var(--text-primary); display: flex; flex-direction: column; gap: 6px;">
                                <span class="map-contact" data-code="AUSNET">
                                    AusNet (VIC)
                                    <div class="map-contact-tooltip">
                                        <div style="font-weight: 600; color: var(--accent); margin-bottom: 6px;">AusNet Services</div>
                                        <div style="color: var(--text-primary);">Zach Sun</div>
                                        <div style="color: var(--text-muted);">Connections Engineer</div>
                                        <div style="color: #45b7d1; margin-top: 4px;">zach.sun@ausnetservices.com.au</div>
                                        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border);"></div>
                                        <div style="color: var(--text-muted); font-size: 10px;">VSIR Compliance:</div>
                                        <div style="color: #96CEB4;">VSIRcompliance@ausnetservices.com.au</div>
                                    </div>
                                </span>
                                <span style="color: var(--text-muted);">Transgrid (NSW)</span>
                                <span style="color: var(--text-muted);">Powerlink (QLD)</span>
                                <span style="color: var(--text-muted);">ElectraNet (SA)</span>
                                <span style="color: var(--text-muted);">Western Power (WA)</span>
                            </div>
                            <div style="font-size: 9px; color: var(--text-muted); margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border);">
                                <strong style="color: var(--warning);">Need:</strong> Clean models, minimal RFI rounds
                            </div>
                        </div>

                        <!-- Flow Arrow 3 -->
                        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding-top: 60px;">
                            <div class="flow-indicator flow-approval">✓</div>
                            <div style="height: 80px; width: 2px; background: linear-gradient(180deg, #96CEB4, #e0245e); margin: 8px 0;"></div>
                            <div style="color: var(--text-muted); font-size: 8px; text-align: center;">GPS<br>R1/R2</div>
                        </div>

                        <!-- Column 4: AEMO -->
                        <div style="background: linear-gradient(135deg, #e0245e15, #e0245e08); border: 2px solid #e0245e; border-radius: 12px; padding: 16px;">
                            <div style="font-weight: 700; color: #e0245e; font-size: 11px; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; gap: 6px;">
                                <span style="width: 8px; height: 8px; background: #e0245e; border-radius: 2px;"></span>
                                AEMO
                            </div>
                            <div style="font-size: 11px; color: var(--text-primary); margin-bottom: 12px;">
                                <span class="map-contact" data-code="AEMO" style="font-weight: 600;">
                                    Australian Energy Market Operator
                                    <div class="map-contact-tooltip" style="min-width: 280px;">
                                        <div style="font-weight: 600; color: var(--accent); margin-bottom: 8px;">AEMO Key Contacts</div>
                                        <div style="display: flex; flex-direction: column; gap: 8px;">
                                            <div>
                                                <div style="color: var(--text-primary);">Luke Wotherspoon</div>
                                                <div style="color: var(--text-muted);">GPS Team Lead</div>
                                                <div style="color: #45b7d1;">luke.wotherspoon@aemo.com.au</div>
                                            </div>
                                            <div style="border-top: 1px solid var(--border); padding-top: 8px;">
                                                <div style="color: var(--text-primary);">Sarah Chen</div>
                                                <div style="color: var(--text-muted);">GPS Engineer</div>
                                                <div style="color: #45b7d1;">sarah.chen@aemo.com.au</div>
                                            </div>
                                            <div style="border-top: 1px solid var(--border); padding-top: 8px;">
                                                <div style="color: #e0245e; font-weight: 600;">Team Mailboxes:</div>
                                                <div style="color: #45b7d1;">gps@aemo.com.au</div>
                                                <div style="color: #45b7d1;">connections@aemo.com.au</div>
                                                <div style="color: #45b7d1;">registration@aemo.com.au</div>
                                            </div>
                                        </div>
                                    </div>
                                </span>
                            </div>
                            <div style="font-size: 10px; color: var(--text-secondary); display: flex; flex-direction: column; gap: 6px;">
                                <div style="padding: 8px; background: var(--bg-main); border-radius: 6px; border-left: 3px solid #e0245e;">
                                    <strong>GPS Compliance</strong><br>
                                    <span style="font-size: 9px; color: var(--text-muted);">S5.2.5.15 System Strength</span>
                                </div>
                                <div style="padding: 8px; background: var(--bg-main); border-radius: 6px; border-left: 3px solid #e0245e;">
                                    <strong>R1 Registration</strong><br>
                                    <span style="font-size: 9px; color: var(--text-muted);">⚠️ Current bottleneck</span>
                                </div>
                                <div style="padding: 8px; background: var(--bg-main); border-radius: 6px; border-left: 3px solid #e0245e;">
                                    <strong>GFM Pipeline</strong><br>
                                    <span style="font-size: 9px; color: var(--text-muted);">~100 Grid-Forming BESS</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Vysus Consultant Box - Full Width Bottom -->
                    <div style="margin-top: 24px; background: linear-gradient(135deg, #00d4aa20, #00d4aa08); border: 3px solid #00d4aa; border-radius: 16px; padding: 20px; box-shadow: 0 4px 20px rgba(0,212,170,0.15);">
                        <div style="display: grid; grid-template-columns: auto 1fr auto; gap: 30px; align-items: center;">
                            <div>
                                <div style="font-weight: 700; color: #00d4aa; font-size: 14px; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; gap: 8px;">
                                    <span style="width: 10px; height: 10px; background: #00d4aa; border-radius: 2px;"></span>
                                    Vysus Group
                                    <span style="font-size: 9px; color: var(--text-muted); font-weight: 400; text-transform: none;">24+ Experts | ISO 9001/14001/45001 | Lloyd's Register Heritage</span>
                                </div>
                                <div style="font-size: 12px; color: var(--text-primary); display: flex; flex-direction: column; gap: 4px;">
                                    <span style="font-weight: 600; color: #00d4aa; font-size: 13px;">★ 280+ Projects | 20GW+ Capacity</span>
                                    <div style="display: flex; gap: 12px; margin-top: 4px;">
                                        <span class="map-contact" data-code="VALENT" style="font-size: 11px;">
                                            Valent Energy
                                            <div class="map-contact-tooltip">
                                                <div style="font-weight: 600; color: var(--accent); margin-bottom: 6px;">Valent Energy</div>
                                                <div style="color: var(--text-primary);">Subrato Saha</div>
                                                <div style="color: var(--text-muted);">Principal Consultant</div>
                                                <div style="color: #45b7d1; margin-top: 4px;">subrato.saha@valentenergy.com.au</div>
                                            </div>
                                        </span>
                                        <span class="map-contact" data-code="VECTOR" style="font-size: 11px;">
                                            Vector Renewables
                                            <div class="map-contact-tooltip">
                                                <div style="font-weight: 600; color: var(--accent); margin-bottom: 6px;">Vector Renewables</div>
                                                <div style="color: var(--text-primary);">Richard Morcom</div>
                                                <div style="color: var(--text-muted);">Director</div>
                                                <div style="color: #45b7d1; margin-top: 4px;">rmorcom@vectorenewables.com</div>
                                            </div>
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div style="font-size: 11px; color: var(--text-secondary); display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
                                <div style="padding: 12px; background: var(--bg-main); border-radius: 8px; text-align: center; border: 1px solid var(--border);">
                                    <div style="font-weight: 600; color: #00d4aa; margin-bottom: 4px;">Grid Studies</div>
                                    <div style="font-size: 9px; color: var(--text-muted);">Feasibility & PSS/E</div>
                                </div>
                                <div style="padding: 12px; background: var(--bg-main); border-radius: 8px; text-align: center; border: 1px solid var(--border);">
                                    <div style="font-weight: 600; color: #00d4aa; margin-bottom: 4px;">GPS/PSCAD</div>
                                    <div style="font-size: 9px; color: var(--text-muted);">200+ DMAT sims</div>
                                </div>
                                <div style="padding: 12px; background: var(--bg-main); border-radius: 8px; text-align: center; border: 1px solid var(--border);">
                                    <div style="font-weight: 600; color: #00d4aa; margin-bottom: 4px;">R1 Recovery</div>
                                    <div style="font-size: 9px; color: var(--text-muted);">Stalled project rescue</div>
                                </div>
                                <div style="padding: 12px; background: var(--bg-main); border-radius: 8px; text-align: center; border: 1px solid var(--border);">
                                    <div style="font-weight: 600; color: #00d4aa; margin-bottom: 4px;">GFM Inverters</div>
                                    <div style="font-size: 9px; color: var(--text-muted);">S5.2.5.15 specialist</div>
                                </div>
                            </div>
                            <div style="text-align: right; font-size: 10px; color: var(--text-muted); line-height: 1.6;">
                                <strong style="color: #00d4aa;">Edge:</strong> India/Malaysia<br>
                                "Follow-the-Sun" capacity<br>
                                <span style="color: var(--warning);">24hr model iteration</span>
                            </div>
                        </div>
                    </div>

                    <!-- Competitor Intelligence Section -->
                    <div style="margin-top: 20px; background: linear-gradient(135deg, rgba(224,36,94,0.1), rgba(224,36,94,0.05)); border: 2px dashed #e0245e; border-radius: 12px; padding: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <div style="font-weight: 700; color: #e0245e; font-size: 12px; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; gap: 8px;">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                                    Competitive Intelligence
                                </div>
                                <div style="display: flex; gap: 24px;">
                                    <div>
                                        <div class="map-contact" style="font-size: 12px; color: var(--text-primary); margin-bottom: 6px;">
                                            <span class="competitor-tag">COMPETITOR</span> Node Energy
                                            <div class="map-contact-tooltip" style="min-width: 260px;">
                                                <div style="font-weight: 600; color: #e0245e; margin-bottom: 8px;">Node Energy (Node Australia)</div>
                                                <div style="color: var(--text-muted); margin-bottom: 8px; font-style: italic;">"Powering Dependable Progress"</div>
                                                <div style="display: flex; flex-direction: column; gap: 6px;">
                                                    <div>
                                                        <div style="color: var(--text-primary);">Elizabeth Maina</div>
                                                        <div style="color: var(--text-muted);">Director / Principal</div>
                                                    </div>
                                                    <div>
                                                        <div style="color: var(--text-primary);">Muhammad Saad</div>
                                                        <div style="color: var(--text-muted);">Technical Lead</div>
                                                    </div>
                                                </div>
                                                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border); font-size: 10px;">
                                                    <div style="color: var(--warning);">⚠️ Active in AEMC rule-change submissions</div>
                                                    <div style="color: var(--text-muted); margin-top: 4px;">Positions as niche specialist for "lost" developers</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div style="font-size: 10px; color: var(--text-muted);">Boutique | R0/R1/R2 Focus | AEMC Active</div>
                                    </div>
                                    <div style="font-size: 10px; color: var(--text-secondary); max-width: 300px;">
                                        <strong style="color: var(--text-primary);">Their Play:</strong> Senior-level attention on every project, regulatory policy influence<br>
                                        <strong style="color: #00d4aa;">Our Counter:</strong> 24-person team depth = stability + 24hr delivery with offshore capacity
                                    </div>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div class="map-contact" style="font-size: 11px; color: var(--text-primary);">
                                    Blue Power Partners
                                    <div class="map-contact-tooltip">
                                        <div style="font-weight: 600; color: var(--accent); margin-bottom: 6px;">Blue Power Partners</div>
                                        <div style="color: var(--text-primary);">Georgia Bowden</div>
                                        <div style="color: var(--text-muted);">BESS Recruitment</div>
                                        <div style="color: #45b7d1; margin-top: 4px;">gbo@bluepp.dk</div>
                                    </div>
                                </span>
                                <div style="font-size: 9px; color: var(--text-muted);">BESS talent network</div>
                            </div>
                        </div>
                    </div>

                    <!-- Legend with Flow Types -->
                    <div style="margin-top: 20px; display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: var(--bg-main); border-radius: 10px; border: 1px solid var(--border);">
                        <div style="display: flex; gap: 16px;">
                            <div style="display: flex; align-items: center; gap: 6px; font-size: 10px;"><span style="width: 10px; height: 10px; background: #BB8FCE; border-radius: 2px;"></span> Investor</div>
                            <div style="display: flex; align-items: center; gap: 6px; font-size: 10px;"><span style="width: 10px; height: 10px; background: #45b7d1; border-radius: 2px;"></span> Developer</div>
                            <div style="display: flex; align-items: center; gap: 6px; font-size: 10px;"><span style="width: 10px; height: 10px; background: #f5a623; border-radius: 2px;"></span> EPC</div>
                            <div style="display: flex; align-items: center; gap: 6px; font-size: 10px;"><span style="width: 10px; height: 10px; background: #DDA0DD; border-radius: 2px;"></span> OEM</div>
                            <div style="display: flex; align-items: center; gap: 6px; font-size: 10px;"><span style="width: 10px; height: 10px; background: #96CEB4; border-radius: 2px;"></span> NSP</div>
                            <div style="display: flex; align-items: center; gap: 6px; font-size: 10px;"><span style="width: 10px; height: 10px; background: #e0245e; border-radius: 2px;"></span> AEMO</div>
                        </div>
                        <div style="display: flex; gap: 12px; font-size: 9px;">
                            <span class="flow-indicator flow-money" style="animation-duration: 3s;">$ Funding</span>
                            <span class="flow-indicator flow-data" style="animation-duration: 3s;">📋 Application</span>
                            <span class="flow-indicator flow-approval" style="animation-duration: 3s;">✓ Approval</span>
                            <span class="flow-indicator flow-support" style="animation-duration: 3s;">⚡ Support</span>
                        </div>
                    </div>

                    <!-- Learning Center -->
                    <div style="margin-top: 24px;">
                        <div class="learning-toggle" onclick="toggleLearningCenter()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px;">
                                <path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                            </svg>
                            <span>Learning Center</span>
                            <span style="margin-left: auto; font-size: 10px; opacity: 0.7;">Click to expand</span>
                            <svg id="learningChevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px; transition: transform 0.3s;">
                                <polyline points="6,9 12,15 18,9"/>
                            </svg>
                        </div>

                        <div id="learningContent" style="display: none; margin-top: 16px;">
                            <!-- Learning Tabs -->
                            <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                                <button class="quiz-btn" onclick="showLearningTab('flashcards')" id="btn-flashcards" style="opacity: 1;">📚 Flashcards</button>
                                <button class="quiz-btn" onclick="showLearningTab('contacts')" id="btn-contacts" style="opacity: 0.6;">👤 Contact Quiz</button>
                                <button class="quiz-btn" onclick="showLearningTab('process')" id="btn-process" style="opacity: 0.6;">🔄 Process Steps</button>
                                <button class="quiz-btn" onclick="showLearningTab('glossary')" id="btn-glossary" style="opacity: 0.6;">📖 Glossary</button>
                            </div>

                            <!-- Flashcards Section -->
                            <div id="learning-flashcards" class="learning-section">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                    <div style="font-size: 14px; color: var(--text-primary);">
                                        <strong>Key Terms</strong> - Click cards to flip
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <span style="font-size: 11px; color: var(--text-muted);">Score: <span id="flashcard-score">0</span>/<span id="flashcard-total">0</span></span>
                                        <button class="quiz-btn" onclick="shuffleFlashcards()" style="padding: 6px 12px; font-size: 11px;">🔀 Shuffle</button>
                                    </div>
                                </div>
                                <div id="flashcards-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
                                    <!-- Populated by JavaScript -->
                                </div>
                            </div>

                            <!-- Contact Quiz Section -->
                            <div id="learning-contacts" class="learning-section" style="display: none;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                    <div style="font-size: 14px; color: var(--text-primary);">
                                        <strong>Contact Quiz</strong> - Match contacts to companies
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <span style="font-size: 11px; color: var(--text-muted);">Streak: <span id="contact-streak">0</span></span>
                                        <button class="quiz-btn" onclick="nextContactQuestion()" style="padding: 6px 12px; font-size: 11px;">Next Question →</button>
                                    </div>
                                </div>
                                <div id="contact-quiz-area" style="background: var(--bg-card); border-radius: 12px; padding: 24px; text-align: center;">
                                    <!-- Populated by JavaScript -->
                                </div>
                            </div>

                            <!-- Process Steps Section -->
                            <div id="learning-process" class="learning-section" style="display: none;">
                                <div style="font-size: 14px; color: var(--text-primary); margin-bottom: 16px;">
                                    <strong>Grid Connection Process</strong> - Click each step to learn more
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 12px;">
                                    <div class="process-step" onclick="toggleProcessDetail(this)" style="background: var(--bg-card); border-radius: 10px; padding: 16px; cursor: pointer; border-left: 4px solid #BB8FCE;">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <div style="display: flex; align-items: center; gap: 12px;">
                                                <span style="background: #BB8FCE; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">1</span>
                                                <span style="font-weight: 600; color: var(--text-primary);">Funding & Site Acquisition</span>
                                            </div>
                                            <span style="color: var(--text-muted);">▼</span>
                                        </div>
                                        <div class="process-detail" style="display: none; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); font-size: 12px; color: var(--text-secondary); line-height: 1.6;">
                                            <strong>Who:</strong> Investors (Aquila Capital) → Developers<br>
                                            <strong>What:</strong> Secure land rights, obtain development approval, raise capital<br>
                                            <strong>Vysus Role:</strong> Technical due diligence for investors, feasibility studies<br>
                                            <strong>Key Docs:</strong> Land lease, DA approval, term sheet
                                        </div>
                                    </div>
                                    <div class="process-step" onclick="toggleProcessDetail(this)" style="background: var(--bg-card); border-radius: 10px; padding: 16px; cursor: pointer; border-left: 4px solid #45b7d1;">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <div style="display: flex; align-items: center; gap: 12px;">
                                                <span style="background: #45b7d1; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">2</span>
                                                <span style="font-weight: 600; color: var(--text-primary);">Connection Application</span>
                                            </div>
                                            <span style="color: var(--text-muted);">▼</span>
                                        </div>
                                        <div class="process-detail" style="display: none; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); font-size: 12px; color: var(--text-secondary); line-height: 1.6;">
                                            <strong>Who:</strong> Developer → NSP (AusNet, Transgrid)<br>
                                            <strong>What:</strong> Submit connection enquiry, receive preliminary response<br>
                                            <strong>Vysus Role:</strong> Prepare connection application, PSS/E studies<br>
                                            <strong>Key Docs:</strong> Connection enquiry, Generator Performance Standards (GPS) proposal
                                        </div>
                                    </div>
                                    <div class="process-step" onclick="toggleProcessDetail(this)" style="background: var(--bg-card); border-radius: 10px; padding: 16px; cursor: pointer; border-left: 4px solid #96CEB4;">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <div style="display: flex; align-items: center; gap: 12px;">
                                                <span style="background: #96CEB4; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">3</span>
                                                <span style="font-weight: 600; color: var(--text-primary);">GPS Compliance & R0</span>
                                            </div>
                                            <span style="color: var(--text-muted);">▼</span>
                                        </div>
                                        <div class="process-detail" style="display: none; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); font-size: 12px; color: var(--text-secondary); line-height: 1.6;">
                                            <strong>Who:</strong> Developer + Consultant → NSP + AEMO<br>
                                            <strong>What:</strong> Demonstrate GPS compliance, submit R0 (preliminary) models<br>
                                            <strong>Vysus Role:</strong> PSCAD modelling, DMAT simulations (200+), GPS compliance assessment<br>
                                            <strong>Key Terms:</strong> S5.2.5.15 (System Strength), GFM (Grid-Forming Inverter)
                                        </div>
                                    </div>
                                    <div class="process-step" onclick="toggleProcessDetail(this)" style="background: var(--bg-card); border-radius: 10px; padding: 16px; cursor: pointer; border-left: 4px solid #f5a623;">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <div style="display: flex; align-items: center; gap: 12px;">
                                                <span style="background: #f5a623; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">4</span>
                                                <span style="font-weight: 600; color: var(--text-primary);">EPC & Construction</span>
                                            </div>
                                            <span style="color: var(--text-muted);">▼</span>
                                        </div>
                                        <div class="process-detail" style="display: none; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); font-size: 12px; color: var(--text-secondary); line-height: 1.6;">
                                            <strong>Who:</strong> Developer → EPC (Elecnor, Gransolar) → OEMs (Vestas, Goldwind)<br>
                                            <strong>What:</strong> Procure equipment, construct plant, commission systems<br>
                                            <strong>Vysus Role:</strong> R1 package as part of EPC turnkey, equipment model verification<br>
                                            <strong>Pitch:</strong> "Technology agnostic - work with proprietary inverter models under NDA"
                                        </div>
                                    </div>
                                    <div class="process-step" onclick="toggleProcessDetail(this)" style="background: var(--bg-card); border-radius: 10px; padding: 16px; cursor: pointer; border-left: 4px solid #e0245e;">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <div style="display: flex; align-items: center; gap: 12px;">
                                                <span style="background: #e0245e; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">5</span>
                                                <span style="font-weight: 600; color: var(--text-primary);">R1 Registration (BOTTLENECK)</span>
                                            </div>
                                            <span style="color: var(--text-muted);">▼</span>
                                        </div>
                                        <div class="process-detail" style="display: none; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); font-size: 12px; color: var(--text-secondary); line-height: 1.6;">
                                            <strong>Who:</strong> Developer + Consultant → AEMO<br>
                                            <strong>What:</strong> Submit R1 model package for AEMO approval, receive 5.3.4a letter<br>
                                            <strong>⚠️ Current Issue:</strong> Many projects stuck here - R1 backlog at AEMO<br>
                                            <strong>Vysus Edge:</strong> "R1 Recovery" service - take over stalled projects, 24hr model iteration with offshore team<br>
                                            <strong>Key Deliverable:</strong> R1 5.3.4a letter = unlocks bank funding (FID)
                                        </div>
                                    </div>
                                    <div class="process-step" onclick="toggleProcessDetail(this)" style="background: var(--bg-card); border-radius: 10px; padding: 16px; cursor: pointer; border-left: 4px solid #00d4aa;">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <div style="display: flex; align-items: center; gap: 12px;">
                                                <span style="background: #00d4aa; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">6</span>
                                                <span style="font-weight: 600; color: var(--text-primary);">R2, Commissioning & COD</span>
                                            </div>
                                            <span style="color: var(--text-muted);">▼</span>
                                        </div>
                                        <div class="process-detail" style="display: none; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); font-size: 12px; color: var(--text-secondary); line-height: 1.6;">
                                            <strong>Who:</strong> Developer + Consultant → AEMO + NSP<br>
                                            <strong>What:</strong> R2 (as-built) model submission, commissioning tests, energisation<br>
                                            <strong>Vysus Role:</strong> R2 model update, commissioning support, performance verification<br>
                                            <strong>Outcome:</strong> Commercial Operation Date (COD) - project generating revenue
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Glossary Section -->
                            <div id="learning-glossary" class="learning-section" style="display: none;">
                                <div style="font-size: 14px; color: var(--text-primary); margin-bottom: 16px;">
                                    <strong>Industry Glossary</strong> - Key terms you need to know
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                                    <div style="background: var(--bg-card); border-radius: 8px; padding: 12px; border-left: 3px solid #e0245e;">
                                        <div style="font-weight: 600; color: #e0245e; font-size: 12px;">GPS</div>
                                        <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">Generator Performance Standards - technical requirements generators must meet to connect to NEM</div>
                                    </div>
                                    <div style="background: var(--bg-card); border-radius: 8px; padding: 12px; border-left: 3px solid #e0245e;">
                                        <div style="font-weight: 600; color: #e0245e; font-size: 12px;">R0 / R1 / R2</div>
                                        <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">Registration stages: R0 (preliminary), R1 (pre-construction), R2 (as-built). Each requires model submission to AEMO</div>
                                    </div>
                                    <div style="background: var(--bg-card); border-radius: 8px; padding: 12px; border-left: 3px solid #45b7d1;">
                                        <div style="font-weight: 600; color: #45b7d1; font-size: 12px;">5.3.4a Letter</div>
                                        <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">AEMO confirmation that R1 model is accepted - critical for FID as it unlocks bank finance</div>
                                    </div>
                                    <div style="background: var(--bg-card); border-radius: 8px; padding: 12px; border-left: 3px solid #45b7d1;">
                                        <div style="font-weight: 600; color: #45b7d1; font-size: 12px;">FID</div>
                                        <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">Final Investment Decision - point where project gets bank finance and construction begins</div>
                                    </div>
                                    <div style="background: var(--bg-card); border-radius: 8px; padding: 12px; border-left: 3px solid #9b59b6;">
                                        <div style="font-weight: 600; color: #9b59b6; font-size: 12px;">PSCAD</div>
                                        <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">Power system simulation software used for EMT (electromagnetic transient) modelling</div>
                                    </div>
                                    <div style="background: var(--bg-card); border-radius: 8px; padding: 12px; border-left: 3px solid #9b59b6;">
                                        <div style="font-weight: 600; color: #9b59b6; font-size: 12px;">DMAT</div>
                                        <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">Dynamic Model Acceptance Test - AEMO's test suite for validating generator models (200+ simulations)</div>
                                    </div>
                                    <div style="background: var(--bg-card); border-radius: 8px; padding: 12px; border-left: 3px solid #00d4aa;">
                                        <div style="font-weight: 600; color: #00d4aa; font-size: 12px;">GFM</div>
                                        <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">Grid-Forming Inverter - can form voltage reference independently. ~100 GFM BESS in AEMO pipeline</div>
                                    </div>
                                    <div style="background: var(--bg-card); border-radius: 8px; padding: 12px; border-left: 3px solid #00d4aa;">
                                        <div style="font-weight: 600; color: #00d4aa; font-size: 12px;">S5.2.5.15</div>
                                        <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">NER clause for System Strength - requires generators to not adversely affect grid stability</div>
                                    </div>
                                    <div style="background: var(--bg-card); border-radius: 8px; padding: 12px; border-left: 3px solid #96CEB4;">
                                        <div style="font-weight: 600; color: #96CEB4; font-size: 12px;">NSP</div>
                                        <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">Network Service Provider - owns/operates the grid (AusNet, Transgrid, Powerlink, etc.)</div>
                                    </div>
                                    <div style="background: var(--bg-card); border-radius: 8px; padding: 12px; border-left: 3px solid #96CEB4;">
                                        <div style="font-weight: 600; color: #96CEB4; font-size: 12px;">NEM</div>
                                        <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">National Electricity Market - interconnected grid covering QLD, NSW, VIC, SA, TAS (not WA)</div>
                                    </div>
                                    <div style="background: var(--bg-card); border-radius: 8px; padding: 12px; border-left: 3px solid #f5a623;">
                                        <div style="font-weight: 600; color: #f5a623; font-size: 12px;">EPC</div>
                                        <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">Engineering, Procurement, Construction - turnkey contractors who build plants</div>
                                    </div>
                                    <div style="background: var(--bg-card); border-radius: 8px; padding: 12px; border-left: 3px solid #f5a623;">
                                        <div style="font-weight: 600; color: #f5a623; font-size: 12px;">COD</div>
                                        <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">Commercial Operation Date - when plant starts generating revenue in the market</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Stakeholder Contacts from Database -->
                <div style="margin-top: 24px; background: var(--bg-card); border-radius: 16px; padding: 24px; border: 1px solid var(--border);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: var(--accent); font-size: 16px; display: flex; align-items: center; gap: 10px;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px;">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                            </svg>
                            Your Stakeholder Contacts
                        </h3>
                        <div style="font-size: 11px; color: var(--text-muted);">Pulled from Stakeholders tab - <span id="contact-count">0</span> contacts</div>
                    </div>
                    <div id="stakeholder-contacts-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="summary-panel" id="summaryPanel">
        <div class="summary-stat">
            <div class="value" id="totalStaff">0</div>
            <div class="label">Staff</div>
        </div>
        <div class="summary-stat warning">
            <div class="value" id="overloadedCount">0</div>
            <div class="label">Overloaded</div>
        </div>
        <div class="summary-stat">
            <div class="value" id="totalHours">0</div>
            <div class="label">Total Hrs</div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8765';

        // ============================================
        // SUPABASE CONFIGURATION
        // ============================================
        const SUPABASE_URL = 'https://ekytcurxudovqqvabmyp.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_QHn_8yCwCGLaimiqoJk95A_Fhd55iP0';

        // Initialize Supabase client with session persistence
        let supabaseClient = null;
        if (window.supabase && window.supabase.createClient) {
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                auth: {
                    persistSession: true,
                    storageKey: 'vysus-program-auth',
                    storage: window.localStorage,
                    autoRefreshToken: true,
                    detectSessionInUrl: true
                }
            });
        }

        // Data source priority: Supabase > Daemon > localStorage
        let dataSource = 'initializing';

        // ============================================
        // SUPABASE AUTH SERVICE
        // ============================================
        const SupabaseAuth = {
            async signIn(email, password) {
                if (!supabaseClient) return { error: 'Supabase not initialized' };
                const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
                if (!error) this.logAudit('login', null, null);
                return { data, error };
            },

            async signUp(email, password, fullName) {
                if (!supabaseClient) return { error: 'Supabase not initialized' };
                const { data, error } = await supabaseClient.auth.signUp({
                    email,
                    password,
                    options: { data: { full_name: fullName } }
                });
                return { data, error };
            },

            async signOut() {
                if (!supabaseClient) return { error: 'Supabase not initialized' };
                const { error } = await supabaseClient.auth.signOut();
                return { error };
            },

            async getUser() {
                if (!supabaseClient) return null;
                const { data: { user } } = await supabaseClient.auth.getUser();
                return user;
            },

            async getSession() {
                if (!supabaseClient) return null;
                const { data: { session } } = await supabaseClient.auth.getSession();
                return session;
            },

            onAuthStateChange(callback) {
                if (!supabaseClient) return;
                supabaseClient.auth.onAuthStateChange((event, session) => {
                    callback(event, session);
                });
            },

            async logAudit(action, tableName, recordId, oldData = null, newData = null) {
                if (!supabaseClient) return;
                try {
                    const user = await this.getUser();
                    await supabaseClient.from('audit_log').insert({
                        user_id: user?.id,
                        action,
                        table_name: tableName,
                        record_id: recordId,
                        old_data: oldData,
                        new_data: newData
                    });
                } catch (e) {
                    console.log('Audit log failed:', e);
                }
            }
        };

        // ============================================
        // SUPABASE DATA SERVICE (with fallback)
        // ============================================
        const SupabaseData = {
            // Check if Supabase is available and user is authenticated
            async isAvailable() {
                if (!supabaseClient) return false;
                const session = await SupabaseAuth.getSession();
                return !!session;
            },

            // STAKEHOLDERS
            async loadStakeholders() {
                // Try Supabase first
                if (await this.isAvailable()) {
                    try {
                        const { data, error } = await supabaseClient
                            .from('stakeholders')
                            .select('client_code, data');

                        if (!error && data) {
                            const stakeholders = {};
                            data.forEach(row => {
                                stakeholders[row.client_code] = row.data;
                            });
                            dataSource = 'supabase';
                            console.log('Loaded stakeholders from Supabase');
                            // Backup to localStorage
                            localStorage.setItem('stakeholders_data', JSON.stringify(stakeholders));
                            return stakeholders;
                        }
                    } catch (e) {
                        console.log('Supabase stakeholders load failed:', e);
                    }
                }

                // Try daemon fallback
                try {
                    const response = await fetch(`${API_BASE}/stakeholders`);
                    if (response.ok) {
                        const result = await response.json();
                        if (result?.stakeholders) {
                            dataSource = 'daemon';
                            console.log('Loaded stakeholders from daemon');
                            localStorage.setItem('stakeholders_data', JSON.stringify(result.stakeholders));
                            return result.stakeholders;
                        }
                    }
                } catch (e) {
                    console.log('Daemon stakeholders load failed:', e);
                }

                // localStorage fallback
                dataSource = 'localStorage';
                const saved = localStorage.getItem('stakeholders_data');
                console.log('Loaded stakeholders from localStorage');
                return saved ? JSON.parse(saved) : {};
            },

            async saveStakeholders(stakeholders, meetings) {
                // Always save to localStorage first
                localStorage.setItem('stakeholders_data', JSON.stringify(stakeholders));
                localStorage.setItem('stakeholder_meetings', JSON.stringify(meetings));

                // Try Supabase
                if (await this.isAvailable()) {
                    try {
                        const user = await SupabaseAuth.getUser();

                        // Upsert each stakeholder
                        for (const [clientCode, data] of Object.entries(stakeholders)) {
                            await supabaseClient
                                .from('stakeholders')
                                .upsert({
                                    client_code: clientCode,
                                    data: data,
                                    updated_by: user?.id
                                }, { onConflict: 'client_code' });
                        }

                        // Save meetings
                        for (const meeting of meetings) {
                            await supabaseClient
                                .from('stakeholder_meetings')
                                .upsert({
                                    id: meeting.id?.toString(),
                                    client_code: meeting.clientCode,
                                    client_name: meeting.clientName,
                                    meeting_date: meeting.date,
                                    confirmed: meeting.confirmed,
                                    contact_name: meeting.contact,
                                    purpose: meeting.purpose,
                                    created_by: user?.id
                                }, { onConflict: 'id' });
                        }

                        console.log('Saved to Supabase');
                        SupabaseAuth.logAudit('update', 'stakeholders', null);
                        return { success: true, source: 'supabase' };
                    } catch (e) {
                        console.log('Supabase save failed:', e);
                    }
                }

                // Try daemon fallback
                try {
                    const response = await fetch(`${API_BASE}/stakeholders`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ stakeholders, meetings })
                    });
                    if (response.ok) {
                        console.log('Saved to daemon');
                        return { success: true, source: 'daemon' };
                    }
                } catch (e) {
                    console.log('Daemon save failed:', e);
                }

                console.log('Saved to localStorage only');
                return { success: true, source: 'localStorage' };
            },

            async loadMeetings() {
                // Try Supabase first
                if (await this.isAvailable()) {
                    try {
                        const { data, error } = await supabaseClient
                            .from('stakeholder_meetings')
                            .select('*')
                            .order('meeting_date', { ascending: true });

                        if (!error && data) {
                            const meetings = data.map(row => ({
                                id: row.id,
                                clientCode: row.client_code,
                                clientName: row.client_name,
                                date: row.meeting_date,
                                confirmed: row.confirmed,
                                contact: row.contact_name,
                                purpose: row.purpose
                            }));
                            localStorage.setItem('stakeholder_meetings', JSON.stringify(meetings));
                            return meetings;
                        }
                    } catch (e) {
                        console.log('Supabase meetings load failed:', e);
                    }
                }

                // localStorage fallback
                const saved = localStorage.getItem('stakeholder_meetings');
                return saved ? JSON.parse(saved) : [];
            },

            // RESOURCE ALLOCATIONS
            async loadAllocations(week) {
                // Try Supabase first
                if (await this.isAvailable()) {
                    try {
                        const { data, error } = await supabaseClient
                            .from('resource_allocations')
                            .select('*')
                            .eq('week', week)
                            .single();

                        if (!error && data) {
                            console.log('Loaded allocations from Supabase');
                            return {
                                allocations: data.allocations || {},
                                projectNotes: data.project_notes || {},
                                projectStatus: data.project_status || {}
                            };
                        }
                    } catch (e) {
                        console.log('Supabase allocations load failed:', e);
                    }
                }

                // Try daemon fallback
                try {
                    const response = await fetch(`${API_BASE}/resource-allocation/${week}`);
                    if (response.ok) {
                        const data = await response.json();
                        if (data) {
                            return {
                                allocations: JSON.parse(data.allocations || '{}'),
                                projectNotes: JSON.parse(data.project_notes || '{}'),
                                projectStatus: JSON.parse(data.project_status || '{}')
                            };
                        }
                    }
                } catch (e) {
                    console.log('Daemon allocations load failed:', e);
                }

                // localStorage fallback
                return {
                    allocations: JSON.parse(localStorage.getItem(`alloc_${week}`) || '{}'),
                    projectNotes: JSON.parse(localStorage.getItem(`notes_${week}`) || '{}'),
                    projectStatus: JSON.parse(localStorage.getItem(`status_${week}`) || '{}')
                };
            },

            async saveAllocations(week, allocations, projectNotes, projectStatus) {
                // Always save to localStorage
                localStorage.setItem(`alloc_${week}`, JSON.stringify(allocations));
                localStorage.setItem(`notes_${week}`, JSON.stringify(projectNotes));
                localStorage.setItem(`status_${week}`, JSON.stringify(projectStatus));

                // Try Supabase
                if (await this.isAvailable()) {
                    try {
                        const user = await SupabaseAuth.getUser();
                        await supabaseClient
                            .from('resource_allocations')
                            .upsert({
                                week: week,
                                allocations: allocations,
                                project_notes: projectNotes,
                                project_status: projectStatus,
                                updated_by: user?.id
                            }, { onConflict: 'week' });

                        console.log('Saved allocations to Supabase');
                        return { success: true, source: 'supabase' };
                    } catch (e) {
                        console.log('Supabase allocations save failed:', e);
                    }
                }

                // Try daemon fallback
                try {
                    const response = await fetch(`${API_BASE}/resource-allocation`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            week,
                            allocations: JSON.stringify(allocations),
                            project_notes: JSON.stringify(projectNotes),
                            project_status: JSON.stringify(projectStatus)
                        })
                    });
                    if (response.ok) {
                        return { success: true, source: 'daemon' };
                    }
                } catch (e) {
                    console.log('Daemon allocations save failed:', e);
                }

                return { success: true, source: 'localStorage' };
            },

            // DRILL PROGRESS (per-user in Supabase)
            async loadDrillProgress() {
                // Try Supabase first (user-specific)
                if (await this.isAvailable()) {
                    try {
                        const user = await SupabaseAuth.getUser();
                        const { data, error } = await supabaseClient
                            .from('drill_progress')
                            .select('*')
                            .eq('user_id', user.id)
                            .single();

                        if (!error && data) {
                            return {
                                score: data.score || 0,
                                mastered: data.mastered_contacts || []
                            };
                        }
                    } catch (e) {
                        console.log('Supabase drill progress load failed:', e);
                    }
                }

                // localStorage fallback
                const saved = localStorage.getItem('drill_progress');
                return saved ? JSON.parse(saved) : { score: 0, mastered: [] };
            },

            async saveDrillProgress(score, mastered) {
                // Always save to localStorage
                localStorage.setItem('drill_progress', JSON.stringify({ score, mastered }));

                // Try Supabase
                if (await this.isAvailable()) {
                    try {
                        const user = await SupabaseAuth.getUser();
                        await supabaseClient
                            .from('drill_progress')
                            .upsert({
                                user_id: user.id,
                                score: score,
                                mastered_contacts: mastered
                            }, { onConflict: 'user_id' });

                        return { success: true, source: 'supabase' };
                    } catch (e) {
                        console.log('Supabase drill progress save failed:', e);
                    }
                }

                return { success: true, source: 'localStorage' };
            },

            // RADAR NOTES
            async loadRadarNotes() {
                // Try Supabase first
                if (await this.isAvailable()) {
                    try {
                        const { data, error } = await supabaseClient
                            .from('radar_notes')
                            .select('*');
                        if (!error && data) {
                            const notes = {};
                            data.forEach(row => { notes[row.client_code] = row.notes; });
                            console.log('Loaded radar notes from Supabase');
                            return notes;
                        }
                    } catch (e) {
                        console.log('Supabase radar notes load failed:', e);
                    }
                }
                // localStorage fallback
                const saved = localStorage.getItem('radar_notes');
                return saved ? JSON.parse(saved) : {};
            },

            async saveRadarNotes(notes) {
                // Always save to localStorage
                localStorage.setItem('radar_notes', JSON.stringify(notes));

                // Try Supabase
                if (await this.isAvailable()) {
                    try {
                        const user = await SupabaseAuth.getUser();
                        for (const [client, noteText] of Object.entries(notes)) {
                            await supabaseClient
                                .from('radar_notes')
                                .upsert({
                                    client_code: client,
                                    notes: noteText,
                                    updated_by: user?.id || null,
                                    updated_at: new Date().toISOString()
                                }, { onConflict: 'client_code' });
                        }
                        SupabaseAuth.logAudit('update', 'radar_notes', null);
                        return { success: true, source: 'supabase' };
                    } catch (e) {
                        console.log('Supabase radar notes save failed:', e);
                    }
                }
                return { success: true, source: 'localStorage' };
            }
        };

        // ============================================
        // CONNECTION STATUS HELPER
        // ============================================
        function updateConnectionStatus() {
            const statusText = document.getElementById('syncStatus');
            if (!statusText) return;

            if (dataSource === 'supabase') {
                statusText.textContent = 'Connected to Supabase (Secure)';
                statusText.style.color = '#17bf63';
            } else if (dataSource === 'daemon') {
                statusText.textContent = 'Connected to Promethean Light';
                statusText.style.color = '#00d4aa';
            } else {
                statusText.textContent = 'Offline mode (localStorage)';
                statusText.style.color = '#f5a623';
            }
        }

        const resources = [
            'Ajith Tennakoon', 'Owais Raja', 'Syafiq Ishamuddin', 'Hayden Brunjes',
            'Eduardo Laygo', 'Komal Gaikwad', 'Khadija Kobra',
            'Momtazur Rahman', 'Shahrul Faudzi', 'Chirag Rohit',
            'Zabir Hussainy', 'Dominic Moncada'
        ];

        const projects = [
            'Armidale', 'Haughton', 'Gerogery', 'Sandy SF', 'Sandy Hybrid',
            'Wellington', 'Upper Calliope', 'Markaranka BESS', 'Corop', 'Georgetown', 'Hallett BESS'
        ];

        // Project Q-number to name mapping
        const projectNames = {
            'Q7116': 'R1 Compliance',
            'Q5565': 'AEMO Support',
            'Q6252': 'Haughton SF',
            'Q6192': 'Aquila Review',
            'Q6095': 'Wellington GCS',
            'Q5668': 'Elecnor EPC',
            'Q6208': 'Armidale WF',
            'Q6983': 'Pac Blue BESS',
            'Q6055': 'Gerogery SF',
            'Q6092': 'Neoen BESS',
            'Q6234': 'Tilt Solar',
            'Q7193': 'Alinta GCS',
            'Q7150': 'Gransolar EPC',
            'Q7120': 'Elgin Solar',
            'Q7180': 'Leeson GCS',
            'Q7200': 'LSBP Solar',
            'Q7116V': 'Valent Support',
            'Q7250': 'EA BESS'
        };

        function getProjectName(qNumber) {
            return projectNames[qNumber] || qNumber;
        }

        const staffColors = {
            'Ajith Tennakoon': '#FF6B6B', 'Owais Raja': '#4ECDC4', 'Syafiq Ishamuddin': '#45B7D1',
            'Hayden Brunjes': '#96CEB4', 'Eduardo Laygo': '#FFEAA7', 'Komal Gaikwad': '#DDA0DD',
            'Khadija Kobra': '#98D8C8', 'Momtazur Rahman': '#F7DC6F', 'Shahrul Faudzi': '#BB8FCE',
            'Chirag Rohit': '#85C1E9', 'Zabir Hussainy': '#F8B500', 'Dominic Moncada': '#00CED1'
        };

        let allocations = {};
        let projectNotes = {};
        let projectIssues = {};
        let projectStatus = {};
        let projectMilestones = {};
        let draggedStaff = null;
        let currentMonth = new Date();
        let currentTab = 'summary';
        let stakeholderData = {};

        // Stakeholder client data - matches CRM
        // hot = has upcoming projects on radar, hotNote = what's coming
        // emailSent = holiday email draft created Dec 2024
        // contactInfo: [{ name, role, email, phone }]
        const stakeholderClients = [
            { code: 'AEMO', name: 'AEMO', type: 'AEMO', activeProjects: ['Q7116'], completedProjects: ['Q5565'], vysusPM: 'Ajith', contactInfo: [
                { name: 'Luke Wotherspoon', role: 'GPS Team Lead', email: 'luke.wotherspoon@aemo.com.au', phone: '' },
                { name: 'Sarah Chen', role: 'GPS Engineer', email: 'sarah.chen@aemo.com.au', phone: '' },
                { name: 'Connections Team', role: 'Connections', email: 'connections@aemo.com.au', phone: '' },
                { name: 'GPS Mailbox', role: 'GPS Inquiries', email: 'gps@aemo.com.au', phone: '' },
                { name: 'Registration Team', role: 'R1 Registration', email: 'registration@aemo.com.au', phone: '' }
            ]},
            { code: 'AGL', name: 'AGL', type: 'Developer', activeProjects: ['Q6252'], completedProjects: [], emailSent: true, vysusPM: 'Owais', contactInfo: [
                { name: 'Faisal Mohd', role: 'Project Manager', email: 'faisal.mohd@agl.com.au', phone: '' },
                { name: 'Behzad Naderi', role: 'Technical Lead', email: 'behzad.naderi@agl.com.au', phone: '' }
            ]},
            { code: 'AQUILA', name: 'Aquila Capital', type: 'Investor', activeProjects: [], completedProjects: ['Q6192'], emailSent: true, vysusPM: 'Dominic', contactInfo: [
                { name: 'Damien Hegarty', role: 'Investment Manager', email: 'damien.hegarty@aquila-capital.com', phone: '' }
            ]},
            { code: 'AUSNET', name: 'AusNet', type: 'NSP', activeProjects: ['Q6095'], completedProjects: [], emailSent: true, vysusPM: 'Hayden', contactInfo: [
                { name: 'Zach Sun', role: 'Connections Engineer', email: 'zach.sun@ausnetservices.com.au', phone: '' },
                { name: 'VSIR Compliance', role: 'Compliance Team', email: 'VSIRcompliance@ausnetservices.com.au', phone: '' }
            ]},
            { code: 'BIRDWOOD', name: 'Birdwood', type: 'Developer', activeProjects: [], completedProjects: [], contactInfo: [], hot: true, hotNote: 'Grid connection project indicated - details TBC' },
            { code: 'ELECNOR', name: 'Elecnor', type: 'EPC', activeProjects: [], completedProjects: ['Q5668'], emailSent: true, vysusPM: 'Syafiq', contactInfo: [
                { name: 'Enrique Trabajo', role: 'EPC Manager', email: 'etrabajo.atersa@elecnor.com', phone: '' },
                { name: 'Alejandro Yazouri', role: 'Project Engineer', email: 'ayazouri@elecnor.com', phone: '' }
            ]},
            { code: 'GOLDWIND', name: 'Goldwind', type: 'OEM', activeProjects: ['Q6208'], completedProjects: [], emailSent: true, vysusPM: 'Ajith', contactInfo: [
                { name: 'Andrew Bray', role: 'Technical Director', email: 'andrew.bray@goldwindaustralia.com', phone: '' },
                { name: 'Phillip Wu', role: 'General Manager Grid', email: 'phillip.wu@goldwindaustralia.com', phone: '+61 3 8609 7000' }
            ]},
            { code: 'PACBLUE', name: 'Pacific Blue', type: 'Asset Owner', activeProjects: ['Q6983'], completedProjects: [], emailSent: true, vysusPM: 'Komal', contactInfo: [
                { name: 'Daniel Choi', role: 'Asset Manager', email: 'dchoi@pacificblue.com.au', phone: '' },
                { name: 'Nimesh Herath', role: 'Technical Manager', email: 'nherath@pacificblue.com.au', phone: '' }
            ], hot: true, hotNote: '2x BESS projects prospected Q1 2026' },
            { code: 'RES', name: 'RES', type: 'Developer', activeProjects: ['Q6055'], completedProjects: [], emailSent: true, vysusPM: 'Owais', contactInfo: [
                { name: 'Sam Lumley', role: 'Development Manager', email: 'sam.lumley@res-group.com', phone: '' },
                { name: 'Sakshi Priya', role: 'Project Engineer', email: 'sakshi.priya@res-group.com', phone: '' }
            ]},
            { code: 'NEOEN', name: 'Neoen', type: 'Developer', activeProjects: ['Q6092'], completedProjects: [], emailSent: true, vysusPM: 'Hayden', contactInfo: [
                { name: 'Daryl Attard', role: 'Technical Manager', email: 'daryl.attard@neoen.com', phone: '' }
            ]},
            { code: 'TILT', name: 'Tilt Renewables', type: 'Developer', activeProjects: ['Q6234'], completedProjects: [], emailSent: true, vysusPM: 'Dominic', contactInfo: [
                { name: 'Rhys Albanese', role: 'Development Lead', email: 'rhys.albanese@tiltrenewables.com', phone: '' },
                { name: 'Cameron Reid', role: 'Project Director', email: 'cameron.reid@tiltrenewables.com', phone: '' }
            ]},
            { code: 'ALINTA', name: 'Alinta Energy', type: 'Developer', activeProjects: ['Q7193'], completedProjects: [], emailSent: true, vysusPM: 'Ajith', contactInfo: [
                { name: 'Cedric Banda', role: 'Development Manager', email: 'cedric.banda@alintaenergy.com.au', phone: '0437 956 948' },
                { name: 'Sam Withers', role: 'Project Engineer', email: 'sam.withers@alintaenergy.com.au', phone: '' }
            ]},
            { code: 'GRANSOLAR', name: 'Gransolar', type: 'EPC', activeProjects: ['Q7150'], completedProjects: [], emailSent: true, vysusPM: 'Eduardo', contactInfo: [
                { name: 'Sergio Argar', role: 'Project Manager', email: 'sergio.argar@gfrengineering.com', phone: '' }
            ]},
            { code: 'ELGIN', name: 'Elgin Energy', type: 'Developer', activeProjects: ['Q7120', 'Gerogery/Morven'], completedProjects: [], emailSent: true, vysusPM: 'Momtaz', contactInfo: [
                { name: 'Kieran Kelly', role: 'Commercial Lead', email: 'kieran.kelly@elgin.com', phone: '' },
                { name: 'Derick Lima', role: 'Senior Power Systems Engineer', email: 'derick.lima@elgin.com', phone: '0404 042 094' }
            ], hot: true, hotNote: 'Gerogery R0 package - Morven SF & BESS - new investor coming Q1' },
            { code: 'LEESON', name: 'Leeson Group', type: 'Developer', activeProjects: ['Q7180'], completedProjects: [], emailSent: true, vysusPM: 'Momtaz', contactInfo: [
                { name: 'Peter Leeson', role: 'Managing Director', email: 'pleeson@leesongroup.com.au', phone: '' }
            ]},
            { code: 'LSBP', name: 'Lightsource BP', type: 'Developer', activeProjects: ['Q7200'], completedProjects: [], emailSent: true, vysusPM: 'Owais', contactInfo: [
                { name: 'Chris Jovceski', role: 'Technical Lead', email: 'chris.jovceski@lightsourcebp.com', phone: '' },
                { name: 'Emily Arthur', role: 'Project Manager', email: 'emily.arthur@lightsourcebp.com', phone: '' }
            ]},
            { code: 'VALENT', name: 'Valent Energy', type: 'Consultant', activeProjects: ['Q7116V'], completedProjects: [], emailSent: true, vysusPM: 'Ajith', contactInfo: [
                { name: 'Subrato Saha', role: 'Principal Consultant', email: 'subrato.saha@valentenergy.com.au', phone: '' }
            ]},
            { code: 'ENERGAUST', name: 'Energy Australia', type: 'Developer', activeProjects: ['Q7250'], completedProjects: [], emailSent: true, vysusPM: 'Hayden', contactInfo: [
                { name: 'Lauri Rehn', role: 'Project Manager', email: 'lauri.rehn@energyaustralia.com.au', phone: '' }
            ]},
            { code: 'METLEN', name: 'Metlen Energy', type: 'Developer', activeProjects: [], completedProjects: [], emailSent: true, contactInfo: [
                { name: 'Warren Woo', role: 'Development Manager', email: 'warren.woo@metlengroup.com', phone: '' },
                { name: 'Mahesh Warusapperuma', role: 'Technical Lead', email: 'mahesh.warusapperuma@metlengroup.com', phone: '' }
            ], hot: true, hotNote: 'New developer - prospecting opportunity' },
            { code: 'SOUTHEN', name: 'South Energy', type: 'Developer', activeProjects: [], completedProjects: [], emailSent: true, contactInfo: [
                { name: 'Johan Laban', role: 'CEO', email: 'johan.laban@southenergy.com.au', phone: '0422 418 965' },
                { name: 'Linh Nguyen', role: 'Project Manager', email: 'linh.nguyen@southenergy.com.au', phone: '' }
            ], hot: true, hotNote: 'Growing developer - relationship building' },
            { code: 'VECTOR', name: 'Vector Renewables', type: 'Consultant', activeProjects: [], completedProjects: [], emailSent: true, contactInfo: [
                { name: 'Richard Morcom', role: 'Director', email: 'rmorcom@vectorenewables.com', phone: '' }
            ]},
            { code: 'OCTOPUS', name: 'Octopus Energy', type: 'Developer', activeProjects: [], completedProjects: [], emailSent: true, contactInfo: [
                { name: 'Tom Whitehouse', role: 'Development Manager', email: 'tom.whitehouse@octopus.energy', phone: '' }
            ], hot: true, hotNote: 'UK developer expanding in Australia' },
            { code: 'VESTAS', name: 'Vestas', type: 'OEM', activeProjects: [], completedProjects: [], contactInfo: [
                { name: 'Johan Laban', role: 'Lead Electrical Engineer', email: 'jolab@vestas.com', phone: '' },
                { name: 'Dr. Ragu Balanathan', role: 'Global Head of Grid', email: '', phone: '' }
            ], hot: true, hotNote: 'R1 package opportunity - technology agnostic pitch' },
            { code: 'SMA', name: 'SMA Solar Technology', type: 'OEM', activeProjects: [], completedProjects: [], contactInfo: [
                { name: 'Technical Support', role: 'Service Hotline', email: 'SolarAcademy@SMA-Australia.com.au', phone: '1800 762 287' },
                { name: 'Pre-Sales', role: 'Grid Connection', email: 'SolarAcademy@SMA-Australia.com.au', phone: '+61 2 9491 4200' }
            ], hotNote: 'Level 1, 213 Miller St, North Sydney - EMT/PSCAD model support' },
            { code: 'SUNGROW', name: 'Sungrow', type: 'OEM', activeProjects: [], completedProjects: [], contactInfo: [
                { name: 'Sales Team', role: 'Sales Inquiries', email: 'info@sungrowpower.com.au', phone: '1800 786 476' },
                { name: 'Service Team', role: 'Technical Support', email: 'service@sungrowpower.com.au', phone: '+61 2 9922 1522' }
            ], hotNote: 'Level 7, 1 Elizabeth Plaza, North Sydney - Major inverter supplier' },
            { code: 'ENGIE', name: 'ENGIE', type: 'Developer', activeProjects: [], completedProjects: [], contactInfo: [
                { name: 'Jamie Lowe', role: 'Head of Regulation & Compliance', email: 'jamie.lowe@engie.com', phone: '' }
            ], hot: true, hotNote: 'Major developer - Hazelwood renewable hub - Melbourne based' },
            { code: 'BLUEPP', name: 'Blue Power Partners', type: 'Recruiter', activeProjects: [], completedProjects: [], contactInfo: [
                { name: 'Georgia Bowden', role: 'BESS Recruitment', email: 'gbo@bluepp.dk', phone: '' }
            ], hotNote: 'BESS talent network - industry intel' },
        ];

        async function loadStakeholders() {
            // Try to load from API first
            try {
                const response = await fetch(`${API_BASE}/stakeholders`);
                if (response.ok) {
                    const data = await response.json();
                    if (data) {
                        stakeholderData = data.stakeholders || {};
                        stakeholderMeetings = data.meetings || [];
                        // Also save to localStorage as backup
                        localStorage.setItem('stakeholders_data', JSON.stringify(stakeholderData));
                        localStorage.setItem('stakeholder_meetings', JSON.stringify(stakeholderMeetings));
                        console.log('Loaded stakeholder data from API');
                        return;
                    }
                }
            } catch (e) {
                console.log('API not available, using localStorage');
            }

            // Fallback to localStorage
            const saved = localStorage.getItem('stakeholders_data');
            if (saved) {
                stakeholderData = JSON.parse(saved);
            }
            const savedMeetings = localStorage.getItem('stakeholder_meetings');
            if (savedMeetings) {
                stakeholderMeetings = JSON.parse(savedMeetings);
            }
        }

        function saveStakeholders() {
            // Collect data from inputs
            stakeholderClients.forEach(client => {
                const row = document.querySelector(`tr[data-code="${client.code}"]`);
                if (row) {
                    // Collect all contacts from rows
                    const contactRows = row.querySelectorAll('.contact-row');
                    const contacts = [];
                    contactRows.forEach((contactRow, idx) => {
                        const name = contactRow.querySelector('.contact-name')?.value || '';
                        const email = contactRow.querySelector('.contact-email')?.value || '';
                        const phone = contactRow.querySelector('.contact-phone')?.value || '';
                        if (name || email || phone) {
                            contacts.push({ name, email, phone });
                        }
                    });

                    const nextActionDate = row.querySelector('.next-action-date')?.value || '';
                    const meetingConfirmed = row.querySelector('.meeting-confirmed')?.checked || false;

                    stakeholderData[client.code] = {
                        priority: row.querySelector('.priority-select')?.value || 'Medium',
                        meetingStatus: row.querySelector('.meeting-select')?.value || 'Not Scheduled',
                        contacts: contacts,
                        contactMethod: row.querySelector('.contact-method-select')?.value || '',
                        contactDetail: row.querySelector('.contact-detail')?.value || '',
                        purpose: row.querySelector('.why-input')?.value || '',
                        nextActionDate: nextActionDate,
                        meetingConfirmed: meetingConfirmed,
                        emailSent: row.querySelector('.email-sent-checkbox')?.checked || false
                    };

                    // Sync meeting to calendar if date is set, or remove if cleared
                    if (nextActionDate) {
                        syncMeetingToCalendar(client.code, client.name, nextActionDate, meetingConfirmed,
                            contacts[0]?.name || (client.contactInfo?.[0]?.name || ''),
                            stakeholderData[client.code].purpose);
                    } else {
                        // Remove meeting if date was cleared
                        const idx = stakeholderMeetings.findIndex(m => m.clientCode === client.code);
                        if (idx >= 0) {
                            stakeholderMeetings.splice(idx, 1);
                        }
                    }
                }
            });

            // Always save to localStorage (perpetual local backup)
            localStorage.setItem('stakeholders_data', JSON.stringify(stakeholderData));
            localStorage.setItem('stakeholder_meetings', JSON.stringify(stakeholderMeetings));
            saveMeetings(); // Ensure meetings are saved

            // Also try to save to daemon if connected
            saveStakeholdersToAPI();
        }

        function syncMeetingToCalendar(clientCode, clientName, dateStr, confirmed, contact, purpose) {
            // Find existing meeting for this client
            const existingIdx = stakeholderMeetings.findIndex(m => m.clientCode === clientCode);

            const meeting = {
                id: existingIdx >= 0 ? stakeholderMeetings[existingIdx].id : Date.now(),
                clientCode: clientCode,
                clientName: clientName,
                date: dateStr,
                status: confirmed ? 'scheduled' : 'requested',
                contact: contact,
                purpose: purpose || ''
            };

            if (existingIdx >= 0) {
                stakeholderMeetings[existingIdx] = meeting;
            } else {
                stakeholderMeetings.push(meeting);
            }
        }

        function syncToCalendar(clientCode, dateStr) {
            if (!dateStr) return;

            const client = stakeholderClients.find(c => c.code === clientCode);
            if (!client) return;

            // Check if meeting already exists for this client on this date
            const existingIdx = stakeholderMeetings.findIndex(m => m.clientCode === clientCode && m.date === dateStr);

            if (existingIdx === -1) {
                // Add new meeting to calendar
                const data = stakeholderData[clientCode] || {};
                const primaryContact = data.contacts?.[0]?.name || (client.contactInfo?.[0]?.name || '');

                stakeholderMeetings.push({
                    id: Date.now(),
                    clientCode: clientCode,
                    clientName: client.name,
                    date: dateStr,
                    status: data.meetingConfirmed ? 'scheduled' : 'requested',
                    contact: primaryContact,
                    purpose: data.purpose || ''
                });

                saveMeetings();
                showNotification(`Meeting with ${client.name} added to calendar`, 'success');
            }
        }

        async function saveStakeholdersToAPI() {
            try {
                const response = await fetch(`${API_BASE}/stakeholders`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        stakeholders: stakeholderData,
                        meetings: stakeholderMeetings
                    })
                });
                if (response.ok) {
                    showNotification('Saved to Promethean Light', 'success');
                } else {
                    showNotification('Saved locally (daemon offline)', 'warning');
                }
            } catch (e) {
                showNotification('Saved locally (daemon offline)', 'warning');
            }
        }

        function showNotification(message, type) {
            const existing = document.querySelector('.save-notification');
            if (existing) existing.remove();

            const notification = document.createElement('div');
            notification.className = 'save-notification';
            notification.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 8px;
                font-size: 13px;
                font-weight: 500;
                z-index: 9999;
                animation: slideIn 0.3s ease;
                background: ${type === 'success' ? 'rgba(23, 191, 99, 0.9)' : 'rgba(245, 166, 35, 0.9)'};
                color: ${type === 'success' ? '#fff' : '#1a2332'};
            `;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => notification.remove(), 3000);
        }

        function getTypeClass(type) {
            return type.toLowerCase().replace(' ', '-');
        }

        function getTypeTooltip(type) {
            const tooltips = {
                'Developer': 'Project Developer - Originates and develops renewable energy projects. Commissions grid connection studies to secure network access, needs GPS, EMT models, and NER compliance for AEMO registration.',
                'EPC': 'Engineering, Procurement & Construction - Builds the project. Often procures grid studies on behalf of developers, coordinates OEM models, and manages technical interface with NSPs.',
                'OEM': 'Original Equipment Manufacturer - Supplies inverters, turbines, BESS. Provides EMT/PSCAD models for grid studies. Key for model validation and tuning during commissioning.',
                'NSP': 'Network Service Provider - Owns/operates the transmission or distribution network. Reviews connection applications, sets technical requirements, approves GPS and models.',
                'AEMO': 'Australian Energy Market Operator - Market and system operator. Sets NER requirements, conducts GPS assessments, approves generator registration and model compliance.',
                'Asset Owner': 'Owns operating assets - May need studies for upgrades, re-tuning, capacity changes, or ongoing compliance. Often has existing AEMO-registered models.',
                'Investor': 'Financial Investor - Funds projects, requires technical due diligence on grid connection risk, model quality, and NER compliance status before investment.',
                'Consultant': 'Technical Consultant - Peer reviewer or advisor. May sub-contract studies, review deliverables, or provide independent technical opinions on grid connection matters.'
            };
            return tooltips[type] || type;
        }

        function getDaysUntil(dateStr) {
            const date = new Date(dateStr);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const diff = Math.ceil((date - today) / (1000 * 60 * 60 * 24));
            if (diff === 0) return 'Today';
            if (diff === 1) return 'Tomorrow';
            if (diff < 0) return 'OVERDUE';
            return `${diff} days`;
        }

        let currentSortColumn = null;
        let sortAscending = true;

        function sortStakeholderTable(column) {
            if (currentSortColumn === column) {
                sortAscending = !sortAscending;
            } else {
                currentSortColumn = column;
                sortAscending = true;
            }

            // Update filter dropdown sort value to match
            const sortSelect = document.getElementById('stakeholderSort');
            if (sortSelect && column === 'name') sortSelect.value = 'name';
            else if (sortSelect && column === 'priority') sortSelect.value = 'priority';
            else if (sortSelect && column === 'status') sortSelect.value = 'status';

            renderStakeholders();
        }

        function renderStakeholders() {
            const filter = document.getElementById('stakeholderFilter')?.value || 'all';
            const sort = document.getElementById('stakeholderSort')?.value || 'priority';
            const tbody = document.getElementById('stakeholderTableBody');
            const summary = document.getElementById('stakeholderSummary');

            let clients = [...stakeholderClients];

            // Filter
            if (filter === 'needsMeeting') {
                clients = clients.filter(c => {
                    const data = stakeholderData[c.code] || {};
                    return !data.meetingStatus || data.meetingStatus === 'Not Scheduled' || data.meetingStatus === 'Requested';
                });
            } else if (filter === 'scheduled') {
                clients = clients.filter(c => {
                    const data = stakeholderData[c.code] || {};
                    return data.meetingStatus === 'Scheduled';
                });
            } else if (filter === 'active') {
                clients = clients.filter(c => c.activeProjects && c.activeProjects.length > 0);
            } else if (filter === 'high') {
                clients = clients.filter(c => {
                    const data = stakeholderData[c.code] || {};
                    return data.priority === 'High';
                });
            } else if (filter === 'hot') {
                clients = clients.filter(c => c.hot === true);
            }

            // Sort - use currentSortColumn if set, otherwise use dropdown
            const sortBy = currentSortColumn || sort;
            const direction = sortAscending ? 1 : -1;

            if (sortBy === 'name') {
                clients.sort((a, b) => direction * a.name.localeCompare(b.name));
            } else if (sortBy === 'priority') {
                const priorityOrder = { 'High': 0, 'Medium': 1, 'Low': 2 };
                clients.sort((a, b) => {
                    const pa = stakeholderData[a.code]?.priority || 'Medium';
                    const pb = stakeholderData[b.code]?.priority || 'Medium';
                    return direction * ((priorityOrder[pa] || 1) - (priorityOrder[pb] || 1));
                });
            } else if (sortBy === 'status' || sortBy === 'meeting') {
                const statusOrder = { 'Not Scheduled': 0, 'Requested': 1, 'Scheduled': 2, 'Completed': 3 };
                clients.sort((a, b) => {
                    const sa = stakeholderData[a.code]?.meetingStatus || 'Not Scheduled';
                    const sb = stakeholderData[b.code]?.meetingStatus || 'Not Scheduled';
                    return direction * ((statusOrder[sa] || 0) - (statusOrder[sb] || 0));
                });
            } else if (sortBy === 'type') {
                clients.sort((a, b) => direction * a.type.localeCompare(b.type));
            } else if (sortBy === 'activeProjects') {
                clients.sort((a, b) => direction * ((b.activeProjects?.length || 0) - (a.activeProjects?.length || 0)));
            } else if (sortBy === 'previousProjects') {
                clients.sort((a, b) => direction * ((b.completedProjects?.length || 0) - (a.completedProjects?.length || 0)));
            } else if (sortBy === 'nextAction') {
                clients.sort((a, b) => {
                    const da = stakeholderData[a.code]?.nextActionDate || '9999-12-31';
                    const db = stakeholderData[b.code]?.nextActionDate || '9999-12-31';
                    return direction * da.localeCompare(db);
                });
            }

            const contactMethods = ['Email', 'Call', 'LinkedIn', 'Intro Request', 'Meeting'];

            let html = '';
            clients.forEach(client => {
                const data = stakeholderData[client.code] || {};
                const priority = data.priority || 'Medium';
                const meetingStatus = data.meetingStatus || 'Not Scheduled';
                const contactMethod = data.contactMethod || '';
                const isConfirmed = data.meetingConfirmed || false;

                // Build contacts HTML - show all contacts from contactInfo stacked
                let contactsHtml = '';
                if (client.contactInfo && client.contactInfo.length > 0) {
                    client.contactInfo.forEach((contact, idx) => {
                        const savedContact = data.contacts?.[idx] || {};
                        contactsHtml += `
                            <div class="contact-row" style="display: grid; grid-template-columns: 140px 180px 120px; gap: 6px; margin-bottom: 6px; align-items: center;">
                                <input type="text" class="stakeholder-input contact-name" data-idx="${idx}" value="${savedContact.name || contact.name}" placeholder="Name" style="font-weight: 600; color: var(--accent); font-size: 12px;">
                                <input type="email" class="stakeholder-input contact-email" data-idx="${idx}" value="${savedContact.email || contact.email}" placeholder="email@company.com" style="font-size: 11px;">
                                <input type="tel" class="stakeholder-input contact-phone" data-idx="${idx}" value="${savedContact.phone || contact.phone}" placeholder="Phone" style="font-size: 11px;">
                            </div>
                        `;
                    });
                } else {
                    // No contacts defined - show empty row for adding
                    contactsHtml = `
                        <div class="contact-row" style="display: grid; grid-template-columns: 140px 180px 120px; gap: 6px; margin-bottom: 6px; align-items: center;">
                            <input type="text" class="stakeholder-input contact-name" data-idx="0" value="${data.contacts?.[0]?.name || ''}" placeholder="Contact name" style="font-weight: 600; color: var(--accent); font-size: 12px;">
                            <input type="email" class="stakeholder-input contact-email" data-idx="0" value="${data.contacts?.[0]?.email || ''}" placeholder="email@company.com" style="font-size: 11px;">
                            <input type="tel" class="stakeholder-input contact-phone" data-idx="0" value="${data.contacts?.[0]?.phone || ''}" placeholder="Phone" style="font-size: 11px;">
                        </div>
                    `;
                }

                html += `
                    <tr data-code="${client.code}">
                        <td>
                            <select class="stakeholder-select priority-select" style="background: ${priority === 'High' ? 'rgba(224,36,94,0.15)' : priority === 'Medium' ? 'rgba(245,166,35,0.15)' : 'rgba(101,119,134,0.15)'}; color: ${priority === 'High' ? '#e0245e' : priority === 'Medium' ? '#f5a623' : '#657786'}; font-weight: 600;">
                                <option value="High" ${priority === 'High' ? 'selected' : ''}>High</option>
                                <option value="Medium" ${priority === 'Medium' ? 'selected' : ''}>Medium</option>
                                <option value="Low" ${priority === 'Low' ? 'selected' : ''}>Low</option>
                            </select>
                        </td>
                        <td>
                            <select class="stakeholder-select meeting-select" style="background: ${meetingStatus === 'Not Scheduled' ? 'rgba(224,36,94,0.15)' : meetingStatus === 'Requested' ? 'rgba(245,166,35,0.15)' : meetingStatus === 'Scheduled' ? 'rgba(69,183,209,0.15)' : 'rgba(23,191,99,0.15)'}; color: ${meetingStatus === 'Not Scheduled' ? '#e0245e' : meetingStatus === 'Requested' ? '#f5a623' : meetingStatus === 'Scheduled' ? '#45b7d1' : '#17bf63'}; font-weight: 600; font-size: 10px;">
                                <option value="Not Scheduled" ${meetingStatus === 'Not Scheduled' ? 'selected' : ''}>Need Outreach</option>
                                <option value="Requested" ${meetingStatus === 'Requested' ? 'selected' : ''}>Reached Out</option>
                                <option value="Scheduled" ${meetingStatus === 'Scheduled' ? 'selected' : ''}>Meeting Set</option>
                                <option value="Completed" ${meetingStatus === 'Completed' ? 'selected' : ''}>Connected</option>
                            </select>
                        </td>
                        <td>
                            <div class="company-name" style="font-size: 13px; font-weight: 600;">${client.name}</div>
                            ${client.emailSent ? '<div style="font-size: 9px; color: #17bf63; margin-top: 2px;">&#9993; Email drafted</div>' : ''}
                        </td>
                        <td>
                            <span class="type-badge ${getTypeClass(client.type)}" title="${getTypeTooltip(client.type)}" style="cursor: help; font-size: 10px;">${client.type}</span>
                        </td>
                        <td>
                            ${contactsHtml}
                        </td>
                        <td>
                            <label style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px; cursor: pointer;">
                                <input type="checkbox" class="email-sent-checkbox" ${data.emailSent ? 'checked' : ''} style="accent-color: #17bf63; width: 14px; height: 14px;">
                                <span style="font-size: 10px; color: ${data.emailSent ? '#17bf63' : 'var(--text-muted)'};">${data.emailSent ? 'Emailed' : 'Email?'}</span>
                            </label>
                            <select class="stakeholder-select contact-method-select" style="margin-bottom: 4px;">
                                <option value="">Method...</option>
                                ${contactMethods.map(m => `<option value="${m}" ${contactMethod === m ? 'selected' : ''}>${m}</option>`).join('')}
                            </select>
                            <input type="text" class="stakeholder-input contact-detail" value="${data.contactDetail || ''}" placeholder="LinkedIn / Referral" style="font-size: 10px;">
                        </td>
                        <td>
                            <textarea class="stakeholder-textarea why-input" placeholder="Why connect? What's the opportunity?">${data.purpose || ''}</textarea>
                        </td>
                        <td>
                            <input type="date" class="stakeholder-input next-action-date" value="${data.nextActionDate || ''}" style="font-size: 11px; margin-bottom: 6px;">
                            <label style="display: flex; align-items: center; gap: 6px; font-size: 10px; color: var(--text-secondary); cursor: pointer;">
                                <input type="checkbox" class="meeting-confirmed" ${isConfirmed ? 'checked' : ''} style="accent-color: var(--success);">
                                <span style="color: ${isConfirmed ? '#17bf63' : 'var(--text-muted)'};">${isConfirmed ? 'Confirmed' : 'Planned'}</span>
                            </label>
                            ${data.nextActionDate ? `<div style="font-size: 9px; margin-top: 4px; color: ${new Date(data.nextActionDate) < new Date() ? '#e0245e' : '#17bf63'};">${new Date(data.nextActionDate) < new Date() ? 'OVERDUE' : getDaysUntil(data.nextActionDate)}</div>` : ''}
                        </td>
                        <td>
                            ${client.hot ? `<div style="display: flex; align-items: center; gap: 4px; margin-bottom: 4px;"><span class="pulse-dot-header" style="width: 8px; height: 8px;"></span><span style="font-size: 10px; color: var(--accent); font-weight: 600;">UPCOMING</span></div><div style="font-size: 9px; color: var(--warning); margin-bottom: 4px;">${client.hotNote || 'Project on radar'}</div>` : ''}
                            ${client.activeProjects && client.activeProjects.length > 0
                                ? `<div>${client.activeProjects.map(p => `<span class="project-tag" title="${p}">${getProjectName(p)}</span>`).join('')}</div>`
                                : '<span style="font-size: 10px; color: var(--text-muted); font-style: italic;">None</span>'}
                        </td>
                        <td>
                            ${client.completedProjects && client.completedProjects.length > 0
                                ? `<div>${client.completedProjects.map(p => `<span class="project-tag" style="background: rgba(101,119,134,0.2); color: var(--text-secondary);" title="${p}">${getProjectName(p)}</span>`).join('')}</div>`
                                : '<span style="font-size: 10px; color: var(--text-muted); font-style: italic;">None</span>'}
                        </td>
                        <td>
                            ${client.vysusPM ? `<span style="font-size: 11px; color: var(--text-primary); font-weight: 500;">${client.vysusPM}</span>` : '<span style="font-size: 10px; color: var(--text-muted);">-</span>'}
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;

            // Summary
            const allData = stakeholderClients.map(c => stakeholderData[c.code] || {});
            const hotProspects = stakeholderClients.filter(c => c.hot === true).length;
            const needsOutreach = allData.filter(d => !d.meetingStatus || d.meetingStatus === 'Not Scheduled').length;
            const reachedOut = allData.filter(d => d.meetingStatus === 'Requested').length;
            const meetingSet = allData.filter(d => d.meetingStatus === 'Scheduled').length;
            const connected = allData.filter(d => d.meetingStatus === 'Completed').length;
            const highPriority = allData.filter(d => d.priority === 'High').length;

            summary.innerHTML = `
                <div class="stakeholder-summary-item"><span class="pulse-dot-header" style="width: 6px; height: 6px; margin-right: 6px;"></span><strong>Pipeline:</strong></div>
                <div class="stakeholder-summary-item" style="cursor: pointer;" onclick="document.getElementById('stakeholderFilter').value='hot'; renderStakeholders();">Hot: <strong style="color: var(--accent);">${hotProspects}</strong></div>
                <div class="stakeholder-summary-item">Outreach: <strong style="color: #e0245e;">${needsOutreach}</strong></div>
                <div class="stakeholder-summary-item">Reached: <strong style="color: #f5a623;">${reachedOut}</strong></div>
                <div class="stakeholder-summary-item">Booked: <strong style="color: #45b7d1;">${meetingSet}</strong></div>
                <div class="stakeholder-summary-item">Done: <strong style="color: #17bf63;">${connected}</strong></div>
                <div class="stakeholder-summary-item" style="margin-left: auto;">High: <strong style="color: #e0245e;">${highPriority}</strong></div>
            `;
        }

        function switchTab(tabName) {
            currentTab = tabName;

            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tab === tabName);
            });

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.toggle('active', content.id === `tab-${tabName}`);
            });

            // Show/hide elements based on tab
            const weekSelector = document.getElementById('weekSelectorContainer');
            const summaryPanel = document.getElementById('summaryPanel');

            if (tabName === 'projects') {
                weekSelector.style.display = 'flex';
                summaryPanel.style.display = 'flex';
            } else {
                weekSelector.style.display = 'none';
                summaryPanel.style.display = 'none';
            }

            // Render radar if switching to it
            if (tabName === 'radar') {
                renderRadar();
            }

            // Render stakeholders if switching to it
            if (tabName === 'stakeholders') {
                renderStakeholders();
                // Set up auto-save after rendering
                setTimeout(setupStakeholderAutoSave, 100);
            }

            // Render stakeholder calendar if switching to it
            if (tabName === 'calendar') {
                loadMeetings(); // Sync meetings from stakeholder data
                renderStakeholderCalendar();
            }

            // Render industry map if switching to it
            if (tabName === 'map') {
                renderStakeholderContactsGrid();
                initFlashcards();
            }

            // Render drill tab if switching to it
            if (tabName === 'drill') {
                loadDrillProgress();
                renderDrillCards();
            }
        }

        // ============ LEARNING CENTER FUNCTIONS ============

        const flashcardData = [
            { term: 'GPS', definition: 'Generator Performance Standards - technical requirements for NEM connection', category: 'aemo' },
            { term: 'R1', definition: 'Pre-construction registration stage - model submission before building', category: 'aemo' },
            { term: 'R2', definition: 'As-built registration - final model after construction', category: 'aemo' },
            { term: '5.3.4a', definition: 'AEMO letter confirming R1 acceptance - unlocks bank finance (FID)', category: 'aemo' },
            { term: 'DMAT', definition: 'Dynamic Model Acceptance Test - 200+ simulations to validate models', category: 'technical' },
            { term: 'PSCAD', definition: 'Power system simulation software for EMT modelling', category: 'technical' },
            { term: 'GFM', definition: 'Grid-Forming Inverter - creates voltage reference independently', category: 'technical' },
            { term: 'S5.2.5.15', definition: 'NER System Strength clause - must not adversely affect grid stability', category: 'technical' },
            { term: 'FID', definition: 'Final Investment Decision - when bank finance is released', category: 'commercial' },
            { term: 'COD', definition: 'Commercial Operation Date - plant generating revenue', category: 'commercial' },
            { term: 'NSP', definition: 'Network Service Provider - owns/operates grid (AusNet, Transgrid)', category: 'industry' },
            { term: 'NEM', definition: 'National Electricity Market - QLD, NSW, VIC, SA, TAS (not WA)', category: 'industry' },
            { term: 'EPC', definition: 'Engineering, Procurement, Construction - turnkey contractors', category: 'industry' },
            { term: 'OEM', definition: 'Original Equipment Manufacturer - Vestas, Goldwind, SMA, Sungrow', category: 'industry' },
            { term: 'IBR', definition: 'Inverter-Based Resource - solar, wind, BESS connected via inverters', category: 'technical' },
            { term: 'PSS/E', definition: 'Power System Simulator - Siemens software for steady-state studies', category: 'technical' }
        ];

        let flashcardScore = 0;
        let contactQuizStreak = 0;
        let currentQuizAnswer = null;

        function toggleLearningCenter() {
            const content = document.getElementById('learningContent');
            const chevron = document.getElementById('learningChevron');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                chevron.style.transform = 'rotate(180deg)';
                initFlashcards();
            } else {
                content.style.display = 'none';
                chevron.style.transform = 'rotate(0deg)';
            }
        }

        function showLearningTab(tab) {
            ['flashcards', 'contacts', 'process', 'glossary'].forEach(t => {
                document.getElementById(`learning-${t}`).style.display = t === tab ? 'block' : 'none';
                document.getElementById(`btn-${t}`).style.opacity = t === tab ? '1' : '0.6';
            });
            if (tab === 'contacts') nextContactQuestion();
        }

        function initFlashcards() {
            const grid = document.getElementById('flashcards-grid');
            if (!grid) return;
            document.getElementById('flashcard-total').textContent = flashcardData.length;
            renderFlashcards();
        }

        function renderFlashcards() {
            const grid = document.getElementById('flashcards-grid');
            grid.innerHTML = flashcardData.map((card, i) => `
                <div class="flashcard" onclick="flipCard(this, ${i})">
                    <div class="flashcard-front">
                        <div class="flashcard-term">${card.term}</div>
                        <div class="flashcard-hint">Click to reveal</div>
                    </div>
                    <div class="flashcard-back">
                        <div class="flashcard-definition">${card.definition}</div>
                    </div>
                </div>
            `).join('');
        }

        function flipCard(el, index) {
            if (!el.classList.contains('flipped')) {
                el.classList.add('flipped');
                flashcardScore++;
                document.getElementById('flashcard-score').textContent = flashcardScore;
            }
        }

        function shuffleFlashcards() {
            flashcardData.sort(() => Math.random() - 0.5);
            flashcardScore = 0;
            document.getElementById('flashcard-score').textContent = '0';
            renderFlashcards();
        }

        function nextContactQuestion() {
            const quizArea = document.getElementById('contact-quiz-area');
            // Get all contacts from stakeholderClients
            const allContacts = [];
            stakeholderClients.forEach(client => {
                if (client.contactInfo && client.contactInfo.length > 0) {
                    client.contactInfo.forEach(contact => {
                        if (contact.name && contact.name !== 'VSIR Compliance' && !contact.name.includes('Team') && !contact.name.includes('Mailbox')) {
                            allContacts.push({ ...contact, company: client.name, code: client.code });
                        }
                    });
                }
            });

            if (allContacts.length < 4) {
                quizArea.innerHTML = '<div style="color: var(--text-muted);">Need more contacts to generate quiz</div>';
                return;
            }

            // Pick random contact
            const correctIndex = Math.floor(Math.random() * allContacts.length);
            const correct = allContacts[correctIndex];
            currentQuizAnswer = correct.company;

            // Get 3 wrong answers
            const wrongOptions = allContacts.filter((_, i) => i !== correctIndex)
                .sort(() => Math.random() - 0.5)
                .slice(0, 3)
                .map(c => c.company);

            // Combine and shuffle options
            const options = [correct.company, ...wrongOptions].sort(() => Math.random() - 0.5);

            quizArea.innerHTML = `
                <div style="font-size: 18px; color: var(--text-primary); margin-bottom: 8px;">${correct.name}</div>
                <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 20px;">${correct.role || 'Contact'}</div>
                <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">Which company?</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    ${options.map(opt => `
                        <button class="quiz-btn" onclick="checkAnswer(this, '${opt}')" style="padding: 12px 16px;">${opt}</button>
                    `).join('')}
                </div>
            `;
        }

        function checkAnswer(btn, answer) {
            const buttons = btn.parentElement.querySelectorAll('.quiz-btn');
            buttons.forEach(b => {
                b.disabled = true;
                if (b.textContent === currentQuizAnswer) {
                    b.classList.add('correct');
                } else if (b === btn && answer !== currentQuizAnswer) {
                    b.classList.add('incorrect');
                }
            });

            if (answer === currentQuizAnswer) {
                contactQuizStreak++;
            } else {
                contactQuizStreak = 0;
            }
            document.getElementById('contact-streak').textContent = contactQuizStreak;
        }

        function toggleProcessDetail(el) {
            const detail = el.querySelector('.process-detail');
            const arrow = el.querySelector('span:last-child');
            if (detail.style.display === 'none') {
                detail.style.display = 'block';
                arrow.textContent = '▲';
            } else {
                detail.style.display = 'none';
                arrow.textContent = '▼';
            }
        }

        // Render stakeholder contacts grid from stakeholderClients data
        function renderStakeholderContactsGrid() {
            const grid = document.getElementById('stakeholder-contacts-grid');
            if (!grid) return;

            const typeColors = {
                'AEMO': '#e0245e',
                'Developer': '#45b7d1',
                'Investor': '#BB8FCE',
                'NSP': '#96CEB4',
                'EPC': '#f5a623',
                'OEM': '#DDA0DD',
                'Asset Owner': '#45b7d1',
                'Consultant': '#00d4aa',
                'Recruiter': '#9b59b6'
            };

            let contactCount = 0;
            let html = '';

            stakeholderClients.forEach(client => {
                if (client.contactInfo && client.contactInfo.length > 0) {
                    client.contactInfo.forEach(contact => {
                        if (contact.name) {
                            contactCount++;
                            const color = typeColors[client.type] || '#657786';
                            html += `
                                <div style="background: var(--bg-main); border-radius: 8px; padding: 12px; border-left: 3px solid ${color};">
                                    <div style="font-weight: 600; color: var(--text-primary); font-size: 12px;">${contact.name}</div>
                                    <div style="font-size: 10px; color: ${color}; margin-top: 2px;">${client.name}</div>
                                    <div style="font-size: 10px; color: var(--text-muted); margin-top: 2px;">${contact.role || ''}</div>
                                    ${contact.email ? `<div style="font-size: 10px; color: #45b7d1; margin-top: 4px; word-break: break-all;">${contact.email}</div>` : ''}
                                    ${contact.phone ? `<div style="font-size: 10px; color: var(--success); margin-top: 2px;">📱 ${contact.phone}</div>` : ''}
                                </div>
                            `;
                        }
                    });
                }
            });

            grid.innerHTML = html || '<div style="color: var(--text-muted); grid-column: 1/-1; text-align: center;">No contacts found</div>';
            document.getElementById('contact-count').textContent = contactCount;
        }

        function renderRadar() {
            // Radar content is now static HTML
        }

        // =====================
        // STAKEHOLDER CALENDAR
        // =====================
        let stakeholderCalendarMonth = new Date(2025, 0, 1); // January 2025
        let stakeholderMeetings = [];

        function loadMeetings() {
            // First reload from localStorage to get latest saved meetings
            const savedMeetings = localStorage.getItem('stakeholder_meetings');
            if (savedMeetings) {
                try {
                    stakeholderMeetings = JSON.parse(savedMeetings);
                } catch (e) {
                    console.log('Error parsing meetings:', e);
                }
            }

            // Also reload stakeholder data from localStorage
            const savedData = localStorage.getItem('stakeholders_data');
            if (savedData) {
                try {
                    stakeholderData = JSON.parse(savedData);
                } catch (e) {
                    console.log('Error parsing stakeholder data:', e);
                }
            }

            // Now sync from stakeholder data to fill any gaps
            stakeholderClients.forEach(client => {
                const data = stakeholderData[client.code];
                if (data && data.nextActionDate) {
                    const exists = stakeholderMeetings.find(m => m.clientCode === client.code);
                    if (!exists) {
                        // Add meeting from stakeholder data
                        stakeholderMeetings.push({
                            id: Date.now() + Math.random(),
                            clientCode: client.code,
                            clientName: client.name,
                            date: data.nextActionDate,
                            status: data.meetingConfirmed ? 'scheduled' : 'requested',
                            contact: data.contacts?.[0]?.name || (client.contactInfo?.[0]?.name || ''),
                            purpose: data.purpose || ''
                        });
                    } else {
                        // Update existing meeting with latest data from stakeholder
                        exists.date = data.nextActionDate;
                        exists.status = data.meetingConfirmed ? 'scheduled' : 'requested';
                        exists.contact = data.contacts?.[0]?.name || exists.contact;
                        exists.purpose = data.purpose || exists.purpose;
                    }
                }
            });

            // Save the synced state
            saveMeetings();
        }

        function saveMeetings() {
            localStorage.setItem('stakeholder_meetings', JSON.stringify(stakeholderMeetings));
        }

        function changeCalendarMonth(direction) {
            stakeholderCalendarMonth.setMonth(stakeholderCalendarMonth.getMonth() + direction);
            renderStakeholderCalendar();
        }

        function renderStakeholderCalendar() {
            loadMeetings();
            const grid = document.getElementById('calendarGrid');
            const title = document.getElementById('calendarMonthTitle');
            const upcomingList = document.getElementById('upcomingMeetingsList');

            const year = stakeholderCalendarMonth.getFullYear();
            const month = stakeholderCalendarMonth.getMonth();
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

            title.textContent = `${monthNames[month]} ${year}`;

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startOffset = firstDay.getDay(); // 0 = Sunday

            let html = '';
            // Day headers
            ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
                html += `<div class="calendar-day-header-cell">${day}</div>`;
            });

            // Empty cells before first day
            for (let i = 0; i < startOffset; i++) {
                const prevMonthDay = new Date(year, month, 0 - startOffset + i + 1);
                html += `<div class="calendar-day-cell other-month" onclick="selectCalendarDate('${prevMonthDay.toISOString().split('T')[0]}')">
                    <div class="calendar-day-number">${prevMonthDay.getDate()}</div>
                </div>`;
            }

            // Days of month
            const today = new Date();
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const isToday = today.toISOString().split('T')[0] === dateStr;

                // Filter meetings for this date - compare date strings directly first
                const dayMeetings = stakeholderMeetings.filter(m => {
                    if (!m.date) return false;
                    // Direct string comparison (most common case - YYYY-MM-DD format)
                    if (m.date === dateStr) return true;
                    // Also check with normalized parsing for edge cases
                    const parts = m.date.split('-');
                    if (parts.length === 3) {
                        const normalizedDate = `${parts[0]}-${parts[1].padStart(2, '0')}-${parts[2].padStart(2, '0')}`;
                        return normalizedDate === dateStr;
                    }
                    return false;
                });

                html += `<div class="calendar-day-cell${isToday ? ' today' : ''}" onclick="selectCalendarDate('${dateStr}')">
                    <div class="calendar-day-number">${day}</div>
                    ${dayMeetings.map(m => `<div class="calendar-meeting-item ${m.status}" title="${m.clientName}: ${m.contact}">${m.clientName}</div>`).join('')}
                </div>`;
            }

            // Fill remaining cells
            const totalCells = startOffset + lastDay.getDate();
            const remainingCells = (7 - (totalCells % 7)) % 7;
            for (let i = 1; i <= remainingCells; i++) {
                const nextMonthDay = new Date(year, month + 1, i);
                html += `<div class="calendar-day-cell other-month" onclick="selectCalendarDate('${nextMonthDay.toISOString().split('T')[0]}')">
                    <div class="calendar-day-number">${i}</div>
                </div>`;
            }

            grid.innerHTML = html;

            // Render upcoming meetings
            const upcoming = stakeholderMeetings
                .filter(m => new Date(m.date) >= new Date())
                .sort((a, b) => new Date(a.date) - new Date(b.date))
                .slice(0, 5);

            if (upcoming.length > 0) {
                upcomingList.innerHTML = upcoming.map(m => {
                    const date = new Date(m.date);
                    return `<div class="upcoming-meeting-card">
                        <div class="meeting-info">
                            <h4>${m.clientName}</h4>
                            <p>${m.contact || 'No contact specified'} • ${m.purpose || 'Relationship building'}</p>
                        </div>
                        <div class="meeting-date-badge">
                            <div class="day">${date.getDate()}</div>
                            <div class="month">${monthNames[date.getMonth()].slice(0, 3)}</div>
                        </div>
                    </div>`;
                }).join('');
            } else {
                upcomingList.innerHTML = `<div style="text-align: center; padding: 40px; color: var(--text-muted);">
                    <p style="font-size: 14px;">No upcoming meetings scheduled</p>
                    <p style="font-size: 12px; margin-top: 8px;">Click a date or use the Stakeholders tab to schedule meetings</p>
                </div>`;
            }
        }

        function selectCalendarDate(dateStr) {
            const clientOptions = stakeholderClients.map(c => `<option value="${c.code}">${c.name}</option>`).join('');
            const popup = document.createElement('div');
            popup.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 24px; z-index: 10000; min-width: 400px; box-shadow: 0 20px 60px rgba(0,0,0,0.5);';
            popup.innerHTML = `
                <h3 style="color: var(--accent); margin-bottom: 16px;">Schedule Meeting</h3>
                <div style="margin-bottom: 12px;">
                    <label style="display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Date</label>
                    <input type="date" id="meetingDate" value="${dateStr}" style="width: 100%; padding: 8px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                </div>
                <div style="margin-bottom: 12px;">
                    <label style="display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Stakeholder</label>
                    <select id="meetingClient" style="width: 100%; padding: 8px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                        ${clientOptions}
                    </select>
                </div>
                <div style="margin-bottom: 12px;">
                    <label style="display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Contact</label>
                    <select id="meetingContact" style="width: 100%; padding: 8px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                        <option value="">-- Select contact --</option>
                    </select>
                    <input type="text" id="meetingContactCustom" placeholder="Or type custom contact name" style="width: 100%; padding: 8px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); margin-top: 6px; font-size: 11px;">
                </div>
                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Purpose</label>
                    <input type="text" id="meetingPurpose" placeholder="Meeting purpose" style="width: 100%; padding: 8px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                </div>
                <div style="display: flex; gap: 8px; justify-content: flex-end;">
                    <button onclick="this.parentElement.parentElement.remove()" class="btn btn-secondary">Cancel</button>
                    <button onclick="createMeetingFromPopup()" class="btn btn-primary">Schedule</button>
                </div>
            `;
            document.body.appendChild(popup);

            // Function to update contact dropdown based on selected client
            function updateContactDropdown(clientCode) {
                const contactSelect = document.getElementById('meetingContact');
                const client = stakeholderClients.find(c => c.code === clientCode);
                let options = '<option value="">-- Select contact --</option>';

                if (client && client.contactInfo && client.contactInfo.length > 0) {
                    client.contactInfo.forEach(contact => {
                        if (contact.name) {
                            const roleInfo = contact.role ? ` (${contact.role})` : '';
                            options += `<option value="${contact.name}">${contact.name}${roleInfo}</option>`;
                        }
                    });
                }

                // Also add contacts from stakeholderData if any
                const data = stakeholderData[clientCode];
                if (data && data.contacts && data.contacts.length > 0) {
                    data.contacts.forEach(contact => {
                        if (contact.name && !options.includes(contact.name)) {
                            options += `<option value="${contact.name}">${contact.name}</option>`;
                        }
                    });
                }

                contactSelect.innerHTML = options;

                // Pre-select first contact if available
                if (client?.contactInfo?.[0]?.name) {
                    contactSelect.value = client.contactInfo[0].name;
                }
            }

            // Initial population
            updateContactDropdown(stakeholderClients[0]?.code);

            // Update contacts when client changes
            document.getElementById('meetingClient').addEventListener('change', function() {
                updateContactDropdown(this.value);
            });
        }

        function createMeetingFromPopup() {
            const dateStr = document.getElementById('meetingDate').value;
            if (!dateStr) {
                showNotification('Please select a date', 'error');
                return;
            }
            const clientCode = document.getElementById('meetingClient').value;
            const client = stakeholderClients.find(c => c.code === clientCode);
            const contactDropdown = document.getElementById('meetingContact').value;
            const contactCustom = document.getElementById('meetingContactCustom')?.value || '';
            const contact = contactCustom || contactDropdown; // Custom input takes precedence
            const purpose = document.getElementById('meetingPurpose').value;

            // Check if meeting already exists for this client, update if so
            const existingIdx = stakeholderMeetings.findIndex(m => m.clientCode === clientCode);
            const meeting = {
                id: existingIdx >= 0 ? stakeholderMeetings[existingIdx].id : Date.now(),
                clientCode: clientCode,
                clientName: client.name,
                date: dateStr,
                status: 'scheduled',
                contact: contact,
                purpose: purpose
            };

            if (existingIdx >= 0) {
                stakeholderMeetings[existingIdx] = meeting;
            } else {
                stakeholderMeetings.push(meeting);
            }

            saveMeetings();

            // Update stakeholder data with next action date
            if (!stakeholderData[clientCode]) stakeholderData[clientCode] = {};
            stakeholderData[clientCode].nextActionDate = dateStr;
            stakeholderData[clientCode].meetingStatus = 'Scheduled';
            stakeholderData[clientCode].meetingConfirmed = true;
            stakeholderData[clientCode].keyContact = contact;
            stakeholderData[clientCode].purpose = purpose;
            localStorage.setItem('stakeholders_data', JSON.stringify(stakeholderData));

            // Close popup
            const popup = document.querySelector('[onclick*="createMeetingFromPopup"]');
            if (popup) popup.parentElement.parentElement.remove();

            // Navigate to the month of the meeting
            const meetingDate = new Date(dateStr);
            stakeholderCalendarMonth = new Date(meetingDate.getFullYear(), meetingDate.getMonth(), 1);

            renderStakeholderCalendar();
            showNotification('Meeting scheduled for ' + dateStr + '!', 'success');
        }

        function addMeeting() {
            // Use a date from the currently displayed month (15th of the month as default)
            const year = stakeholderCalendarMonth.getFullYear();
            const month = stakeholderCalendarMonth.getMonth();
            const defaultDate = `${year}-${String(month + 1).padStart(2, '0')}-15`;
            selectCalendarDate(defaultDate);
        }

        // ============ DRILL TAB FUNCTIONS ============
        let drillScore = 0;
        let drillStreak = 0;
        let masteredContacts = new Set();
        let currentQuizQuestion = 0;
        let quizCorrectAnswer = '';
        let currentDrillFilter = 'all';
        let matchSelectedCard = null;
        let matchPairs = [];
        let matchStartTime = null;
        let matchTimerInterval = null;
        let rapidFireInterval = null;
        let rapidCorrect = 0;

        // Load drill progress from localStorage
        function loadDrillProgress() {
            const saved = localStorage.getItem('drill_progress');
            if (saved) {
                const data = JSON.parse(saved);
                drillScore = data.score || 0;
                masteredContacts = new Set(data.mastered || []);
            }
            updateDrillStats();
        }

        // Save drill progress
        function saveDrillProgress() {
            localStorage.setItem('drill_progress', JSON.stringify({
                score: drillScore,
                mastered: [...masteredContacts]
            }));
        }

        // Update stats display
        function updateDrillStats() {
            document.getElementById('drillScore').textContent = drillScore;
            document.getElementById('drillStreak').textContent = drillStreak;
            const totalContacts = getAllContacts().length;
            document.getElementById('drillMastered').innerHTML = `${masteredContacts.size}/<span id="drillTotal">${totalContacts}</span>`;
        }

        // Get all contacts from stakeholderClients
        function getAllContacts() {
            const contacts = [];
            stakeholderClients.forEach(client => {
                if (client.contactInfo && client.contactInfo.length > 0) {
                    client.contactInfo.forEach(contact => {
                        if (contact.name) {
                            contacts.push({
                                name: contact.name,
                                role: contact.role || '',
                                email: contact.email || '',
                                phone: contact.phone || '',
                                company: client.name,
                                companyCode: client.code,
                                type: client.type,
                                hot: client.hot || false,
                                hotNote: client.hotNote || '',
                                projects: client.activeProjects || []
                            });
                        }
                    });
                }
            });
            return contacts;
        }

        // Set drill mode
        function setDrillMode(mode) {
            document.querySelectorAll('.drill-mode-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.drill-mode-content').forEach(el => el.style.display = 'none');

            event.target.classList.add('active');
            document.getElementById(`drill-${mode}`).style.display = 'block';

            if (mode === 'cards') renderDrillCards();
            if (mode === 'quiz') startQuiz();
            if (mode === 'match') startMatchGame();
            if (mode === 'rapid') setupRapidFire();
        }

        // Filter drill cards
        function filterDrillCards(filter) {
            currentDrillFilter = filter;
            document.querySelectorAll('.drill-filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderDrillCards();
        }

        // Render drill cards
        function renderDrillCards() {
            const grid = document.getElementById('drill-cards-grid');
            let clients = [...stakeholderClients];

            // Filter
            if (currentDrillFilter === 'hot') {
                clients = clients.filter(c => c.hot);
            } else if (currentDrillFilter !== 'all') {
                clients = clients.filter(c => c.type === currentDrillFilter);
            }

            let html = '';
            clients.forEach(client => {
                if (!client.contactInfo || client.contactInfo.length === 0) return;

                const isMastered = client.contactInfo.every(c => masteredContacts.has(`${client.code}-${c.name}`));

                let contactsHtml = '';
                client.contactInfo.forEach(contact => {
                    if (!contact.name) return;
                    const contactKey = `${client.code}-${contact.name}`;
                    const isContactMastered = masteredContacts.has(contactKey);
                    contactsHtml += `
                        <div class="drill-card-contact" onclick="event.stopPropagation(); toggleMastered('${contactKey}')" style="${isContactMastered ? 'border-left: 3px solid #17bf63;' : ''}">
                            <div class="drill-card-contact-name">${contact.name} ${isContactMastered ? '<span style="color:#17bf63;">✓</span>' : ''}</div>
                            <div class="drill-card-contact-role">${contact.role}</div>
                            ${contact.email ? `<div class="drill-card-contact-details">${contact.email}</div>` : ''}
                            ${contact.phone ? `<div class="drill-card-contact-details" style="color:#17bf63;">${contact.phone}</div>` : ''}
                        </div>
                    `;
                });

                html += `
                    <div class="drill-card ${isMastered ? 'mastered' : ''}" onclick="markCompanyMastered('${client.code}')">
                        <div class="drill-card-company">${client.name}</div>
                        <div class="drill-card-type">${client.type}${client.hot ? ' <span style="color:#e0245e;">HOT</span>' : ''}</div>
                        ${contactsHtml}
                        ${client.hotNote ? `<div class="drill-card-note">${client.hotNote}</div>` : ''}
                        ${client.activeProjects?.length ? `<div style="font-size:10px; color:var(--text-muted); margin-top:8px;">Projects: ${client.activeProjects.join(', ')}</div>` : ''}
                    </div>
                `;
            });

            grid.innerHTML = html || '<div style="color: var(--text-muted); text-align: center; padding: 40px;">No contacts found</div>';
            updateDrillStats();
        }

        // Toggle mastered status for a contact
        function toggleMastered(contactKey) {
            if (masteredContacts.has(contactKey)) {
                masteredContacts.delete(contactKey);
                drillScore = Math.max(0, drillScore - 5);
            } else {
                masteredContacts.add(contactKey);
                drillScore += 10;
                drillStreak++;
            }
            saveDrillProgress();
            renderDrillCards();
        }

        // Mark all contacts in a company as mastered
        function markCompanyMastered(companyCode) {
            const client = stakeholderClients.find(c => c.code === companyCode);
            if (!client || !client.contactInfo) return;

            const allMastered = client.contactInfo.every(c => masteredContacts.has(`${companyCode}-${c.name}`));

            client.contactInfo.forEach(contact => {
                if (contact.name) {
                    const key = `${companyCode}-${contact.name}`;
                    if (allMastered) {
                        masteredContacts.delete(key);
                    } else {
                        masteredContacts.add(key);
                        drillScore += 10;
                    }
                }
            });

            if (!allMastered) drillStreak += client.contactInfo.length;
            saveDrillProgress();
            renderDrillCards();
        }

        // Quiz mode
        function startQuiz() {
            currentQuizQuestion = 0;
            generateQuizQuestion();
        }

        function generateQuizQuestion() {
            const contacts = getAllContacts().filter(c => c.name && c.company);
            if (contacts.length < 4) return;

            const questionTypes = ['company', 'contact', 'role', 'type'];
            const qType = questionTypes[Math.floor(Math.random() * questionTypes.length)];

            const correctContact = contacts[Math.floor(Math.random() * contacts.length)];
            let question = '';
            let options = [];

            if (qType === 'company') {
                question = `Who works at <strong style="color:var(--accent);">${correctContact.company}</strong>?`;
                quizCorrectAnswer = correctContact.name;
                options = [correctContact.name];
                const otherContacts = contacts.filter(c => c.company !== correctContact.company);
                while (options.length < 4 && otherContacts.length > 0) {
                    const idx = Math.floor(Math.random() * otherContacts.length);
                    if (!options.includes(otherContacts[idx].name)) {
                        options.push(otherContacts[idx].name);
                    }
                    otherContacts.splice(idx, 1);
                }
            } else if (qType === 'contact') {
                question = `Which company does <strong style="color:var(--accent);">${correctContact.name}</strong> work for?`;
                quizCorrectAnswer = correctContact.company;
                options = [correctContact.company];
                const otherCompanies = [...new Set(contacts.map(c => c.company))].filter(c => c !== correctContact.company);
                while (options.length < 4 && otherCompanies.length > 0) {
                    const idx = Math.floor(Math.random() * otherCompanies.length);
                    options.push(otherCompanies[idx]);
                    otherCompanies.splice(idx, 1);
                }
            } else if (qType === 'role') {
                question = `What is <strong style="color:var(--accent);">${correctContact.name}</strong>'s role at ${correctContact.company}?`;
                quizCorrectAnswer = correctContact.role;
                options = [correctContact.role];
                const otherRoles = [...new Set(contacts.map(c => c.role))].filter(r => r && r !== correctContact.role);
                while (options.length < 4 && otherRoles.length > 0) {
                    const idx = Math.floor(Math.random() * otherRoles.length);
                    options.push(otherRoles[idx]);
                    otherRoles.splice(idx, 1);
                }
            } else {
                question = `What type of company is <strong style="color:var(--accent);">${correctContact.company}</strong>?`;
                quizCorrectAnswer = correctContact.type;
                options = [correctContact.type];
                const types = ['Developer', 'OEM', 'EPC', 'NSP', 'AEMO', 'Investor', 'Consultant'];
                types.forEach(t => {
                    if (t !== correctContact.type && options.length < 4) options.push(t);
                });
            }

            // Shuffle options
            options = options.sort(() => Math.random() - 0.5);

            currentQuizQuestion++;
            document.getElementById('quiz-num').textContent = currentQuizQuestion;
            document.getElementById('quiz-prompt').innerHTML = question;
            document.getElementById('quiz-options').innerHTML = options.map(opt =>
                `<button class="quiz-option" onclick="checkQuizAnswer('${opt.replace(/'/g, "\\'")}')">${opt}</button>`
            ).join('');
            document.getElementById('quiz-feedback').style.display = 'none';
            document.getElementById('quiz-next-btn').style.display = 'none';
        }

        function checkQuizAnswer(answer) {
            const isCorrect = answer === quizCorrectAnswer;
            const feedback = document.getElementById('quiz-feedback');
            const options = document.querySelectorAll('.quiz-option');

            options.forEach(opt => {
                opt.classList.add('disabled');
                if (opt.textContent === quizCorrectAnswer) {
                    opt.classList.add('correct');
                } else if (opt.textContent === answer && !isCorrect) {
                    opt.classList.add('incorrect');
                }
            });

            if (isCorrect) {
                drillScore += 15;
                drillStreak++;
                feedback.innerHTML = '<span style="color:#17bf63;">Correct!</span> +15 points';
                feedback.style.background = 'rgba(23,191,99,0.2)';
            } else {
                drillStreak = 0;
                feedback.innerHTML = `<span style="color:#e0245e;">Wrong!</span> The answer was: <strong>${quizCorrectAnswer}</strong>`;
                feedback.style.background = 'rgba(224,36,94,0.2)';
            }

            feedback.style.display = 'block';
            document.getElementById('quiz-next-btn').style.display = 'inline-block';
            updateDrillStats();
            saveDrillProgress();
        }

        function nextQuizQuestion() {
            generateQuizQuestion();
        }

        // Match game
        function startMatchGame() {
            const contacts = getAllContacts().filter(c => c.name && c.company);
            const shuffled = contacts.sort(() => Math.random() - 0.5).slice(0, 6);

            matchPairs = [];
            shuffled.forEach((c, idx) => {
                matchPairs.push({ id: `name-${idx}`, value: c.name, type: 'name', pairId: idx });
                matchPairs.push({ id: `company-${idx}`, value: c.company, type: 'company', pairId: idx });
            });

            matchPairs = matchPairs.sort(() => Math.random() - 0.5);
            matchSelectedCard = null;

            document.getElementById('match-total').textContent = shuffled.length;
            document.getElementById('match-count').textContent = '0';

            const grid = document.getElementById('match-grid');
            grid.innerHTML = matchPairs.map(p => `
                <div class="match-card" data-id="${p.id}" data-pair="${p.pairId}" data-type="${p.type}" onclick="selectMatchCard(this)">
                    <span style="font-size: ${p.type === 'name' ? '14px' : '12px'}; color: ${p.type === 'name' ? 'var(--accent)' : 'var(--text-primary)'};">${p.value}</span>
                </div>
            `).join('');

            // Start timer
            matchStartTime = Date.now();
            if (matchTimerInterval) clearInterval(matchTimerInterval);
            matchTimerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - matchStartTime) / 1000);
                const mins = Math.floor(elapsed / 60);
                const secs = elapsed % 60;
                document.getElementById('match-timer').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
            }, 1000);
        }

        function selectMatchCard(card) {
            if (card.classList.contains('matched')) return;

            if (!matchSelectedCard) {
                matchSelectedCard = card;
                card.classList.add('selected');
            } else {
                const firstPair = matchSelectedCard.dataset.pair;
                const secondPair = card.dataset.pair;
                const firstType = matchSelectedCard.dataset.type;
                const secondType = card.dataset.type;

                if (firstPair === secondPair && firstType !== secondType) {
                    // Match!
                    matchSelectedCard.classList.remove('selected');
                    matchSelectedCard.classList.add('matched');
                    card.classList.add('matched');
                    drillScore += 20;
                    drillStreak++;

                    const matched = document.querySelectorAll('.match-card.matched').length / 2;
                    document.getElementById('match-count').textContent = matched;

                    if (matched === parseInt(document.getElementById('match-total').textContent)) {
                        clearInterval(matchTimerInterval);
                        drillScore += 50; // Bonus for completing
                        showNotification('Match complete! +50 bonus points!', 'success');
                    }
                } else {
                    // No match
                    card.classList.add('wrong');
                    matchSelectedCard.classList.add('wrong');
                    drillStreak = 0;
                    setTimeout(() => {
                        card.classList.remove('wrong');
                        matchSelectedCard.classList.remove('wrong', 'selected');
                        matchSelectedCard = null;
                    }, 300);
                    updateDrillStats();
                    saveDrillProgress();
                    return;
                }

                matchSelectedCard = null;
                updateDrillStats();
                saveDrillProgress();
            }
        }

        // Rapid fire mode
        function setupRapidFire() {
            document.getElementById('rapid-prompt').textContent = 'Click Start to begin!';
            document.getElementById('rapid-input').disabled = true;
            document.getElementById('rapid-input').value = '';
            document.getElementById('rapid-timer').textContent = '30';
            document.getElementById('rapid-start-btn').style.display = 'inline-block';
            document.getElementById('rapid-score-display').style.display = 'none';
            rapidCorrect = 0;
        }

        function startRapidFire() {
            rapidCorrect = 0;
            document.getElementById('rapid-start-btn').style.display = 'none';
            document.getElementById('rapid-score-display').style.display = 'block';
            document.getElementById('rapid-correct').textContent = '0';
            document.getElementById('rapid-input').disabled = false;
            document.getElementById('rapid-input').focus();

            let timeLeft = 30;
            document.getElementById('rapid-timer').textContent = timeLeft;

            nextRapidQuestion();

            rapidFireInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('rapid-timer').textContent = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(rapidFireInterval);
                    endRapidFire();
                }
            }, 1000);

            document.getElementById('rapid-input').onkeypress = function(e) {
                if (e.key === 'Enter') {
                    checkRapidAnswer();
                }
            };
        }

        function nextRapidQuestion() {
            const contacts = getAllContacts().filter(c => c.name && c.company);
            const contact = contacts[Math.floor(Math.random() * contacts.length)];

            document.getElementById('rapid-prompt').innerHTML = `Who works at <strong style="color:var(--accent);">${contact.company}</strong>?`;
            document.getElementById('rapid-input').value = '';
            document.getElementById('rapid-input').dataset.answer = contact.name.toLowerCase();
            document.getElementById('rapid-input').focus();
        }

        function checkRapidAnswer() {
            const input = document.getElementById('rapid-input');
            const answer = input.value.toLowerCase().trim();
            const correct = input.dataset.answer;

            if (answer && correct.includes(answer.split(' ')[0])) {
                rapidCorrect++;
                drillScore += 5;
                drillStreak++;
                document.getElementById('rapid-correct').textContent = rapidCorrect;
                updateDrillStats();
            }
            nextRapidQuestion();
        }

        function endRapidFire() {
            document.getElementById('rapid-input').disabled = true;
            document.getElementById('rapid-prompt').innerHTML = `Time's up! You got <strong style="color:#17bf63;">${rapidCorrect}</strong> correct!`;
            document.getElementById('rapid-start-btn').style.display = 'inline-block';
            document.getElementById('rapid-start-btn').textContent = 'Play Again';
            drillScore += rapidCorrect * 10; // Bonus points
            saveDrillProgress();
            updateDrillStats();
        }

        // Reset progress
        function resetDrillProgress() {
            if (confirm('Reset all drill progress? This cannot be undone.')) {
                drillScore = 0;
                drillStreak = 0;
                masteredContacts = new Set();
                saveDrillProgress();
                updateDrillStats();
                renderDrillCards();
                showNotification('Progress reset', 'success');
            }
        }

        async function init() {
            const now = new Date();
            const weekInput = document.getElementById('weekSelector');
            const year = now.getFullYear();
            const week = getWeekNumber(now);
            weekInput.value = `${year}-W${week.toString().padStart(2, '0')}`;

            // Hide week selector and summary panel on initial load (Summary tab)
            document.getElementById('weekSelectorContainer').style.display = 'none';
            document.getElementById('summaryPanel').style.display = 'none';

            // Check connection and update banner
            checkConnection();
            loadAllocations();
            await loadStakeholders();

            // Load meetings after stakeholder data is ready
            loadMeetings();

            // Set up auto-save for stakeholder inputs
            setupStakeholderAutoSave();
        }

        function setupStakeholderAutoSave() {
            // Watch for changes in stakeholder table and auto-save
            const stakeholderTable = document.getElementById('stakeholderTableBody');
            if (stakeholderTable) {
                stakeholderTable.addEventListener('change', (e) => {
                    // Auto-save on any change (dropdown, checkbox, date)
                    saveStakeholders();
                });
                stakeholderTable.addEventListener('blur', (e) => {
                    // Auto-save when leaving input fields
                    if (e.target.matches('input, textarea')) {
                        saveStakeholders();
                    }
                }, true);
            }
        }

        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        function getStaffTotalHours(staffName) {
            let total = 0;
            Object.values(allocations).forEach(assignments => {
                const a = assignments.find(x => x.staffName === staffName);
                if (a) total += a.hours;
            });
            return total;
        }

        function getHoursClass(hours) {
            if (hours > 38) return 'hours-over';
            if (hours >= 36) return 'hours-full';
            return 'hours-ok';
        }

        function render() {
            renderResourcePool();
            renderProjects();
            renderCalendar();
            updateSummary();
            renderContacts();
        }

        // Contact directory functions
        let contactEmailStatus = JSON.parse(localStorage.getItem('contactEmailStatus') || '{}');

        function renderContacts() {
            const tbody = document.getElementById('contactsTableBody');
            if (!tbody) return;

            let html = '';
            stakeholderClients.forEach(client => {
                if (!client.contactInfo || client.contactInfo.length === 0) return;

                client.contactInfo.forEach(contact => {
                    const contactKey = `${client.code}-${contact.email}`;
                    const isEmailed = contactEmailStatus[contactKey] || client.emailSent || false;
                    const activeProjects = client.activeProjects ? client.activeProjects.map(p => getProjectName(p)).join(', ') : '-';

                    html += `
                        <tr class="contact-row" data-type="${client.type}" data-name="${contact.name}" data-company="${client.name}" style="border-bottom: 1px solid var(--border);">
                            <td style="padding: 12px 16px;">
                                <input type="checkbox" ${isEmailed ? 'checked' : ''} onchange="toggleContactEmailed('${contactKey}')" style="width: 18px; height: 18px; cursor: pointer;">
                            </td>
                            <td style="padding: 12px 16px; font-weight: 500; color: var(--text-primary);">${contact.name}</td>
                            <td style="padding: 12px 16px; color: var(--text-secondary);">${client.name}</td>
                            <td style="padding: 12px 16px;">
                                <span style="padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; background: ${getTypeColor(client.type)}20; color: ${getTypeColor(client.type)};">${client.type}</span>
                            </td>
                            <td style="padding: 12px 16px; color: var(--text-secondary); font-size: 13px;">${contact.role || '-'}</td>
                            <td style="padding: 12px 16px; color: var(--text-muted); font-size: 13px;">${activeProjects}</td>
                            <td style="padding: 12px 16px;">
                                ${contact.email ? `<a href="mailto:${contact.email}" style="color: var(--accent); text-decoration: none; font-size: 13px;">${contact.email}</a>` : '-'}
                            </td>
                            <td style="padding: 12px 16px; color: var(--text-secondary); font-size: 13px;">${contact.phone || '-'}</td>
                        </tr>`;
                });
            });

            tbody.innerHTML = html;
        }

        function toggleContactEmailed(contactKey) {
            contactEmailStatus[contactKey] = !contactEmailStatus[contactKey];
            localStorage.setItem('contactEmailStatus', JSON.stringify(contactEmailStatus));
        }

        function getTypeColor(type) {
            const colors = {
                'Developer': '#4ECDC4',
                'NSP': '#FF6B6B',
                'OEM': '#45B7D1',
                'EPC': '#96CEB4',
                'AEMO': '#FFEAA7',
                'Investor': '#DDA0DD',
                'Asset Owner': '#F7DC6F'
            };
            return colors[type] || '#00d4aa';
        }

        function filterContacts() {
            const searchTerm = document.getElementById('contactSearchInput').value.toLowerCase();
            const typeFilter = document.getElementById('contactTypeFilter').value;

            document.querySelectorAll('.contact-row').forEach(row => {
                const name = row.dataset.name.toLowerCase();
                const company = row.dataset.company.toLowerCase();
                const type = row.dataset.type;

                const matchesSearch = name.includes(searchTerm) || company.includes(searchTerm);
                const matchesType = typeFilter === 'all' || type === typeFilter;

                row.style.display = (matchesSearch && matchesType) ? '' : 'none';
            });
        }

        function renderResourcePool() {
            const container = document.getElementById('resourcePool');
            let html = `
                <div class="resource-pool-header">
                    <h2>Engineering Resources</h2>
                    <span style="color: var(--text-muted); font-size: 12px;">Drag to assign</span>
                </div>
                <div class="resources-grid">`;

            resources.forEach(name => {
                const hours = getStaffTotalHours(name);
                const hoursClass = getHoursClass(hours);
                const color = staffColors[name] || '#00d4aa';
                html += `
                    <div class="resource-chip" draggable="true" data-staff="${name}">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span class="resource-dot" style="background: ${color};"></span>
                            <span class="resource-name">${name}</span>
                        </div>
                        <span class="resource-hours ${hoursClass}">${hours}h</span>
                    </div>`;
            });

            html += '</div>';
            container.innerHTML = html;
            attachDragListeners();
        }

        // Day allocation data per resource per project
        let dayAllocations = {};

        function renderProjects() {
            const container = document.getElementById('projectsGrid');
            let html = '';

            projects.forEach(project => {
                const assignments = allocations[project] || [];
                const totalHours = assignments.reduce((sum, a) => sum + a.hours, 0);
                const status = projectStatus[project] || {};
                const notes = projectNotes[project] || '';
                const issues = projectIssues[project] || '';
                const milestones = projectMilestones[project] || [];

                // Determine active status
                const isWaiting = status.waitingClient || status.waitingNSP || status.waitingAEMO;
                const isActive = assignments.length > 0 && !isWaiting;

                // Check for overdue expected date
                const expectedDate = status.expectedBy ? new Date(status.expectedBy) : null;
                const isOverdue = expectedDate && expectedDate < new Date();

                // Format expected date
                const formatDate = (dateStr) => {
                    if (!dateStr) return '';
                    const d = new Date(dateStr);
                    return d.toLocaleDateString('en-AU', { day: 'numeric', month: 'short' });
                };

                const safeProject = project.replace(/'/g, "\\'");

                html += `
                    <div class="project-card project-card-new" data-project="${project}">
                        <div class="project-header">
                            <div class="project-header-top">
                                <span class="project-title">${project}</span>
                                <span class="project-hours">${totalHours}h</span>
                            </div>
                            <div class="status-badges">
                                <span class="status-badge waiting-client ${status.waitingClient ? 'active' : ''}" onclick="toggleStatusBadge('${safeProject}', 'waitingClient')">Client</span>
                                <span class="status-badge waiting-nsp ${status.waitingNSP ? 'active' : ''}" onclick="toggleStatusBadge('${safeProject}', 'waitingNSP')">NSP</span>
                                <span class="status-badge waiting-aemo ${status.waitingAEMO ? 'active' : ''}" onclick="toggleStatusBadge('${safeProject}', 'waitingAEMO')">AEMO</span>
                                <span class="status-badge project-active ${isActive ? 'active' : ''}" style="pointer-events: none;">Active</span>
                            </div>
                            ${status.expectedBy ? `
                            <div class="expected-badge ${isOverdue ? 'overdue' : ''}">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <polyline points="12 6 12 12 16 14"/>
                                </svg>
                                Expected: <span class="date">${formatDate(status.expectedBy)}</span>
                                <input type="date" class="date-input" value="${status.expectedBy}" onchange="updateStatus('${safeProject}', 'expectedBy', this.value)" style="width: 24px; opacity: 0.5;">
                            </div>
                            ` : `
                            <div class="expected-badge">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <polyline points="12 6 12 12 16 14"/>
                                </svg>
                                <input type="date" class="date-input" placeholder="Set date" onchange="updateStatus('${safeProject}', 'expectedBy', this.value)" style="width: 100px;">
                            </div>
                            `}
                        </div>
                        <div class="project-body">
                            <div class="assigned-list">`;

                if (assignments.length === 0) {
                    html += '<div class="drop-zone">Drop resources here</div>';
                } else {
                    assignments.forEach(a => {
                        const staffTotal = getStaffTotalHours(a.staffName);
                        const statusClass = staffTotal > 38 ? 'over' : staffTotal >= 36 ? 'full' : '';
                        const color = staffColors[a.staffName] || '#00d4aa';
                        const activityCells = renderActivityCells(project, a.staffName, a.hours);
                        const safeStaff = a.staffName.replace(/'/g, "\\'");

                        html += `
                            <div class="resource-row ${statusClass}" style="border-left-color: ${color};">
                                <div class="resource-info">
                                    <div class="resource-name-row">
                                        <span class="assigned-name">${a.staffName}</span>
                                        <span class="resource-hours-badge">${a.hours}h</span>
                                    </div>
                                    <div class="activity-grid" onclick="openDayAllocation('${safeProject}', '${safeStaff}', ${a.hours})">
                                        ${activityCells}
                                    </div>
                                </div>
                                <div class="resource-controls-mini">
                                    <button class="hour-btn" onclick="event.stopPropagation(); adjustHours('${safeProject}', '${safeStaff}', -1)">-</button>
                                    <button class="hour-btn" onclick="event.stopPropagation(); adjustHours('${safeProject}', '${safeStaff}', 1)">+</button>
                                    <button class="remove-btn" onclick="event.stopPropagation(); removeAssignment('${safeProject}', '${safeStaff}')">x</button>
                                </div>
                            </div>`;
                    });
                }

                // Determine if details have content
                const hasNotes = notes && notes.trim().length > 0;
                const hasIssues = issues && issues.trim().length > 0;
                const hasMilestones = milestones && milestones.some(m => m && m.name);

                const projectId = project.replace(/\s+/g, '-');
                const safeNotes = (notes || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                const safeIssues = (issues || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');

                html += `
                            </div>

                            <!-- Collapsible Details Section -->
                            <div class="details-toggle" onclick="toggleDetails('${projectId}')">
                                <div class="details-toggle-left">
                                    <svg class="details-toggle-icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="6 9 12 15 18 9"/>
                                    </svg>
                                    Notes, Issues & Milestones
                                </div>
                                <div class="details-indicators">
                                    <div class="detail-indicator ${hasNotes ? 'has-content' : ''}" title="Notes"></div>
                                    <div class="detail-indicator ${hasIssues ? 'has-issues' : ''}" title="Issues"></div>
                                    <div class="detail-indicator ${hasMilestones ? 'has-content' : ''}" title="Milestones"></div>
                                </div>
                            </div>
                            <div class="details-content" id="details-${projectId}">
                                <div class="detail-section">
                                    <div class="detail-label">Notes</div>
                                    <textarea class="detail-textarea" placeholder="General notes..." onchange="updateNotes('${safeProject}', this.value)">${safeNotes}</textarea>
                                </div>
                                <div class="detail-section">
                                    <div class="detail-label">Issues / Blockers</div>
                                    <textarea class="detail-textarea" placeholder="Issues, blockers, risks..." onchange="updateIssues('${safeProject}', this.value)" style="border-color: ${hasIssues ? 'rgba(224, 36, 94, 0.3)' : 'var(--border)'};">${safeIssues}</textarea>
                                </div>
                                <div class="detail-section">
                                    <div class="detail-label">Key Milestones</div>
                                    ${renderMilestonesCompact(project)}
                                </div>
                            </div>
                        </div>
                    </div>`;
            });

            container.innerHTML = html;
            attachDropListeners();
        }

        // Render vertical daily allocation list for 2 weeks (10 working days)
        function renderActivityCells(project, staffName, totalHours) {
            const key = `${project}-${staffName}`;
            const allocation = dayAllocations[key] || {};
            const today = new Date();
            let rows = '';

            // Generate 10 working days (2 weeks)
            let dayCount = 0;
            let currentDate = new Date(today);

            while (dayCount < 10) {
                const dayOfWeek = currentDate.getDay();
                if (dayOfWeek !== 0 && dayOfWeek !== 6) { // Skip weekends
                    const dateStr = currentDate.toISOString().split('T')[0];
                    const hours = allocation[dateStr] || 0;
                    const dayName = currentDate.toLocaleDateString('en-AU', { weekday: 'short' });
                    const dateLabel = currentDate.toLocaleDateString('en-AU', { day: 'numeric', month: 'short' });
                    const hasHours = hours > 0 ? 'has-hours' : '';

                    rows += `<div class="day-row" data-date="${dateStr}">
                        <span class="day-label">${dayName} ${dateLabel}:</span>
                        <span class="day-hours ${hasHours}">${hours}h</span>
                    </div>`;
                    dayCount++;
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }

            return rows;
        }

        // Compact milestones for collapsed view
        function renderMilestonesCompact(project) {
            const milestones = projectMilestones[project] || [{}, {}, {}];
            const safeProj = project.replace(/'/g, "\\'");
            let html = '';

            for (let i = 0; i < 3; i++) {
                const m = milestones[i] || {};
                const today = new Date();
                const mDate = m.date ? new Date(m.date) : null;
                const daysUntil = mDate ? Math.ceil((mDate - today) / (1000 * 60 * 60 * 24)) : null;
                const isOverdue = mDate && daysUntil < 0 && !m.complete;

                let daysClass = 'green';
                if (daysUntil !== null) {
                    if (m.complete) daysClass = 'complete';
                    else if (daysUntil < 0) daysClass = 'red';
                    else if (daysUntil <= 7) daysClass = 'amber';
                }

                const safeName = (m.name || '').replace(/'/g, "&#39;").replace(/"/g, "&quot;");

                html += `
                    <div class="milestone-row">
                        <span class="milestone-num ${m.complete ? 'complete' : ''} ${isOverdue ? 'overdue' : ''}">${i + 1}</span>
                        <input type="text" class="milestone-input" placeholder="Milestone ${i + 1}..." value="${safeName}"
                            onchange="updateMilestone('${safeProj}', ${i}, 'name', this.value)">
                        <input type="date" class="milestone-date ${isOverdue ? 'overdue' : ''}" value="${m.date || ''}"
                            onchange="updateMilestone('${safeProj}', ${i}, 'date', this.value)">
                        <input type="checkbox" class="milestone-check" ${m.complete ? 'checked' : ''}
                            onchange="updateMilestone('${safeProj}', ${i}, 'complete', this.checked)">
                        ${daysUntil !== null ? `<span class="milestone-days ${daysClass}">${m.complete ? 'Done' : (daysUntil < 0 ? Math.abs(daysUntil) + 'd over' : daysUntil + 'd')}</span>` : ''}
                    </div>`;
            }

            return html;
        }

        // Toggle status badge
        function toggleStatusBadge(project, statusKey) {
            const current = projectStatus[project] || {};
            current[statusKey] = !current[statusKey];
            projectStatus[project] = current;
            render();
        }

        // Toggle details section
        function toggleDetails(projectId) {
            const content = document.getElementById('details-' + projectId);
            if (!content) return;
            const toggle = content.previousElementSibling;

            if (content.classList.contains('open')) {
                content.classList.remove('open');
                toggle.classList.remove('open');
            } else {
                content.classList.add('open');
                toggle.classList.add('open');
            }
        }

        // Open day allocation popup
        function openDayAllocation(project, staffName, totalHours) {
            const key = `${project}-${staffName}`;
            const allocation = dayAllocations[key] || {};

            // Create backdrop
            const backdrop = document.createElement('div');
            backdrop.className = 'day-allocation-backdrop';
            backdrop.onclick = () => closeDayAllocation();

            // Create popup
            const popup = document.createElement('div');
            popup.className = 'day-allocation-popup';
            popup.id = 'dayAllocationPopup';

            const today = new Date();
            let gridHtml = '';

            // Day headers
            const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            dayNames.forEach(d => {
                gridHtml += `<div class="day-header">${d}</div>`;
            });

            // Find the Monday of current week
            const monday = new Date(today);
            monday.setDate(monday.getDate() - ((monday.getDay() + 6) % 7));

            // Generate 2 weeks of days
            for (let week = 0; week < 2; week++) {
                for (let day = 0; day < 7; day++) {
                    const currentDate = new Date(monday);
                    currentDate.setDate(monday.getDate() + (week * 7) + day);
                    const dateStr = currentDate.toISOString().split('T')[0];
                    const hours = allocation[dateStr] || 0;
                    const isWeekend = day >= 5;
                    const isToday = currentDate.toDateString() === today.toDateString();

                    gridHtml += `
                        <div class="day-cell ${isWeekend ? 'weekend' : ''} ${hours > 0 ? 'selected' : ''} ${isToday ? 'today' : ''}"
                             onclick="toggleDayHours('${key}', '${dateStr}', this)"
                             data-date="${dateStr}">
                            <span class="day-number">${currentDate.getDate()}</span>
                            <span class="day-hours">${hours}h</span>
                        </div>`;
                }
            }

            // Calculate total allocated
            const totalAllocated = Object.values(allocation).reduce((sum, h) => sum + h, 0);

            popup.innerHTML = `
                <div class="day-allocation-header">
                    <div class="day-allocation-title">${staffName} on ${project}</div>
                    <button class="day-allocation-close" onclick="closeDayAllocation()">&times;</button>
                </div>
                <div class="day-allocation-grid">${gridHtml}</div>
                <div class="day-allocation-footer">
                    <div class="total-hours-display">Allocated: <span id="allocatedHours">${totalAllocated}</span>h / ${totalHours}h total</div>
                    <button class="btn btn-primary" onclick="saveDayAllocation('${project}', '${staffName}')">Save</button>
                </div>
            `;

            document.body.appendChild(backdrop);
            document.body.appendChild(popup);
        }

        function closeDayAllocation() {
            const popup = document.getElementById('dayAllocationPopup');
            const backdrop = document.querySelector('.day-allocation-backdrop');
            if (popup) popup.remove();
            if (backdrop) backdrop.remove();
        }

        function toggleDayHours(key, dateStr, element) {
            if (!dayAllocations[key]) dayAllocations[key] = {};

            const current = dayAllocations[key][dateStr] || 0;
            // Cycle through 0, 4, 8 hours
            const next = current === 0 ? 4 : current === 4 ? 8 : 0;
            dayAllocations[key][dateStr] = next;

            // Update display
            element.querySelector('.day-hours').textContent = next + 'h';
            element.classList.toggle('selected', next > 0);

            // Update total
            const total = Object.values(dayAllocations[key]).reduce((sum, h) => sum + h, 0);
            document.getElementById('allocatedHours').textContent = total;
        }

        function saveDayAllocation(project, staffName) {
            // Day allocations are already saved in memory
            closeDayAllocation();
            render();
        }

        function renderCalendar() {
            const container = document.getElementById('calendarSection');
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDay = firstDay.getDay();
            const daysInMonth = lastDay.getDate();
            const today = new Date();

            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                              'July', 'August', 'September', 'October', 'November', 'December'];

            let html = `
                <div class="calendar-header">
                    <h2>${monthNames[month]} ${year} - Resource Calendar</h2>
                    <div class="calendar-nav">
                        <button class="btn btn-secondary" onclick="changeMonth(-1)">&lt; Prev</button>
                        <button class="btn btn-secondary" onclick="changeMonth(1)">Next &gt;</button>
                    </div>
                </div>
                <div class="calendar-grid">
                    <div class="calendar-day-header">Sun</div>
                    <div class="calendar-day-header">Mon</div>
                    <div class="calendar-day-header">Tue</div>
                    <div class="calendar-day-header">Wed</div>
                    <div class="calendar-day-header">Thu</div>
                    <div class="calendar-day-header">Fri</div>
                    <div class="calendar-day-header">Sat</div>`;

            for (let i = 0; i < startDay; i++) {
                const prevDate = new Date(year, month, -startDay + i + 1);
                html += `<div class="calendar-day other-month"><div class="calendar-date">${prevDate.getDate()}</div></div>`;
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const isToday = date.toDateString() === today.toDateString();
                const events = getEventsForDate(date);

                html += `<div class="calendar-day ${isToday ? 'today' : ''}">
                    <div class="calendar-date">${day}</div>
                    <div class="calendar-events">${events}</div>
                </div>`;
            }

            const remainingDays = 42 - (startDay + daysInMonth);
            for (let i = 1; i <= remainingDays; i++) {
                html += `<div class="calendar-day other-month"><div class="calendar-date">${i}</div></div>`;
            }

            html += '</div>';
            container.innerHTML = html;
        }

        function getEventsForDate(date) {
            let events = '';
            const dateStr = date.toISOString().split('T')[0];

            Object.entries(projectStatus).forEach(([project, status]) => {
                if (status.expectedBy === dateStr) {
                    events += `<div class="calendar-event" style="background: var(--accent-dim); color: var(--accent);">${project}</div>`;
                }
            });

            Object.entries(projectMilestones).forEach(([project, milestones]) => {
                milestones.forEach((m, i) => {
                    if (m && m.date === dateStr && !m.complete) {
                        events += `<div class="calendar-event" style="background: rgba(245, 166, 35, 0.2); color: var(--warning);">M${i+1}: ${m.name || project}</div>`;
                    }
                });
            });

            Object.entries(allocations).forEach(([project, assignments]) => {
                assignments.forEach(a => {
                    if (a.wantedBy === dateStr && a.wanted) {
                        const color = staffColors[a.staffName] || '#00d4aa';
                        events += `<div class="calendar-event" style="background: ${color}20; color: ${color};">${a.staffName.split(' ')[0]}</div>`;
                    }
                });
            });

            return events;
        }

        function changeMonth(delta) {
            currentMonth.setMonth(currentMonth.getMonth() + delta);
            renderCalendar();
        }

        function attachDragListeners() {
            document.querySelectorAll('.resource-chip').forEach(el => {
                el.addEventListener('dragstart', e => {
                    draggedStaff = e.target.dataset.staff;
                    e.target.classList.add('dragging');
                });
                el.addEventListener('dragend', e => {
                    e.target.classList.remove('dragging');
                    document.querySelectorAll('.project-card').forEach(p => p.classList.remove('drag-over'));
                });
            });
        }

        function attachDropListeners() {
            document.querySelectorAll('.project-card').forEach(el => {
                el.addEventListener('dragover', e => {
                    e.preventDefault();
                    e.currentTarget.classList.add('drag-over');
                });
                el.addEventListener('dragleave', e => {
                    e.currentTarget.classList.remove('drag-over');
                });
                el.addEventListener('drop', e => {
                    e.preventDefault();
                    e.currentTarget.classList.remove('drag-over');
                    const project = e.currentTarget.dataset.project;
                    if (!draggedStaff || !project) return;
                    if (!allocations[project]) allocations[project] = [];
                    if (!allocations[project].find(a => a.staffName === draggedStaff)) {
                        allocations[project].push({ staffName: draggedStaff, hours: 8, wanted: false, wantedBy: '' });
                    }
                    render();
                });
            });
        }

        function adjustHours(project, staffName, delta) {
            const a = (allocations[project] || []).find(x => x.staffName === staffName);
            if (a) { a.hours = Math.max(0, Math.min(60, a.hours + delta)); render(); }
        }

        function setHours(project, staffName, value) {
            const a = (allocations[project] || []).find(x => x.staffName === staffName);
            if (a) { a.hours = Math.max(0, Math.min(60, parseInt(value) || 0)); render(); }
        }

        function removeAssignment(project, staffName) {
            if (allocations[project]) {
                allocations[project] = allocations[project].filter(a => a.staffName !== staffName);
                render();
            }
        }

        function toggleWanted(project, staffName, wanted) {
            const a = (allocations[project] || []).find(x => x.staffName === staffName);
            if (a) { a.wanted = wanted; renderCalendar(); }
        }

        function setWantedDate(project, staffName, date) {
            const a = (allocations[project] || []).find(x => x.staffName === staffName);
            if (a) { a.wantedBy = date; renderCalendar(); }
        }

        function updateNotes(project, notes) { projectNotes[project] = notes; }
        function updateIssues(project, issues) { projectIssues[project] = issues; }
        function updateStatus(project, field, value) {
            if (!projectStatus[project]) projectStatus[project] = {};
            projectStatus[project][field] = value;
            if (field === 'expectedBy') renderCalendar();
        }

        function renderMilestones(project) {
            const milestones = projectMilestones[project] || [{}, {}, {}, {}];
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];

            function getDaysUntil(dateStr) {
                if (!dateStr) return null;
                const target = new Date(dateStr);
                const diffTime = target - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays;
            }

            function getDaysClass(days, isComplete) {
                if (isComplete) return 'complete';
                if (days === null) return '';
                if (days < 0) return 'red';
                if (days <= 7) return 'red';
                if (days <= 14) return 'amber';
                return 'green';
            }

            function getDaysText(days, isComplete) {
                if (isComplete) return 'Done';
                if (days === null) return '';
                if (days < 0) return `${Math.abs(days)}d overdue`;
                if (days === 0) return 'Today!';
                if (days === 1) return '1 day';
                return `${days} days`;
            }

            let html = `<div class="milestones-section">
                <div class="milestones-header">Key Milestones</div>`;

            for (let i = 0; i < 4; i++) {
                const m = milestones[i] || {};
                const isOverdue = m.date && m.date < todayStr && !m.complete;
                const numClass = m.complete ? 'complete' : isOverdue ? 'overdue' : '';
                const dateClass = isOverdue ? 'overdue' : '';
                const daysUntil = getDaysUntil(m.date);
                const daysClass = getDaysClass(daysUntil, m.complete);
                const daysText = getDaysText(daysUntil, m.complete);

                html += `<div class="milestone-row">
                    <span class="milestone-num ${numClass}">${i + 1}</span>
                    <input type="checkbox" class="milestone-check" ${m.complete ? 'checked' : ''}
                        onchange="updateMilestone('${project}', ${i}, 'complete', this.checked)" title="Mark complete">
                    <input type="text" class="milestone-input" placeholder="Milestone ${i + 1}..."
                        value="${m.name || ''}" onchange="updateMilestone('${project}', ${i}, 'name', this.value)">
                    <input type="date" class="milestone-date ${dateClass}" value="${m.date || ''}"
                        onchange="updateMilestone('${project}', ${i}, 'date', this.value)">
                    ${m.date ? `<span class="milestone-days ${daysClass}">${daysText}</span>` : '<span class="milestone-days" style="visibility: hidden;">--</span>'}
                </div>`;
            }

            html += '</div>';
            return html;
        }

        function updateMilestone(project, index, field, value) {
            if (!projectMilestones[project]) {
                projectMilestones[project] = [{}, {}, {}, {}];
            }
            if (!projectMilestones[project][index]) {
                projectMilestones[project][index] = {};
            }
            projectMilestones[project][index][field] = value;

            if (field === 'date' || field === 'complete') {
                renderCalendar();
            }
            if (field === 'date' || field === 'complete') {
                renderProjects();
            }
        }

        function updateSummary() {
            let overloaded = 0, totalHours = 0;
            resources.forEach(staff => { if (getStaffTotalHours(staff) > 38) overloaded++; });
            Object.values(allocations).forEach(arr => arr.forEach(a => totalHours += a.hours));
            document.getElementById('totalStaff').textContent = resources.length;
            document.getElementById('overloadedCount').textContent = overloaded;
            document.getElementById('totalHours').textContent = totalHours;
        }

        async function saveAllocations() {
            const week = document.getElementById('weekSelector').value;
            const data = {
                week: week,
                allocations: JSON.stringify(allocations),
                project_notes: JSON.stringify({ notes: projectNotes, issues: projectIssues, milestones: projectMilestones }),
                project_status: JSON.stringify(projectStatus)
            };

            try {
                const response = await fetch(`${API_BASE}/resource-allocation`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    document.getElementById('syncStatus').textContent = 'Saved to Promethean Light';
                    setTimeout(() => {
                        document.getElementById('syncStatus').textContent = 'Connected to Promethean Light';
                    }, 2000);
                } else {
                    throw new Error('Save failed');
                }
            } catch (e) {
                localStorage.setItem(`alloc_${week}`, JSON.stringify(allocations));
                localStorage.setItem(`notes_${week}`, JSON.stringify({ notes: projectNotes, issues: projectIssues, milestones: projectMilestones }));
                localStorage.setItem(`status_${week}`, JSON.stringify(projectStatus));
                document.getElementById('syncStatus').textContent = 'Saved locally (offline)';
            }
        }

        async function loadAllocations() {
            const week = document.getElementById('weekSelector').value;

            try {
                const response = await fetch(`${API_BASE}/resource-allocation/${week}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data) {
                        allocations = JSON.parse(data.allocations || '{}');
                        const notesData = JSON.parse(data.project_notes || '{}');
                        projectNotes = notesData.notes || {};
                        projectIssues = notesData.issues || {};
                        projectMilestones = notesData.milestones || {};
                        projectStatus = JSON.parse(data.project_status || '{}');
                        document.getElementById('syncStatus').textContent = 'Connected to Promethean Light';
                    } else {
                        allocations = {};
                        projectNotes = {};
                        projectIssues = {};
                        projectMilestones = {};
                        projectStatus = {};
                    }
                } else {
                    throw new Error('Load failed');
                }
            } catch (e) {
                const saved = localStorage.getItem(`alloc_${week}`);
                const savedNotes = localStorage.getItem(`notes_${week}`);
                const savedStatus = localStorage.getItem(`status_${week}`);
                allocations = saved ? JSON.parse(saved) : {};
                const notesData = savedNotes ? JSON.parse(savedNotes) : {};
                projectNotes = notesData.notes || {};
                projectIssues = notesData.issues || {};
                projectMilestones = notesData.milestones || {};
                projectStatus = savedStatus ? JSON.parse(savedStatus) : {};
                document.getElementById('syncStatus').textContent = 'Offline mode';
            }

            render();
        }

        function exportData() {
            const week = document.getElementById('weekSelector').value;
            let csv = 'Project,Staff,Hours,Wanted,Wanted By,Staff Total,Status,Waiting Client,Waiting NSP,Waiting AEMO,Expected By,Notes,Issues\n';
            projects.forEach(project => {
                const arr = allocations[project] || [];
                const notes = (projectNotes[project] || '').replace(/"/g, '""').replace(/\n/g, ' ');
                const issues = (projectIssues[project] || '').replace(/"/g, '""').replace(/\n/g, ' ');
                const status = projectStatus[project] || {};

                if (arr.length === 0) {
                    csv += `"${project}",-,-,-,-,-,${status.waitingClient ? 'Yes' : 'No'},${status.waitingNSP ? 'Yes' : 'No'},${status.waitingAEMO ? 'Yes' : 'No'},${status.expectedBy || ''},"${notes}","${issues}"\n`;
                } else {
                    arr.forEach((a, i) => {
                        const total = getStaffTotalHours(a.staffName);
                        csv += `"${project}","${a.staffName}",${a.hours},${a.wanted ? 'Yes' : 'No'},${a.wantedBy || ''},${total},${total > 38 ? 'OVER' : 'OK'},${i === 0 ? (status.waitingClient ? 'Yes' : 'No') : ''},${i === 0 ? (status.waitingNSP ? 'Yes' : 'No') : ''},${i === 0 ? (status.waitingAEMO ? 'Yes' : 'No') : ''},${i === 0 ? (status.expectedBy || '') : ''},"${i === 0 ? notes : ''}","${i === 0 ? issues : ''}"\n`;
                    });
                }
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `resource-allocation-${week}.csv`;
            a.click();
        }

        setInterval(saveAllocations, 60000);

        async function checkConnection() {
            const banner = document.getElementById('connectionBanner');
            try {
                const response = await fetch(`${API_BASE}/`, { method: 'GET', timeout: 2000 });
                if (response.ok) {
                    document.getElementById('statusDot').classList.remove('offline');
                    document.getElementById('startDaemonBtn').style.display = 'none';
                    if (banner) banner.classList.add('hidden');
                    return true;
                }
            } catch (e) {
                document.getElementById('statusDot').classList.add('offline');
                document.getElementById('syncStatus').textContent = 'Offline - Daemon not running';
                document.getElementById('startDaemonBtn').style.display = 'inline-block';
                if (banner) banner.classList.remove('hidden');
                return false;
            }
            return false;
        }

        async function startDaemon() {
            document.getElementById('syncStatus').textContent = 'Starting daemon...';
            document.getElementById('startDaemonBtn').disabled = true;

            try {
                const link = document.createElement('a');
                link.href = 'promethean://start';
                link.click();
            } catch (e) {
                console.log('Shell protocol not available');
            }

            try {
                window.location.href = 'file:///C:/Code/Promethian%20%20Light/archive_scripts/START.bat';
            } catch (e) {
                console.log('Direct file access not available');
            }

            setTimeout(() => {
                if (!checkConnection()) {
                    document.getElementById('syncStatus').textContent = 'Run: python -m mydata daemon';
                    document.getElementById('startDaemonBtn').disabled = false;
                    document.getElementById('startDaemonBtn').textContent = 'Retry';
                    alert('To start the daemon, open a terminal in C:\\Code\\Promethian  Light and run:\n\npython -m mydata daemon\n\nOr double-click START.bat');
                }
            }, 2000);

            setTimeout(async () => {
                const connected = await checkConnection();
                if (connected) {
                    document.getElementById('syncStatus').textContent = 'Connected to Promethean Light';
                    loadAllocations();
                }
                document.getElementById('startDaemonBtn').disabled = false;
            }, 5000);
        }

        setInterval(checkConnection, 10000);

        document.getElementById('weekSelector').addEventListener('change', loadAllocations);

        // =====================
        // AUTHENTICATION
        // =====================
        const ALLOWED_DOMAIN = 'vysusgroup.com';
        const IS_LOCAL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' || window.location.protocol === 'file:';

        // ============================================
        // SUPABASE AUTH UI HANDLERS
        // ============================================
        function toggleSignUp() {
            const loginForm = document.getElementById('loginForm');
            const signUpForm = document.getElementById('signUpForm');
            if (loginForm.style.display === 'none') {
                loginForm.style.display = 'block';
                signUpForm.style.display = 'none';
            } else {
                loginForm.style.display = 'none';
                signUpForm.style.display = 'block';
            }
            // Clear errors
            document.getElementById('loginError').style.display = 'none';
            document.getElementById('signUpError').style.display = 'none';
            document.getElementById('signUpSuccess').style.display = 'none';
        }

        // ============================================
        // RADAR NOTES UI FUNCTIONS
        // ============================================
        async function saveRadarNotes() {
            const statusEl = document.getElementById('radarSaveStatus');
            statusEl.textContent = 'Saving...';
            statusEl.className = 'radar-save-status';

            // Collect all notes from textareas
            const notes = {};
            document.querySelectorAll('.radar-notes-textarea').forEach(textarea => {
                const client = textarea.dataset.client;
                notes[client] = textarea.value;
            });

            const result = await SupabaseData.saveRadarNotes(notes);

            if (result.success) {
                statusEl.textContent = 'Saved to ' + result.source;
                statusEl.className = 'radar-save-status success';
                setTimeout(() => { statusEl.textContent = ''; }, 3000);
            } else {
                statusEl.textContent = 'Save failed';
                statusEl.className = 'radar-save-status';
            }
        }

        async function loadRadarNotes() {
            const notes = await SupabaseData.loadRadarNotes();
            document.querySelectorAll('.radar-notes-textarea').forEach(textarea => {
                const client = textarea.dataset.client;
                if (notes[client]) {
                    textarea.value = notes[client];
                }
            });
        }

        async function handleSupabaseLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const errorEl = document.getElementById('loginError');

            // Basic validation
            if (!email || !password) {
                errorEl.textContent = 'Please enter email and password';
                errorEl.style.display = 'block';
                return;
            }

            // Domain check (optional - can be enforced server-side too)
            if (!email.endsWith('@' + ALLOWED_DOMAIN)) {
                errorEl.textContent = 'Access restricted to @vysusgroup.com email addresses';
                errorEl.style.display = 'block';
                return;
            }

            errorEl.style.display = 'none';

            const { data, error } = await SupabaseAuth.signIn(email, password);

            if (error) {
                errorEl.textContent = error.message || 'Login failed';
                errorEl.style.display = 'block';
            } else {
                showApp({ email: data.user.email });
                // Reload data from Supabase now that user is authenticated
                await initializeData();
            }
        }

        async function handleSupabaseSignUp() {
            const name = document.getElementById('signUpName').value.trim();
            const email = document.getElementById('signUpEmail').value.trim();
            const password = document.getElementById('signUpPassword').value;
            const errorEl = document.getElementById('signUpError');
            const successEl = document.getElementById('signUpSuccess');

            // Validation
            if (!name || !email || !password) {
                errorEl.textContent = 'Please fill in all fields';
                errorEl.style.display = 'block';
                successEl.style.display = 'none';
                return;
            }

            if (!email.endsWith('@' + ALLOWED_DOMAIN)) {
                errorEl.textContent = 'Access restricted to @vysusgroup.com email addresses';
                errorEl.style.display = 'block';
                successEl.style.display = 'none';
                return;
            }

            if (password.length < 8) {
                errorEl.textContent = 'Password must be at least 8 characters';
                errorEl.style.display = 'block';
                successEl.style.display = 'none';
                return;
            }

            errorEl.style.display = 'none';

            const { data, error } = await SupabaseAuth.signUp(email, password, name);

            if (error) {
                errorEl.textContent = error.message || 'Sign up failed';
                errorEl.style.display = 'block';
            } else {
                successEl.textContent = 'Account created! Check your email to confirm, then sign in.';
                successEl.style.display = 'block';
                // Clear form
                document.getElementById('signUpName').value = '';
                document.getElementById('signUpEmail').value = '';
                document.getElementById('signUpPassword').value = '';
            }
        }

        async function logout() {
            if (IS_LOCAL) {
                document.getElementById('loginOverlay').classList.remove('hidden');
                document.getElementById('userInfo').style.display = 'none';
                return;
            }
            await SupabaseAuth.signOut();
            hideApp();
            dataSource = 'localStorage';
            updateConnectionStatus();
        }

        function showApp(user) {
            document.getElementById('loginOverlay').classList.add('hidden');
            document.getElementById('userInfo').style.display = 'flex';
            document.getElementById('userEmail').textContent = user.email;
            updateConnectionStatus();

            // Show admin toggle for all users (PIN protected)
            showAdminToggle();
        }

        function hideApp() {
            document.getElementById('loginOverlay').classList.remove('hidden');
            document.getElementById('userInfo').style.display = 'none';
            document.getElementById('userEmail').textContent = '';
        }

        // Initialize data after login
        async function initializeData() {
            // Load stakeholders with new Supabase service
            stakeholderData = await SupabaseData.loadStakeholders();
            stakeholderMeetings = await SupabaseData.loadMeetings();
            updateConnectionStatus();

            // Reload allocations
            await loadAllocations();

            // Reload drill progress
            const drillData = await SupabaseData.loadDrillProgress();
            drillScore = drillData.score;
            masteredContacts = new Set(drillData.mastered);
            updateDrillStats();

            // Load radar notes
            await loadRadarNotes();
        }

        // ============================================
        // SUPABASE AUTH STATE LISTENER
        // ============================================
        (async function initSupabaseAuth() {
            // Auto-bypass for local development
            if (IS_LOCAL) {
                document.getElementById('loginOverlay').classList.add('hidden');
                document.getElementById('userInfo').style.display = 'flex';
                document.getElementById('userEmail').textContent = 'Local Development';
                // Show admin toggle for local development
                showAdminToggle();
                return;
            }

            // Check for existing session
            const session = await SupabaseAuth.getSession();
            if (session) {
                const email = session.user.email || '';
                if (email.endsWith('@' + ALLOWED_DOMAIN)) {
                    showApp({ email });
                    await initializeData();
                } else {
                    await SupabaseAuth.signOut();
                    document.getElementById('loginOverlay').classList.remove('hidden');
                }
            } else {
                document.getElementById('loginOverlay').classList.remove('hidden');
            }

            // Listen for auth state changes
            SupabaseAuth.onAuthStateChange(async (event, session) => {
                if (event === 'SIGNED_IN' && session) {
                    const email = session.user.email || '';
                    if (email.endsWith('@' + ALLOWED_DOMAIN)) {
                        showApp({ email });
                        await initializeData();
                    }
                } else if (event === 'SIGNED_OUT') {
                    hideApp();
                    dataSource = 'localStorage';
                    updateConnectionStatus();
                }
            });
        })();

        // Safety Moment popup
        function showSafetyMoment() {
            const overlay = document.createElement('div');
            overlay.id = 'safetyOverlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(15, 20, 25, 0.95);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                opacity: 0;
                transition: opacity 0.3s ease;
            `;

            const content = document.createElement('div');
            content.style.cssText = `
                background: linear-gradient(135deg, rgba(245, 166, 35, 0.08), rgba(224, 36, 94, 0.05));
                border: 1px solid rgba(245, 166, 35, 0.4);
                border-radius: 16px;
                padding: 40px 50px;
                max-width: 700px;
                max-height: 80vh;
                overflow-y: auto;
                transform: scale(0.9);
                transition: transform 0.3s ease;
            `;
            content.innerHTML = `
                <h3 style="display: flex; align-items: center; gap: 12px; color: #f5a623; font-size: 22px; margin-bottom: 24px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 28px; height: 28px;">
                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                        <line x1="12" y1="9" x2="12" y2="13"/>
                        <line x1="12" y1="17" x2="12.01" y2="17"/>
                    </svg>
                    Safety Moment - Holiday Season Driving
                </h3>
                <p style="font-size: 16px; color: #e8eef4; line-height: 1.7; margin-bottom: 24px;">
                    As we head into the holiday break, many of us will be travelling long distances to visit family and friends. Summer driving presents unique challenges with increased traffic, fatigue on long journeys, and unpredictable weather.
                </p>
                <ul style="list-style: none; padding: 0; margin: 0;">
                    <li style="display: flex; align-items: flex-start; gap: 12px; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.1); color: #8899a6; font-size: 15px; line-height: 1.6;">
                        <span style="color: #f5a623; font-size: 18px;">•</span>
                        Plan your journey and take regular breaks every 2 hours - fatigue is a major factor in holiday accidents
                    </li>
                    <li style="display: flex; align-items: flex-start; gap: 12px; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.1); color: #8899a6; font-size: 15px; line-height: 1.6;">
                        <span style="color: #f5a623; font-size: 18px;">•</span>
                        Check your vehicle before long trips: tyres, oil, coolant, and ensure your spare tyre is in good condition
                    </li>
                    <li style="display: flex; align-items: flex-start; gap: 12px; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.1); color: #8899a6; font-size: 15px; line-height: 1.6;">
                        <span style="color: #f5a623; font-size: 18px;">•</span>
                        Stay hydrated and avoid heavy meals before driving - they can cause drowsiness
                    </li>
                    <li style="display: flex; align-items: flex-start; gap: 12px; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.1); color: #8899a6; font-size: 15px; line-height: 1.6;">
                        <span style="color: #f5a623; font-size: 18px;">•</span>
                        Be patient with increased traffic and allow extra time for your journey
                    </li>
                    <li style="display: flex; align-items: flex-start; gap: 12px; padding: 12px 0; color: #8899a6; font-size: 15px; line-height: 1.6;">
                        <span style="color: #f5a623; font-size: 18px;">•</span>
                        If you feel tired, pull over safely and rest - no meeting or deadline is worth your safety
                    </li>
                </ul>
                <button onclick="document.getElementById('safetyOverlay').remove()" style="
                    display: block;
                    margin: 30px auto 0;
                    padding: 10px 30px;
                    font-size: 14px;
                    background: transparent;
                    color: #657786;
                    border: 1px solid #38444d;
                    border-radius: 6px;
                    cursor: pointer;
                    transition: all 0.2s;
                " onmouseover="this.style.borderColor='#f5a623'; this.style.color='#f5a623';" onmouseout="this.style.borderColor='#38444d'; this.style.color='#657786';">
                    Close
                </button>
            `;

            overlay.appendChild(content);
            document.body.appendChild(overlay);

            // Animate in
            setTimeout(() => {
                overlay.style.opacity = '1';
                content.style.transform = 'scale(1)';
            }, 10);

            // Click outside to close
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.style.opacity = '0';
                    content.style.transform = 'scale(0.9)';
                    setTimeout(() => overlay.remove(), 300);
                }
            });
        }

        // Thank You confetti and message
        function showThankYou() {
            // Create overlay
            const overlay = document.createElement('div');
            overlay.id = 'thankYouOverlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(15, 20, 25, 0.95);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
            `;

            // Create message container
            const message = document.createElement('div');
            message.style.cssText = `
                text-align: center;
                padding: 60px;
                max-width: 700px;
                opacity: 0;
                transform: scale(0.8);
                transition: all 0.5s ease;
            `;
            message.innerHTML = `
                <div style="font-size: 48px; font-weight: 700; color: #00d4aa; margin-bottom: 30px;">Thank You</div>
                <div style="font-size: 22px; color: #e8eef4; line-height: 1.8; margin-bottom: 20px;">
                    Your hard work is truly appreciated.
                </div>
                <div style="font-size: 18px; color: #8899a6; line-height: 1.8; margin-bottom: 30px;">
                    The time and effort you've put in has been above and beyond, and that is seen and very much appreciated.
                </div>
                <div style="font-size: 16px; color: #00d4aa; line-height: 1.9; margin-bottom: 30px;">
                    Thank you for your dedication to business development,<br>
                    for supporting each other through challenges,<br>
                    and for generously sharing your knowledge.
                </div>
                <div style="font-size: 18px; color: #f5a623; line-height: 1.8; font-style: italic;">
                    Please take time to have a break and be with your families.<br>
                    Don't think about work - you've earned the rest.
                </div>
            `;

            // Add return button at bottom
            const returnBtn = document.createElement('button');
            returnBtn.textContent = 'Return';
            returnBtn.style.cssText = `
                position: absolute;
                bottom: 40px;
                left: 50%;
                transform: translateX(-50%);
                padding: 8px 24px;
                font-size: 13px;
                font-weight: 500;
                background: transparent;
                color: var(--text-muted, #657786);
                border: 1px solid var(--border, #38444d);
                border-radius: 6px;
                cursor: pointer;
                opacity: 0;
                transition: all 0.3s ease;
            `;
            returnBtn.onmouseover = () => { returnBtn.style.borderColor = '#00d4aa'; returnBtn.style.color = '#00d4aa'; };
            returnBtn.onmouseout = () => { returnBtn.style.borderColor = '#38444d'; returnBtn.style.color = '#657786'; };

            overlay.appendChild(message);
            overlay.appendChild(returnBtn);
            document.body.appendChild(overlay);

            // Animate message in
            setTimeout(() => {
                message.style.opacity = '1';
                message.style.transform = 'scale(1)';
            }, 100);

            // Show return button after message appears
            setTimeout(() => {
                returnBtn.style.opacity = '1';
            }, 600);

            // Create confetti
            createConfetti(overlay);

            // Return button closes with smokey effect
            returnBtn.addEventListener('click', () => {
                message.style.transition = 'all 3s ease-out';
                message.style.opacity = '0';
                message.style.transform = 'scale(1.1) translateY(-40px)';
                message.style.filter = 'blur(25px)';
                message.style.letterSpacing = '8px';
                returnBtn.style.opacity = '0';
                setTimeout(() => {
                    overlay.style.opacity = '0';
                    overlay.style.transition = 'opacity 1s ease';
                    setTimeout(() => overlay.remove(), 1000);
                }, 2500);
            });
        }

        function createConfetti(container) {
            const colors = ['#00d4aa', '#f5a623', '#e0245e', '#17bf63', '#1da1f2', '#794bc4', '#ffad1f'];
            const confettiCount = 150;

            for (let i = 0; i < confettiCount; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    const color = colors[Math.floor(Math.random() * colors.length)];
                    const size = Math.random() * 10 + 5;
                    const startX = Math.random() * window.innerWidth;
                    const startY = -20;
                    const duration = Math.random() * 3 + 2;
                    const drift = (Math.random() - 0.5) * 200;
                    const rotation = Math.random() * 720;

                    confetti.style.cssText = `
                        position: absolute;
                        width: ${size}px;
                        height: ${size}px;
                        background: ${color};
                        left: ${startX}px;
                        top: ${startY}px;
                        border-radius: ${Math.random() > 0.5 ? '50%' : '2px'};
                        pointer-events: none;
                        animation: confettiFall ${duration}s ease-out forwards;
                        transform: rotate(${rotation}deg);
                        opacity: 1;
                    `;

                    // Add keyframe animation dynamically
                    confetti.animate([
                        {
                            transform: `translateY(0) translateX(0) rotate(0deg)`,
                            opacity: 1
                        },
                        {
                            transform: `translateY(${window.innerHeight + 50}px) translateX(${drift}px) rotate(${rotation}deg)`,
                            opacity: 0.7
                        }
                    ], {
                        duration: duration * 1000,
                        easing: 'cubic-bezier(0.25, 0.46, 0.45, 0.94)',
                        fill: 'forwards'
                    });

                    container.appendChild(confetti);

                    // Remove confetti after animation
                    setTimeout(() => confetti.remove(), duration * 1000);
                }, i * 20);
            }
        }

        // =====================
        // ADMIN MODE TOGGLE
        // =====================
        let adminModeActive = false;
        const ADMIN_PIN = '5253';

        function toggleAdminMode() {
            const adminTabs = document.querySelectorAll('.admin-tab');
            const adminControls = document.getElementById('adminControls');
            const togglePill = document.getElementById('adminTogglePill');
            const toggleBall = document.getElementById('adminToggleBall');

            // If turning ON, require password
            if (!adminModeActive) {
                const pin = prompt('Enter admin PIN:');
                if (pin !== ADMIN_PIN) {
                    if (pin !== null) alert('Incorrect PIN');
                    return;
                }
            }

            adminModeActive = !adminModeActive;

            if (adminModeActive) {
                // Show admin tabs
                adminTabs.forEach(tab => tab.style.display = 'inline-block');
                adminControls.style.display = 'block';

                // Animate pill to ON state
                togglePill.style.background = 'rgba(0, 212, 170, 0.3)';
                togglePill.style.borderColor = 'var(--accent)';
                toggleBall.style.background = '#00d4aa';
                toggleBall.style.left = '18px';

                // Update connection status
                updateAdminDaemonStatus();
            } else {
                // Hide admin tabs
                adminTabs.forEach(tab => tab.style.display = 'none');
                adminControls.style.display = 'none';

                // Animate pill to OFF state
                togglePill.style.background = 'var(--bg-card)';
                togglePill.style.borderColor = 'var(--border)';
                toggleBall.style.background = 'var(--text-muted)';
                toggleBall.style.left = '2px';

                // Switch back to summary tab if on an admin tab
                const currentTab = document.querySelector('.tab.active');
                if (currentTab && currentTab.classList.contains('admin-tab')) {
                    switchTab('summary');
                }
            }
        }

        async function updateAdminDaemonStatus() {
            const statusIndicator = document.getElementById('adminStatusIndicator');
            const statusText = document.getElementById('adminStatusText');
            if (!statusIndicator || !statusText) return;

            // Check Supabase connection status
            if (dataSource === 'supabase') {
                statusIndicator.style.background = '#17bf63';
                statusText.textContent = 'Connected to Supabase';
            } else if (dataSource === 'daemon') {
                statusIndicator.style.background = '#00d4aa';
                statusText.textContent = 'Connected to Daemon';
            } else {
                statusIndicator.style.background = '#f5a623';
                statusText.textContent = 'Offline (localStorage)';
            }
        }

        function showAdminToggle() {
            const toggleBtn = document.getElementById('adminToggleBtn');
            if (toggleBtn) {
                toggleBtn.style.display = 'flex';
            }
        }

        init();
    </script>
</body>
</html>
